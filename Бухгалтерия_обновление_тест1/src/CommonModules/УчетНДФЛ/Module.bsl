//УКРАИНА
Функция ДатаИзмененияСхемыУчетаВС() Экспорт
	
	Возврат Дата(2021, 1, 1);
	
КонецФункции
//УКРАИНА
Функция ЗаполнитьНДФЛ(ВременнаяСсылка, МенеджерВременныхТаблиц, Организация, МесяцНачисления, ПервыйМесяцНалоговогоПериода = Неопределено, ПоследнийМесяцНалоговогоПериода  = Неопределено, ПоВсемДокументам = Ложь) Экспорт
	
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("Организация",Организация);
	Запрос.УстановитьПараметр("ВременнаяСсылка",ВременнаяСсылка);
	
	ЭтоРасчетПоДоходамТекущегоМесяца = ПервыйМесяцНалоговогоПериода = Неопределено Или ПоследнийМесяцНалоговогоПериода = Неопределено;
	
	Если НЕ ЭтоРасчетПоДоходамТекущегоМесяца Тогда
		Запрос.УстановитьПараметр("НачалоПериода",ПервыйМесяцНалоговогоПериода);
		Запрос.УстановитьПараметр("КонецПериода",ПоследнийМесяцНалоговогоПериода);
	Иначе	
		Запрос.УстановитьПараметр("НачалоПериода",НачалоМесяца(МесяцНачисления));
		Запрос.УстановитьПараметр("КонецПериода",КонецМесяца(МесяцНачисления));
	Конецесли;
	Запрос.УстановитьПараметр("ПериодРегистрации",НачалоМесяца(МесяцНачисления));
	
	Запрос.Текст = 
	   "ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
		|	СведенияОДоходахНДФЛ.ФизическоеЛицо,
		|	СведенияОДоходахНДФЛ.КодДохода,
		|	СведенияОДоходахНДФЛ.НалоговыйПериод
		|ИЗ
		|	РегистрНакопления.СведенияОДоходахНДФЛ.Обороты(
		|			&НачалоПериода,
		|			&КонецПериода,
		|			МЕСЯЦ,
		|			Организация = &Организация
		|            И ФизическоеЛицо В (ВЫБРАТЬ ФизическиеЛица.ФизическоеЛицо ИЗ ВТФизическиеЛица КАК ФизическиеЛица)
		|			) КАК СведенияОДоходахНДФЛ
		|";
		
	Если НЕ ПоВсемДокументам И ВременнаяСсылка <> Неопределено Тогда
		ПоляСуммирования = Новый Массив;
		Если ТипЗнч(ВременнаяСсылка) = Тип("ДокументСсылка.РегистрацияПрочихДоходов") Или
			ТипЗнч(ВременнаяСсылка) = Тип("ДокументСсылка.ВыплатаБывшимСотрудникам") Тогда
			Запрос.Текст = ЗарплатаКадры.ДобавитьОтборПоРегистраторуРегистрНакопленияОбороты(Запрос.Текст, "ВременнаяСсылка", ПоляСуммирования);
		Иначе	
			Запрос.Текст = ЗарплатаКадры.ДобавитьОтборПоРегистраторуРегистрНакопленияОбороты(Запрос.Текст, ".Проведен", ПоляСуммирования, "ЕСТЬ NULL");
		КонецЕсли;
	КонецЕсли;
	
	НДФЛ = Запрос.Выполнить().Выгрузить();   
	Возврат НДФЛ;
	
КонецФункции

// Формирует запрос для получения льгот сотрудников
// Основная таблица ВТСтрокиРасчетаСДанными
// Возвращаемая таблица ВТЛьготыСотрудников
//
Процедура ПолучитьСписокЛьгот(Запрос, Организация, МесяцРасчета, ПрименятьЛьготы)
	
	Если НЕ ПрименятьЛьготы Тогда
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	СтрокиРасчета.ФизическоеЛицо,
		|	СтрокиРасчета.НалоговыйПериод,
		|	NULL КАК Льгота,
		|	0 КАК КоличествоЛьгот,
		|	0 КАК КоличествоПороговЛьгот,
		|   0 КАК ПорогЛьготНДФЛ,
		|   0 КАК СтавкаЛьготНДФЛ,
		|   0 КАК РазмерПрожиточныеМинимумы,
		|   0 КАК ДоходЛьготы
		|ПОМЕСТИТЬ ВТЛьготыСотрудников
		|ИЗ
		|	ВТСтрокиРасчетаСДанными КАК СтрокиРасчета
		|ГДЕ ЛОЖЬ
		|
		|";
		Запрос.Выполнить();
		Возврат;
		
	КонецЕсли;	
	
    СоздатьВТЛьготыПоНДФЛЗаПериод(Запрос.МенеджерВременныхТаблиц, Истина, МесяцРасчета, Организация, "ВТСтрокиРасчетаСДанными");

	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод,
	|	ЛьготыСотрудников.Льгота,
	|	ВЫРАЗИТЬ( 
	|		ВЫБОР КОГДА ВидыЛьготПоНДФЛ.СпособПримененияНДФЛ = ЗНАЧЕНИЕ(Перечисление.СпособыПримененияЛьготРаботников.Основной) 
	|			ТОГДА ВидыЛьготПоНДФЛ.РазмерНДФЛ 
	|			КОГДА ВидыЛьготПоНДФЛ.СпособПримененияНДФЛ = ЗНАЧЕНИЕ(Перечисление.СпособыПримененияЛьготРаботников.НаКаждогоРебенка) 
	|			ТОГДА ВидыЛьготПоНДФЛ.РазмерНДФЛ * ЛьготыСотрудников.Количество 
	|			КОГДА ВидыЛьготПоНДФЛ.СпособПримененияНДФЛ = ЗНАЧЕНИЕ(Перечисление.СпособыПримененияЛьготРаботников.НаКаждогоРебенкаИнвалида) 
	|			ТОГДА ВидыЛьготПоНДФЛ.РазмерНДФЛ * ЛьготыСотрудников.Количество 
	|			КОГДА ВидыЛьготПоНДФЛ.СпособПримененияНДФЛ = ЗНАЧЕНИЕ(Перечисление.СпособыПримененияЛьготРаботников.НаТроихДетей)
	|				И ЛьготыСотрудников.Количество >= 3
	|			ТОГДА ВидыЛьготПоНДФЛ.РазмерНДФЛ * ЛьготыСотрудников.Количество 
	|      		ИНАЧЕ 0
	|  		КОНЕЦ
	|	КАК ЧИСЛО(5,2) ) КАК КоличествоЛьгот,
	|	ВЫРАЗИТЬ( 
	|		ВЫБОР КОГДА ВидыЛьготПоНДФЛ.СпособПримененияНДФЛ = ЗНАЧЕНИЕ(Перечисление.СпособыПримененияЛьготРаботников.Основной) 
	|				ИЛИ ЛьготыСотрудников.Льгота = ЗНАЧЕНИЕ(Справочник.ВидыЛьготПоНДФЛ.НДФЛ_16912ВР)
	|			ТОГДА 1 
	|			КОГДА ВидыЛьготПоНДФЛ.СпособПримененияНДФЛ = ЗНАЧЕНИЕ(Перечисление.СпособыПримененияЛьготРаботников.НаКаждогоРебенка) 
	|			ТОГДА ЛьготыСотрудников.Количество 
	|			КОГДА ВидыЛьготПоНДФЛ.СпособПримененияНДФЛ = ЗНАЧЕНИЕ(Перечисление.СпособыПримененияЛьготРаботников.НаКаждогоРебенкаИнвалида) 
	|			ТОГДА ЛьготыСотрудников.Количество 
	|			КОГДА ВидыЛьготПоНДФЛ.СпособПримененияНДФЛ = ЗНАЧЕНИЕ(Перечисление.СпособыПримененияЛьготРаботников.НаТроихДетей)
	|				И ЛьготыСотрудников.Количество >= 3
	|			ТОГДА ЛьготыСотрудников.Количество 
	|      		ИНАЧЕ 1
	|  		КОНЕЦ
	|	КАК ЧИСЛО(5,2) ) КАК КоличествоПороговЛьгот
	|ПОМЕСТИТЬ ВТЛьготыСотрудниковКоличество
	|ИЗ
	|	ВТЛьготыПоНДФЛЗаПериод КАК ЛьготыСотрудников
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЛьготПоНДФЛ КАК ВидыЛьготПоНДФЛ
	|	ПО ЛьготыСотрудников.Льгота = ВидыЛьготПоНДФЛ.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод,
	|	ЗНАЧЕНИЕ(Справочник.ВидыЛьготПоНДФЛ.Гр16912_16913б) КАК Льгота,
	|	СУММА(ЛьготыСотрудников.КоличествоЛьгот) КАК КоличествоЛьгот,
	|	СУММА(ЛьготыСотрудников.КоличествоПороговЛьгот) КАК КоличествоПороговЛьгот
	|ПОМЕСТИТЬ ВТЛьготыСотрудниковРазрешенныеДубли
	|ИЗ
	|	ВТЛьготыСотрудниковКоличество КАК ЛьготыСотрудников
	|   ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|	ВТЛьготыСотрудниковКоличество КАК ЛьготыСотрудниковДубли
	|	ПО ЛьготыСотрудников.НалоговыйПериод = ЛьготыСотрудниковДубли.НалоговыйПериод
	|	 И ЛьготыСотрудников.ФизическоеЛицо = ЛьготыСотрудниковДубли.ФизическоеЛицо
	|	 И ((ЛьготыСотрудников.Льгота = ЗНАЧЕНИЕ(Справочник.ВидыЛьготПоНДФЛ.НДФЛ_16912)
	|	  И ЛьготыСотрудниковДубли.Льгота = ЗНАЧЕНИЕ(Справочник.ВидыЛьготПоНДФЛ.НДФЛ_16913б))
	|	  ИЛИ (ЛьготыСотрудников.Льгота = ЗНАЧЕНИЕ(Справочник.ВидыЛьготПоНДФЛ.НДФЛ_16913б)
	|	  И ЛьготыСотрудниковДубли.Льгота = ЗНАЧЕНИЕ(Справочник.ВидыЛьготПоНДФЛ.НДФЛ_16912)))
	|
	|СГРУППИРОВАТЬ ПО
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод,
	|	ЗНАЧЕНИЕ(Справочник.ВидыЛьготПоНДФЛ.Гр16912_16913б)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод,
	|	ЛьготыСотрудников.Льгота,
	|	ЛьготыСотрудников.КоличествоЛьгот,
	|	ЛьготыСотрудников.КоличествоПороговЛьгот
	|ПОМЕСТИТЬ ВТЛьготыСотрудниковКоличествоПолное
	|ИЗ
	|	ВТЛьготыСотрудниковКоличество КАК ЛьготыСотрудников
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод,
	|	ЛьготыСотрудников.Льгота,
	|	ЛьготыСотрудников.КоличествоЛьгот,
	|	ЛьготыСотрудников.КоличествоПороговЛьгот
	|ИЗ
	|	ВТЛьготыСотрудниковРазрешенныеДубли КАК ЛьготыСотрудников
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод,
	|	МАКСИМУМ(ЛьготыСотрудников.КоличествоЛьгот) КАК КоличествоЛьгот,
	|	МАКСИМУМ(ЛьготыСотрудников.КоличествоПороговЛьгот) КАК КоличествоПороговЛьгот
	|ПОМЕСТИТЬ ВТЛьготыСотрудниковМаксимум
	|ИЗ
	|	ВТЛьготыСотрудниковКоличествоПолное КАК ЛьготыСотрудников
	|СГРУППИРОВАТЬ ПО
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод,
	|	НАЧАЛОПЕРИОДА(ЛьготыСотрудников.НалоговыйПериод, ГОД) КАК НалоговыйПериодГод,
	|	МАКСИМУМ(ЛьготыСотрудников.Льгота) КАК Льгота,
	|	МАКСИМУМ(ЛьготыСотрудников.КоличествоЛьгот) КАК КоличествоЛьгот,
	|	МАКСИМУМ(ЛьготыСотрудников.КоличествоПороговЛьгот) КАК КоличествоПороговЛьгот
	|ПОМЕСТИТЬ ВТЛьготыСотрудниковДанные
	|ИЗ
	|	ВТЛьготыСотрудниковКоличествоПолное КАК ЛьготыСотрудников
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|	ВТЛьготыСотрудниковМаксимум КАК ЛьготыСотрудниковМаксимум
	|	ПО ЛьготыСотрудников.ФизическоеЛицо = ЛьготыСотрудниковМаксимум.ФизическоеЛицо
	|	 И ЛьготыСотрудников.НалоговыйПериод = ЛьготыСотрудниковМаксимум.НалоговыйПериод
	|	 И ЛьготыСотрудников.КоличествоЛьгот = ЛьготыСотрудниковМаксимум.КоличествоЛьгот
	|	 И ЛьготыСотрудников.КоличествоПороговЛьгот = ЛьготыСотрудниковМаксимум.КоличествоПороговЛьгот
	|СГРУППИРОВАТЬ ПО
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТЛьготыПоНДФЛЗаПериод
	|;
	|УНИЧТОЖИТЬ ВТЛьготыСотрудниковМаксимум
	|;
	|УНИЧТОЖИТЬ ВТЛьготыСотрудниковРазрешенныеДубли
	|;
	|УНИЧТОЖИТЬ ВТЛьготыСотрудниковКоличествоПолное
	|;
	|УНИЧТОЖИТЬ ВТЛьготыСотрудниковКоличество
	|";
	
	Запрос.Выполнить();
	

	ОтборыОТ = Новый Структура();
	ВыбираемыеПоляОТ = Новый Структура();
	ОтборыРС = Новый Структура();
	ОтборыРС.Вставить("Льгота","= ЗНАЧЕНИЕ(Справочник.ВидыЛьготПоНДФЛ.НДФЛ_16911)");
	ВыбираемыеПоляРС = Новый Структура();
	ВыбираемыеПоляРС.Вставить("Порог","Порог");
	ВыбираемыеПоляРС.Вставить("Ставка","Ставка");
	ВыбираемыеПоляРС.Вставить("Льгота","Льгота");
	ПоляСвязей = Новый Структура();
	
	Запрос.Текст = ЗарплатаКадры.ЗапросВТСрезПоследнихНаВсеДаты("ВТРазмерыЛьготНДФЛ", "ВТЛьготыСотрудниковДанные", ОтборыОТ, ВыбираемыеПоляОТ, "НалоговыйПериод", "РегистрСведений.РазмерыЛьготНДФЛ", ОтборыРС, ВыбираемыеПоляРС,"Период", ПоляСвязей, ЛОЖЬ, ЛОЖЬ, ЛОЖЬ);
	Запрос.Выполнить();
	
	ОтборыОТ = Новый Структура();
	ВыбираемыеПоляОТ = Новый Структура();
	ОтборыРС = Новый Структура();
	ОтборыРС.Вставить("СоциальнаяГруппа","= ЗНАЧЕНИЕ(Перечисление.СоциальныеГруппыНаселения.Трудоспособные)");
	ВыбираемыеПоляРС = Новый Структура();
	ВыбираемыеПоляРС.Вставить("Размер","Размер");
	ВыбираемыеПоляРС.Вставить("СоциальнаяГруппа","СоциальнаяГруппа");
	ПоляСвязей = Новый Структура();
	
	Запрос.Текст = ЗарплатаКадры.ЗапросВТСрезПоследнихНаВсеДаты("ВТПрожиточныеМинимумы", "ВТЛьготыСотрудниковДанные", ОтборыОТ, ВыбираемыеПоляОТ, "НалоговыйПериодГод", "РегистрСведений.ПрожиточныеМинимумы", ОтборыРС, ВыбираемыеПоляРС,"Период", ПоляСвязей, ЛОЖЬ, ЛОЖЬ, ЛОЖЬ);
	Запрос.Выполнить();
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СтрокиРасчета.ФизическоеЛицо,
	|	СтрокиРасчета.НалоговыйПериод,
	|	СУММА(СтрокиРасчета.Доход) КАК ОбщийДоход 
	|ПОМЕСТИТЬ ВТОбщийДоходПоЛьготам
	|ИЗ
	|	ВТСтрокиРасчетаСДанными КАК СтрокиРасчета
	|	
	|ГДЕ
	|   СтрокиРасчета.КодДохода.УчитыватьНСЛ
	|СГРУППИРОВАТЬ ПО
	|	СтрокиРасчета.ФизическоеЛицо,
	|	СтрокиРасчета.НалоговыйПериод
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЛьготыСотрудников.ФизическоеЛицо,
	|	ЛьготыСотрудников.НалоговыйПериод,
	|	ЛьготыСотрудников.Льгота,
	|	ЛьготыСотрудников.КоличествоЛьгот,
	|	ЛьготыСотрудников.КоличествоПороговЛьгот,
	|   ЕСТЬNULL(РазмерыЛьготНДФЛ.Порог, 0) КАК ПорогЛьготНДФЛ,
	|   ЕСТЬNULL(РазмерыЛьготНДФЛ.Ставка, 0) КАК СтавкаЛьготНДФЛ,
	|   ЕСТЬNULL(ПрожиточныеМинимумы.Размер, 0) КАК РазмерПрожиточныеМинимумы,
	|   ЕСТЬNULL(ОбщийДоходПоЛьготам.ОбщийДоход, 0) КАК ДоходЛьготы
	|ПОМЕСТИТЬ ВТЛьготыСотрудников
	|ИЗ
	|	ВТЛьготыСотрудниковДанные КАК ЛьготыСотрудников
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТРазмерыЛьготНДФЛ КАК РазмерыЛьготНДФЛ
	|	ПО ЛьготыСотрудников.НалоговыйПериод = РазмерыЛьготНДФЛ.НалоговыйПериод
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПрожиточныеМинимумы КАК ПрожиточныеМинимумы
	|	ПО ЛьготыСотрудников.НалоговыйПериодГод = ПрожиточныеМинимумы.НалоговыйПериодГод
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТОбщийДоходПоЛьготам КАК ОбщийДоходПоЛьготам
	|	ПО ЛьготыСотрудников.НалоговыйПериод = ОбщийДоходПоЛьготам.НалоговыйПериод
	|	 И ЛьготыСотрудников.ФизическоеЛицо = ОбщийДоходПоЛьготам.ФизическоеЛицо
	|ГДЕ
	|  ЛьготыСотрудников.НалоговыйПериод <= &МесяцНачисления	
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТРазмерыЛьготНДФЛ
	|;
	|УНИЧТОЖИТЬ ВТПрожиточныеМинимумы
	|;
	|УНИЧТОЖИТЬ ВТЛьготыСотрудниковДанные
	|;
	|УНИЧТОЖИТЬ ВТОбщийДоходПоЛьготам
	|
	|";

	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура СоздатьВТЛьготыПоНДФЛЗаПериод(МенеджерВременныхТаблиц, ТолькоРазрешенные, ДатаАктуальности, Организация, ИмяВременнойТаблицыОтбора = "ВТПериодыФизическихЛиц") Экспорт
	
	Запрос = Новый Запрос;
	
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.УстановитьПараметр("ДатаАктуальности",	ДатаАктуальности);
	Запрос.УстановитьПараметр("Организация",	Организация);
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПериодыФизическихЛиц.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ПериодыФизическихЛиц.НалоговыйПериод КАК МесяцПериода,
	|	ЛьготыФизическихЛицНДФЛ.Льгота,
	|	МАКСИМУМ(ЛьготыФизическихЛицНДФЛ.Период) КАК МесяцЛьготы
	|ПОМЕСТИТЬ ВТПериодыСрезаЛьгот
	|ИЗ
	|	ВТПериодыФизическихЛиц КАК ПериодыФизическихЛиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЛьготыФизическихЛицНДФЛ КАК ЛьготыФизическихЛицНДФЛ
	|		ПО ПериодыФизическихЛиц.ФизическоеЛицо = ЛьготыФизическихЛицНДФЛ.ФизическоеЛицо
	|			И ПериодыФизическихЛиц.НалоговыйПериод >= ЛьготыФизическихЛицНДФЛ.Период
	|			И ЛьготыФизическихЛицНДФЛ.Регистратор.Организация = &Организация
	|
	|СГРУППИРОВАТЬ ПО
	|	ПериодыФизическихЛиц.ФизическоеЛицо,
	|	ПериодыФизическихЛиц.НалоговыйПериод,
	|	ЛьготыФизическихЛицНДФЛ.Льгота
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПериодыФизическихЛиц.ФизическоеЛицо КАК ФизическоеЛицо,
	|	МАКСИМУМ(ЛьготыНаДетейНДФЛ.МесяцРегистрации) КАК МесяцРегистрации,
	|	ПериодыФизическихЛиц.НалоговыйПериод КАК МесяцПериода
	|ПОМЕСТИТЬ ВТМесяцаСрезаЛьготНаДетей
	|ИЗ
	|	ВТПериодыФизическихЛиц КАК ПериодыФизическихЛиц
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЛьготыНаДетейНДФЛ КАК ЛьготыНаДетейНДФЛ
	|		ПО ПериодыФизическихЛиц.ФизическоеЛицо = ЛьготыНаДетейНДФЛ.ФизическоеЛицо
	|			И ПериодыФизическихЛиц.НалоговыйПериод >= ЛьготыНаДетейНДФЛ.МесяцРегистрации
	|			И (ЛьготыНаДетейНДФЛ.МесяцРегистрации <= &ДатаАктуальности)
	|			И ЛьготыНаДетейНДФЛ.Регистратор.Организация = &Организация
	|
	|СГРУППИРОВАТЬ ПО
	|	ПериодыФизическихЛиц.ФизическоеЛицо,
	|	ПериодыФизическихЛиц.НалоговыйПериод
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ЛьготыНаДетейНДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ЛьготыНаДетейНДФЛ.Льгота КАК Льгота,
	|	ЛьготыНаДетейНДФЛ.МесяцРегистрации КАК МесяцРегистрации,
	|	МАКСИМУМ(ЛьготыНаДетейНДФЛ.ДатаДействия) КАК ДатаДействия,
	|	МесяцаСрезаЛьготНаДетей.МесяцПериода КАК МесяцПериода
	|ПОМЕСТИТЬ ВТДатыСрезаЛьготНаДетей
	|ИЗ
	|	ВТМесяцаСрезаЛьготНаДетей КАК МесяцаСрезаЛьготНаДетей
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЛьготыНаДетейНДФЛ КАК ЛьготыНаДетейНДФЛ
	|		ПО МесяцаСрезаЛьготНаДетей.ФизическоеЛицо = ЛьготыНаДетейНДФЛ.ФизическоеЛицо
	|			И МесяцаСрезаЛьготНаДетей.МесяцРегистрации = ЛьготыНаДетейНДФЛ.МесяцРегистрации
	|			И МесяцаСрезаЛьготНаДетей.МесяцПериода >= ЛьготыНаДетейНДФЛ.ДатаДействия
	|			И ЛьготыНаДетейНДФЛ.Регистратор.Организация = &Организация
	|
	|СГРУППИРОВАТЬ ПО
	|	ЛьготыНаДетейНДФЛ.ФизическоеЛицо,
	|	ЛьготыНаДетейНДФЛ.Льгота,
	|	ЛьготыНаДетейНДФЛ.МесяцРегистрации,
	|	МесяцаСрезаЛьготНаДетей.МесяцПериода
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	ПериодыСрезаЛьгот.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ПериодыСрезаЛьгот.МесяцПериода КАК НалоговыйПериод,
	|	ПериодыСрезаЛьгот.Льгота КАК Льгота,
	|	1 КАК Количество
	|ПОМЕСТИТЬ ВТЛьготыПоНДФЛЗаПериод
	|ИЗ
	|	ВТПериодыСрезаЛьгот КАК ПериодыСрезаЛьгот
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЛьготыФизическихЛицНДФЛ КАК ЛьготыФизическихЛицНДФЛ
	|		ПО ПериодыСрезаЛьгот.ФизическоеЛицо = ЛьготыФизическихЛицНДФЛ.ФизическоеЛицо
	|			И ПериодыСрезаЛьгот.МесяцЛьготы = ЛьготыФизическихЛицНДФЛ.Период
	|			И ПериодыСрезаЛьгот.Льгота = ЛьготыФизическихЛицНДФЛ.Льгота
	|			И ЛьготыФизическихЛицНДФЛ.Актуальность
	|			И ЛьготыФизическихЛицНДФЛ.Регистратор.Организация = &Организация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЛьготыНаДетейНДФЛ.ФизическоеЛицо,
	|	ДатыСрезаЛьготНаДетей.МесяцПериода,
	|	ЛьготыНаДетейНДФЛ.Льгота,
	|	ВЫБОР
	|		КОГДА ЛьготыНаДетейНДФЛ.ДействуетДо <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				И КОНЕЦПЕРИОДА(ЛьготыНаДетейНДФЛ.ДействуетДо, МЕСЯЦ) <= ДатыСрезаЛьготНаДетей.МесяцПериода
	|			ТОГДА ЛьготыНаДетейНДФЛ.КоличествоДетейПоОкончании
	|		ИНАЧЕ ЛьготыНаДетейНДФЛ.КоличествоДетей
	|	КОНЕЦ
	|ИЗ
	|	РегистрСведений.ЛьготыНаДетейНДФЛ КАК ЛьготыНаДетейНДФЛ
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВТДатыСрезаЛьготНаДетей КАК ДатыСрезаЛьготНаДетей
	|		ПО ЛьготыНаДетейНДФЛ.ФизическоеЛицо = ДатыСрезаЛьготНаДетей.ФизическоеЛицо
	|			И ЛьготыНаДетейНДФЛ.Льгота = ДатыСрезаЛьготНаДетей.Льгота
	|			И ЛьготыНаДетейНДФЛ.МесяцРегистрации = ДатыСрезаЛьготНаДетей.МесяцРегистрации
	|			И ЛьготыНаДетейНДФЛ.ДатаДействия = ДатыСрезаЛьготНаДетей.ДатаДействия
	|ГДЕ
	|	ВЫБОР
	|			КОГДА ЛьготыНаДетейНДФЛ.ДействуетДо <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|					И КОНЕЦПЕРИОДА(ЛьготыНаДетейНДФЛ.ДействуетДо, МЕСЯЦ) < ДатыСрезаЛьготНаДетей.МесяцПериода
	|				ТОГДА ЛьготыНаДетейНДФЛ.КоличествоДетейПоОкончании
	|			ИНАЧЕ ЛьготыНаДетейНДФЛ.КоличествоДетей
	|		КОНЕЦ > 0
	|	И ЛьготыНаДетейНДФЛ.Регистратор.Организация = &Организация
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТПериодыСрезаЛьгот
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТДатыСрезаЛьготНаДетей
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТМесяцаСрезаЛьготНаДетей";	
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВТПериодыФизическихЛиц", ИмяВременнойТаблицыОтбора);
	
	Если НЕ ТолькоРазрешенные Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "ВЫБРАТЬ РАЗРЕШЕННЫЕ", "ВЫБРАТЬ");
	КонецЕсли;	
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура СтрокаСведенийОДоходахВС(СведенияОДоходахНДФЛ, Организация, МесяцНачисления, ДанныеДокумента, ОкончательныйРасчет = Истина) Экспорт
	
	Если НачалоМесяца(МесяцНачисления) < ДатаИзмененияСхемыУчетаВС() И НЕ ЗначениеЗаполнено(ДанныеДокумента.КодДоходаВС) Тогда
		Возврат;
	ИначеЕсли НачалоМесяца(МесяцНачисления) >= ДатаИзмененияСхемыУчетаВС() И НЕ ЗначениеЗаполнено(ДанныеДокумента.КодДоходаВС2021) Тогда
		Возврат;	
	КонецЕсли;	
	
	НоваяСтрока = СведенияОДоходахНДФЛ.Добавить();
	ЗаполнитьЗначенияСвойств(НоваяСтрока, ДанныеДокумента);
	НоваяСтрока.ГоловнаяОрганизация = ЗарплатаКадрыПовтИсп.ГоловнаяОрганизация(Организация);
	НоваяСтрока.Организация = Организация;
	НоваяСтрока.Период = МесяцНачисления;
	НоваяСтрока.НалоговыйПериод = НачалоМесяца(МесяцНачисления);
	Если НачалоМесяца(МесяцНачисления) < ДатаИзмененияСхемыУчетаВС() Тогда
		НоваяСтрока.КодДохода = ДанныеДокумента.КодДоходаВС;
	Иначе
		НоваяСтрока.КодДохода = ДанныеДокумента.КодДоходаВС2021;
	КонецЕсли;	
	НоваяСтрока.НатуральныйКоэффициент = Ложь;
	НоваяСтрока.ДоходМежрасчетногоПериода = Не ОкончательныйРасчет;
	
КонецПроцедуры

Функция РазделитьТаблицуНаНДФЛиВС(ТаблицаДляРазделения) Экспорт
	
	ТаблицыНДФЛиВС = Новый Структура;
	
    Отбор = Новый Структура;
    Отбор.Вставить("ВидУдержания", Перечисления.ВидыОсобыхНачисленийИУдержаний.НДФЛ);
    ТаблицаНДФЛ = ТаблицаДляРазделения.Скопировать(Отбор);
	
	Отбор = Новый Структура;
    Отбор.Вставить("ВидУдержания", Перечисления.ВидыОсобыхНачисленийИУдержаний.ВоенныйСбор);
    ТаблицаВС = ТаблицаДляРазделения.Скопировать(Отбор);
	
	ТаблицыНДФЛиВС.Вставить("ТаблицаНДФЛ", ТаблицаНДФЛ);
	ТаблицыНДФЛиВС.Вставить("ТаблицаВС", ТаблицаВС);
	
	
	Возврат ТаблицыНДФЛиВС;
	
КонецФункции	

Функция СтрокаИсчисленныйНДФЛ(Движения, Организация, ДатаОперации, ДанныеДокумента)
	
	НоваяСтрока = Движения.ИсчисленныйНДФЛ.Добавить();
	ЗаполнитьЗначенияСвойств(НоваяСтрока, ДанныеДокумента);
	НоваяСтрока.Организация = Организация;
	НоваяСтрока.Период = ДатаОперации;

    Возврат НоваяСтрока
	
КонецФункции

Функция СтрокаИсчисленныйНДФЛАвансом(Движения, Организация, ДатаОперации, ДанныеДокумента)
	
	НоваяСтрока = Движения.ИсчисленныйНДФЛАвансом.Добавить();
	ЗаполнитьЗначенияСвойств(НоваяСтрока, ДанныеДокумента);
	НоваяСтрока.Организация = Организация;
	НоваяСтрока.Период = ДатаОперации;

    Возврат НоваяСтрока
	
КонецФункции

Функция РаспределитьНДФЛПоГруппамУчета(Организация, ПериодРегистрации, ТаблицаНДФЛ, ДанныеМежрасчетногоПериода = Ложь, Регистратор = Неопределено, ТаблицаДоходов = Неопределено) Экспорт
	
	МассивФизическихЛиц = ОбщегоНазначения.ВыгрузитьКолонку(ТаблицаНДФЛ, "ФизическоеЛицо", Истина);
	МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ФизическиеЛица", МассивФизическихЛиц);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ФизическиеЛица.Ссылка КАК ФизическоеЛицо
	|ПОМЕСТИТЬ ВТФизическиеЛицаНДФЛ
	|ИЗ
	|	Справочник.ФизическиеЛица КАК ФизическиеЛица
	|ГДЕ
	|	ФизическиеЛица.Ссылка В(&ФизическиеЛица)";
	Запрос.Выполнить();
	
	Доходы = СформироватьДоходыНДФЛ(Организация, ПериодРегистрации, МенеджерВременныхТаблиц, ДанныеМежрасчетногоПериода, Регистратор, ТаблицаДоходов);
	
	//Распределение таблицы НДФЛ по таблице начислений
	ПоляРазрез = Новый Массив();
	ПоляРазрез.Добавить("ГруппаУчетаНачислений");
	ПоляСвязи = Новый Структура();
	ПоляСвязи.Вставить("ФизическоеЛицо","ФизическоеЛицо");
	Если ТипЗнч(Регистратор) <> Тип("ДокументСсылка.НачислениеЗаПервуюПоловинуМесяца") Тогда 
		ПоляСвязи.Вставить("КодДохода","КодДохода");
		ПоляСвязи.Вставить("НалоговыйПериод","НалоговыйПериод");
	КонецЕсли;	
	ТаблицаНДФЛПоГруппам = ЗарплатаКадры.РаспределитьТаблицуПропорциональноТаблицеКоэффициентов(ТаблицаНДФЛ, "Сумма", Доходы, "СуммаДоход", ПоляРазрез, ПоляСвязи);
	
	//Что не удалось распределить - относим на 661
	Для Каждого СтрокаНДФЛ из ТаблицаНДФЛПоГруппам Цикл
		Если НЕ ЗначениеЗаполнено(СтрокаНДФЛ.ГруппаУчетаНачислений) Тогда
			СтрокаНДФЛ.ГруппаУчетаНачислений = Справочники.ГруппыУчетаНачисленийИУдержаний.Зарплата;
		КонецЕсли;	
	Конеццикла;	
	
	Возврат ТаблицаНДФЛПоГруппам;
	
КонецФункции

Функция СформироватьДоходыНДФЛ(Организация, ПериодРегистрации, МенеджерВременныхТаблиц, ДанныеМежрасчетногоПериода, Регистратор, ТаблицаДоходов)
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ПериодРегистрации", ПериодРегистрации);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("Регистратор", Регистратор);
	Запрос.УстановитьПараметр("ДанныеМежрасчетногоПериода", ДанныеМежрасчетногоПериода);
	
	Если ТипЗнч(Регистратор) <> Тип("ДокументСсылка.НачислениеЗаПервуюПоловинуМесяца") Тогда 
	
		Запрос.Текст = 
		   "ВЫБРАТЬ РАЗРЕШЕННЫЕ
		   |	СведенияОДоходахНДФЛ.Организация,
		   |	СведенияОДоходахНДФЛ.ФизическоеЛицо,
		   |	СведенияОДоходахНДФЛ.КодДохода,
		   |	СведенияОДоходахНДФЛ.НалоговыйПериод,
		   |	СведенияОДоходахНДФЛ.Сотрудник,
		   |	СведенияОДоходахНДФЛ.Начисление,
		   |	СведенияОДоходахНДФЛ.ГруппаУчетаНачислений,
		   |	СведенияОДоходахНДФЛ.СуммаДохода КАК СуммаДоход
		   |
		   |ИЗ
		   |	РегистрНакопления.СведенияОДоходахНДФЛ КАК  СведенияОДоходахНДФЛ
		   |ГДЕ
		   |	НАЧАЛОПЕРИОДА(СведенияОДоходахНДФЛ.Период, МЕСЯЦ) = &ПериодРегистрации
		   |	И СведенияОДоходахНДФЛ.Организация = &Организация
		   |	И СведенияОДоходахНДФЛ.ФизическоеЛицо В 
		   |					(ВЫБРАТЬ
		   |						СтрокиРасчета.ФизическоеЛицо
		   |					ИЗ
		   |						ВТФизическиеЛицаНДФЛ КАК СтрокиРасчета)
		   |   И ((&ДанныеМежрасчетногоПериода И СведенияОДоходахНДФЛ.ДоходМежрасчетногоПериода И СведенияОДоходахНДФЛ.Регистратор = &Регистратор)
		   |      ИЛИ (НЕ &ДанныеМежрасчетногоПериода И НЕ СведенияОДоходахНДФЛ.ДоходМежрасчетногоПериода))
		   |";
		
	Иначе

		Запрос.УстановитьПараметр("ТаблицаДоходов", ТаблицаДоходов);
		
		Запрос.Текст = 
		   "ВЫБРАТЬ
		   |	ТаблицаДоходов.ФизическоеЛицо,
		   |	ТаблицаДоходов.ГруппаУчетаНачислений,
		   |	ТаблицаДоходов.Сумма
		   |ПОМЕСТИТЬ ВТТаблицаДоходов
		   |
		   |ИЗ
		   |	&ТаблицаДоходов КАК ТаблицаДоходов
		   |;
		   |
		   |ВЫБРАТЬ
		   |	ТаблицаДоходов.ФизическоеЛицо,
		   |	ТаблицаДоходов.ГруппаУчетаНачислений,
		   |	ТаблицаДоходов.Сумма КАК СуммаДоход
		   |
		   |ИЗ
		   |	ВТТаблицаДоходов КАК ТаблицаДоходов
		   |";
		
	КонецЕсли;	
		
	Возврат Запрос.Выполнить().Выгрузить();   
	
КонецФункции	

Процедура СформироватьИсчисленныйНалогАвансомПоТаблицеЗначений(Движения, Отказ, Организация, ДатаОперации, ИсчисленныйНалог, Записывать = Ложь, ОкончательныйРасчет = Ложь) Экспорт
	
	
	Если ИсчисленныйНалог = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	Если ИсчисленныйНалог.Колонки.Найти("Сумма") <> Неопределено И ИсчисленныйНалог.Колонки.Найти("Налог") = Неопределено Тогда
		ИсчисленныйНалог.Колонки.Сумма.Имя = "Налог";
	КонецЕсли;	
	
	ИспользоватьУчетОбособленныхПодразделенийДляНДФЛ = ПолучитьФункциональнуюОпцию("ИспользоватьУчетОбособленныхПодразделенийДляНДФЛ", Новый Структура("Организация", Организация));
	Если ИспользоватьУчетОбособленныхПодразделенийДляНДФЛ Тогда
		Если Истина Тогда
			//Относим на основные места работы
			ФизическиеЛицаМассив = ИсчисленныйНалог.ВыгрузитьКолонку("ФизическоеЛицо");
			СотрудникиФизическиеЛица = КадровыйУчет.ОсновныеСотрудникиФизическихЛиц(ФизическиеЛицаМассив, Истина, Организация, НачалоДня(ДатаОперации)-1);
			Сотрудники = ОбщегоНазначения.ВыгрузитьКолонку(СотрудникиФизическиеЛица, "Сотрудник", Истина);
			
			// По основным сотрудникам запрашиваем сведения о рабочих местах на конец месяца.
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
			КадровыйУчет.СоздатьНаДатуВТКадровыеДанныеСотрудников(Запрос.МенеджерВременныхТаблиц, Истина, Сотрудники, "Подразделение", КонецМесяца(ДатаОперации));
			Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			| КадровыеДанныеСотрудников.ФизическоеЛицо,
			| КадровыеДанныеСотрудников.Сотрудник,
			| КадровыеДанныеСотрудников.Подразделение
			|ИЗ
			| ВТКадровыеДанныеСотрудников КАК КадровыеДанныеСотрудников";
			
			ТаблицаМестРаботы = Запрос.Выполнить().Выгрузить();
			
		Иначе	
		КонецЕсли;	
		
		СоответствиеОбособленныеПодразделенияИФизическиеЛица = ПолучитьОбособленныеПодразделенияДляНДФЛ(ТаблицаМестРаботы, ДатаОперации);
		
	Иначе
		Если Истина Тогда
			//Относим на основные места работы
			ФизическиеЛицаМассив = ИсчисленныйНалог.ВыгрузитьКолонку("ФизическоеЛицо");
			СотрудникиФизическиеЛица = КадровыйУчет.ОсновныеСотрудникиФизическихЛиц(ФизическиеЛицаМассив, Истина, Организация, НачалоДня(ДатаОперации)-1);
			Сотрудники = ОбщегоНазначения.ВыгрузитьКолонку(СотрудникиФизическиеЛица, "Сотрудник", Истина);
			
			// По основным сотрудникам запрашиваем сведения о рабочих местах на конец месяца.
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
			КадровыйУчет.СоздатьНаДатуВТКадровыеДанныеСотрудников(Запрос.МенеджерВременныхТаблиц, Истина, Сотрудники, "Подразделение", КонецМесяца(ДатаОперации));
			Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			| КадровыеДанныеСотрудников.ФизическоеЛицо,
			| КадровыеДанныеСотрудников.Сотрудник,
			| КадровыеДанныеСотрудников.Подразделение
			|ИЗ
			| ВТКадровыеДанныеСотрудников КАК КадровыеДанныеСотрудников";
			
			ТаблицаМестРаботы = Запрос.Выполнить().Выгрузить();
			
		Иначе	
		КонецЕсли;		
		СоответствиеОбособленныеПодразделенияИФизическиеЛица = Новый Соответствие; 
		
	КонецЕсли;	
	
	
	ЕстьНовыеСтроки = Ложь;
	Для Каждого СтрокаДанных Из ИсчисленныйНалог Цикл
		Если СтрокаДанных.Налог = 0 и СтрокаДанных.Доход = 0 Тогда
			Продолжить;
		КонецЕсли;
		ЕстьНовыеСтроки = Истина;
		НоваяСтрокаИС = СтрокаИсчисленныйНДФЛАвансом(Движения, Организация, ДатаОперации, СтрокаДанных);
		НоваяСтрокаИС.ОбособленноеПодразделение = СоответствиеОбособленныеПодразделенияИФизическиеЛица.Получить(СтрокаДанных.ФизическоеЛицо);
	КонецЦикла;
	
	Если ЕстьНовыеСтроки Тогда
		Если Записывать Тогда
			Движения.ИсчисленныйНДФЛАвансом.Записать();
			Движения.ИсчисленныйНДФЛАвансом.Записывать = Ложь;
		Иначе
			Движения.ИсчисленныйНДФЛАвансом.Записывать = Истина;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

Процедура СформироватьДоходыНДФЛПоКодамДоходовИзТаблицыЗначенийПолной(Движения, Отказ, Организация, ДатаОперации, Начисления, Записывать = Ложь, ОкончательныйРасчет = Истина) Экспорт
	
	Если Начисления.Количество() = 0 Тогда // данных не оказалось
		Возврат	
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ДатаОперации", ДатаОперации);
	Запрос.УстановитьПараметр("КонецМесяцаНачисления", КонецМесяца(ДатаОперации));
	Запрос.УстановитьПараметр("Начисления", Начисления);
	
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Начисления.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Начисления.СуммаДохода КАК СуммаДохода,
	|	Начисления.НалоговыйПериод КАК НалоговыйПериод,
	|	Начисления.ГруппаУчетаНачислений КАК ГруппаУчетаНачислений,
	|	Начисления.КодДохода КАК КодДохода,
	|	Начисления.НатуральныйКоэффициент КАК НатуральныйКоэффициент
	|ПОМЕСТИТЬ ВТНачисления
	|ИЗ
	|	&Начисления КАК Начисления
	|;
	|
	|ВЫБРАТЬ
	|	Начисления.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Начисления.КодДохода КАК КодДохода,
	|	&ДатаОперации КАК ДатаПолученияДохода,
	|	Начисления.СуммаДохода,
	|	ВидыДоходовНДФЛ.ОблагаетсяВоеннымСбором КАК КодДоходаВС,
	|	ВидыДоходовНДФЛ.ОблагаетсяВоеннымСбором2021 КАК КодДоходаВС2021,
	|	Начисления.ГруппаУчетаНачислений КАК ГруппаУчетаНачислений,
	|	Начисления.НалоговыйПериод КАК НалоговыйПериод,
	|	Начисления.НатуральныйКоэффициент КАК НатуральныйКоэффициент
	|ИЗ
	|	ВТНачисления КАК Начисления
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыДоходовНДФЛ КАК ВидыДоходовНДФЛ
	|		ПО Начисления.КодДохода = ВидыДоходовНДФЛ.Ссылка
	|ГДЕ
	|	Начисления.СуммаДохода <> 0
	|	И Начисления.КодДохода <> ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.ПустаяСсылка)";
	Результат = Запрос.Выполнить();
	
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = СтрокаСведенийОДоходах(Движения.СведенияОДоходахНДФЛ, Организация, НачалоМесяца(ДатаОперации), Выборка, ОкончательныйРасчет);
	КонецЦикла;
	
	Если Записывать Тогда
		// Записываем сразу и не выставляем признак Записывать этому набору записей движений документа.
		Движения.СведенияОДоходахНДФЛ.Записать();
		Движения.СведенияОДоходахНДФЛ.Записывать = Ложь;
	Иначе
		Движения.СведенияОДоходахНДФЛ.Записывать = Истина;
	КонецЕсли;
	
КонецПроцедуры

Функция ПолучитьОбособленныеПодразделенияДляНДФЛ(ТаблицаМестРаботы, ДатаАктуальности = Неопределено) Экспорт
	
	Если Не ЗначениеЗаполнено(ДатаАктуальности) Тогда
		ДатаАктуальности = '00010101'
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаАктуальности", ДатаАктуальности);
	Запрос.УстановитьПараметр("ТаблицаМестРаботы", ТаблицаМестРаботы);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТаблицаМестРаботы.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ТаблицаМестРаботы.Подразделение КАК СтруктурнаяЕдиница
	|ПОМЕСТИТЬ ВТТаблицаМестРаботы
	|ИЗ
	|	&ТаблицаМестРаботы КАК ТаблицаМестРаботы
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ РАЗРЕШЕННЫЕ
	|	ТаблицаМестРаботы.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ОбособленныеПодразделенияДляНДФЛ.ОбособленноеПодразделение
	|ИЗ
	|	ВТТаблицаМестРаботы КАК ТаблицаМестРаботы
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОбособленныеПодразделенияДляНДФЛ.СрезПоследних(&ДатаАктуальности, ) КАК ОбособленныеПодразделенияДляНДФЛ
	|		ПО (ОбособленныеПодразделенияДляНДФЛ.СтруктурнаяЕдиница = ТаблицаМестРаботы.СтруктурнаяЕдиница)";
	
	СоответствиеОбособленноеПодразделение = Новый Соответствие;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		СоответствиеОбособленноеПодразделение.Вставить(Выборка.ФизическоеЛицо, Выборка.ОбособленноеПодразделение);		
	КонецЦикла;	
	Возврат СоответствиеОбособленноеПодразделение;
КонецФункции

Функция ПолучитьСтавкиНДФЛНаДату(Дата) Экспорт
	
	Ставки = Новый Соответствие();
	Ставки.Вставить(Перечисления.ВидыСтавокНДФЛ.ПустаяСсылка(), 0);

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Дата", Дата);
	
	Запрос.Текст = "ВЫБРАТЬ
	               |	ВидыСтавокНДФЛ.Ссылка КАК ВидСтавки,
	               |	ЕСТЬNULL(СтавкиНДФЛСрезПоследних.Ставка, 0) КАК Ставка
	               |ИЗ
	               |	Перечисление.ВидыСтавокНДФЛ КАК ВидыСтавокНДФЛ
	               |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтавкиНДФЛ.СрезПоследних(&Дата, ) КАК СтавкиНДФЛСрезПоследних
	               |		ПО ВидыСтавокНДФЛ.Ссылка = СтавкиНДФЛСрезПоследних.ВидСтавки";
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл 
		Ставки.Вставить(Выборка.ВидСтавки, Выборка.Ставка);
	КонецЦикла;
	
	Возврат Ставки;
	
КонецФункции	



#Область ПрограммныйИнтерфейс

// Формирует движения по регистрам подсистемы.
// Параметры:
//		РеквизитыПлатежа - таблица значений с колонками.
//				Организация - СправочникСсылка.Организации - должно быть непустым значением.
//				МесяцНалоговогоПериода - дата - должно быть непустым значением.
//				ДатаПлатежа - дата - должно быть непустым значением.
//				ПлатежноеПоручениеНомер - строка (необязательно).
//				ПлатежноеПоручениеДата - дата (необязательно).
//              РегистрацияВНалоговомОргане - СправочникСсылка.РегистрацииВНалоговомОргане  (необязательно)
//              ГлавныйБухгалтер - СправочникСсылка.ФизическиеЛица (необязательно)
//              Бухгалтер - СправочникСсылка.ФизическиеЛица (необязательно)
//
//  Возвращаемое значение: табличный документ.
//
Функция РеестрПеречисленныхСуммНалога(РеквизитыПлатежа) Экспорт 

	
КонецФункции


// Процедура переопределяет свойства объекта, с которыми он будет отображен в форме Отчетность.
// Параметры:
//  СвойстваОбъектов  - ТаблицаЗначений - (см. РегламентированнаяОтчетностьПереопределяемый.ОпределитьСвойстваОбъектовДляОтображенииВФормеОтчетность)
Процедура ОпределитьСвойстваОбъектовДляОтображенииВФормеОтчетность(СвойстваОбъектов) Экспорт
	
КонецПроцедуры

// Определяет свойства, касающиеся общих свойств объектов конфигураций-потребителей для отображения в форме Отчетность
// и возможности создания новый объектов из формы Отчетность.
//
// Параметры:
//  ТаблицаОписания  - ТаблицаЗначений -  (см. РегламентированнаяОтчетностьПереопределяемый.ОпределитьТаблицуОписанияОбъектовРегламентированнойОтчетности)
//	
Процедура ОпределитьТаблицуОписанияОбъектовРегламентированнойОтчетности(ТаблицаОписания) Экспорт

КонецПроцедуры

#КонецОбласти

#Область СлужебныйПрограммныйИнтерфейс

// Формирует движения по регистрам подсистемы.
//      	 
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - булево - 
//		Организация -
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение.
//		Начисления - ТаблицаЗначений - таблица значений с колонками:
//			* ФизическоеЛицо - СправочникСсылка - должно быть непустым.
//			* Подразделение - ОпределяемыйТип.ТерриторииВыполненияРаботВОрганизации -
//  	    * ДатаПолученияДохода - дата - должно быть непустым.
//			* КодДохода -
//			* СуммаДохода -
//			* КодВычета - 
//  	    * СуммаВычета -
//			* Сотрудник - необязательная, может отсутствовать.
//  	    * Начисление - необязательная, может отсутствовать.
//  	    * ВключатьВДекларациюПоНалогуНаПрибыль - необязательная, может отсутствовать.
//		Записывать - булево - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//		ОкончательныйРасчет - булево - признак того, надо ли помечать движения как предназначенные для межрасчетного
//		                               исчисления налога.
//
Процедура СформироватьДоходыНДФЛПоКодамДоходовИзТаблицыЗначений(Движения, Отказ, Организация, ДатаОперации, Начисления, Записывать = Ложь, ОкончательныйРасчет = Истина) Экспорт
	
	
	Если Начисления.Количество() = 0 Тогда // данных не оказалось
		Возврат	
	КонецЕсли;
	
	Если Начисления.Колонки.Найти("НатуральныйКоэффициент") = Неопределено Тогда
		Начисления.Колонки.Добавить("НатуральныйКоэффициент", Новый ОписаниеТипов("Булево"));
	КонецЕсли;	
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ДатаОперации", ДатаОперации);
	Запрос.УстановитьПараметр("КонецМесяцаНачисления", КонецМесяца(ДатаОперации));
	Запрос.УстановитьПараметр("Начисления", Начисления);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Начисления.Сотрудник КАК Сотрудник,
	|	Начисления.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Начисления.СуммаДохода КАК СуммаДохода,
	|	Начисления.Начисление КАК Начисление,
	|	Начисления.КодДохода КАК КодДохода,
	|	Начисления.Подразделение КАК Подразделение,
	|	Начисления.ПодразделениеСотрудника КАК ПодразделениеСотрудника,
	|	Начисления.НатуральныйКоэффициент КАК НатуральныйКоэффициент
	|ПОМЕСТИТЬ ВТНачисления
	|ИЗ
	|	&Начисления КАК Начисления
	|;
	|
	|ВЫБРАТЬ
	|	Начисления.Сотрудник КАК Сотрудник,
	|	Начисления.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Начисления.Начисление КАК Начисление,
	|	Начисления.КодДохода КАК КодДохода,
	|	Начисления.Подразделение КАК Подразделение,
	|	Начисления.ПодразделениеСотрудника КАК ПодразделениеСотрудника,
	|	Начисления.НатуральныйКоэффициент КАК НатуральныйКоэффициент,
	|	СУММА(Начисления.СуммаДохода) КАК СуммаДохода
	|ПОМЕСТИТЬ ВТНачисленияИтоги
	|ИЗ
	|	ВТНачисления КАК Начисления
	|СГРУППИРОВАТЬ ПО
	|	Начисления.Сотрудник,
	|	Начисления.ФизическоеЛицо,
	|	Начисления.Начисление,
	|	Начисления.КодДохода,
	|	Начисления.Подразделение,
	|	Начисления.ПодразделениеСотрудника,
	|	Начисления.НатуральныйКоэффициент
	|;
	|
	|ВЫБРАТЬ
	|	Начисления.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Начисления.КодДохода КАК КодДохода,
	|	&ДатаОперации КАК ДатаПолученияДохода,
	|	Начисления.СуммаДохода,
	|	Начисления.Подразделение,
	|	Начисления.ПодразделениеСотрудника,
	|	Начисления.Сотрудник,
	|	Начисления.Начисление,
	|	ВидыДоходовНДФЛ.ОблагаетсяВоеннымСбором КАК КодДоходаВС,
	|	ВидыДоходовНДФЛ.ОблагаетсяВоеннымСбором2021 КАК КодДоходаВС2021,
	|	ЕСТЬNULL(НастройкаОсобыхНачислений.ГруппаУчета, ЕСТЬNULL(ВидыПрочихДоходовФизическихЛиц.ГруппаУчета, ЗНАЧЕНИЕ(Справочник.ГруппыУчетаНачисленийИУдержаний.Зарплата))) КАК ГруппаУчетаНачислений,
	|	НАЧАЛОПЕРИОДА(&ДатаОперации, МЕСЯЦ) КАК ПериодДействия,
	|	ЗНАЧЕНИЕ(Перечисление.КатегорииНачисленийИНеоплаченногоВремени.Прочее) КАК КатегорияНачисления,
	|	Начисления.НатуральныйКоэффициент КАК НатуральныйКоэффициент
	|ИЗ
	|	ВТНачисленияИтоги КАК Начисления
	|	ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкаГруппУчетаОсобыхНачисленийИУдержаний КАК НастройкаОсобыхНачислений
	|		ПО Начисления.Начисление = НастройкаОсобыхНачислений.НачислениеУдержание
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыПрочихДоходовФизическихЛиц КАК ВидыПрочихДоходовФизическихЛиц
	|		ПО Начисления.Начисление = ВидыПрочихДоходовФизическихЛиц.Ссылка
	|	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыДоходовНДФЛ КАК ВидыДоходовНДФЛ
	|		ПО Начисления.КодДохода = ВидыДоходовНДФЛ.Ссылка
	|ГДЕ
	|	Начисления.СуммаДохода <> 0
	|	И Начисления.КодДохода <> ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.ПустаяСсылка)";
	Результат = Запрос.Выполнить();
	
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = СтрокаСведенийОДоходах(Движения.СведенияОДоходахНДФЛ, Организация, НачалоМесяца(ДатаОперации), Выборка, ОкончательныйРасчет);
	КонецЦикла;
	
	Если Записывать Тогда
		// Записываем сразу и не выставляем признак Записывать этому набору записей движений документа.
		Движения.СведенияОДоходахНДФЛ.Записать();
		Движения.СведенияОДоходахНДФЛ.Записывать = Ложь;
	Иначе
		Движения.СведенияОДоходахНДФЛ.Записывать = Истина;
	КонецЕсли;
	
	Если ТипЗнч(Движения.СведенияОДоходахНДФЛ.Отбор.Регистратор.Значение) = Тип("ДокументСсылка.ПризПодарок") Тогда
		УчетНДФЛРасширенный.УчестьПеределыДоходов(Движения, Отказ, Организация, НачалоМесяца(ДатаОперации), Движения.СведенияОДоходахНДФЛ.Отбор.Регистратор.Значение, Записывать);	
	КонецЕсли;	
	
КонецПроцедуры

// Формирует движения по регистрам подсистемы.
//      	 
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ
//		Организация
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение
//		МесяцНачисления
//		МенеджерВременныхТаблиц, содержит вр. таблицу 
//			ВТНачисления с полями.
//				Сотрудник, тип СправочникСсылка.Сотрудники.
//				Начисление, тип ПланВидовРасчетаСсылка.Начисления
//				СуммаДохода
//				СуммаВычетаНДФЛ
//				КодВычетаНДФЛ.
//				Подразделение, тип ОпределяемыйТип.ТерриторииВыполненияРаботВОрганизации.
//		Записывать - булево - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//		ОкончательныйРасчет - булево - признак того, надо ли помечать движения как предназначенные для межрасчетного
//		                               исчисления налога.
//		ИмяВТНачисления - строка - имя вр. таблицы начислений, по умолчанию "ВТНачисления".
//
Процедура СформироватьДоходыНДФЛПоНачислениям(Движения, Отказ, Организация, ДатаОперации, ДатаВыплаты, МенеджерВременныхТаблиц, МесяцНачисления = Неопределено, Записывать = Ложь, ОкончательныйРасчет = Истина, ИмяВТНачисления = "ВТНачисления") Экспорт
	

	Если Не ЗначениеЗаполнено(МесяцНачисления) Тогда
		МесяцНачисления = ДатаОперации
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ДатаВыплаты", ДатаВыплаты);
	Запрос.УстановитьПараметр("ДатаОперации", ДатаОперации);
	Запрос.УстановитьПараметр("КонецМесяцаНачисления", КонецМесяца(МесяцНачисления));
	
	ТекстЗапроса =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Сотрудники.Сотрудник КАК Сотрудник,
	|	&КонецМесяцаНачисления КАК Период
	|ПОМЕСТИТЬ ВТПериодыСотрудников
	|ИЗ
	|	#ИмяВТНачисления КАК Сотрудники
	|ГДЕ
	|	Сотрудники.Начисление ССЫЛКА ПланВидовРасчета.Начисления";
	Запрос.Текст = СтрЗаменить(ТекстЗапроса, "#ИмяВТНачисления", ИмяВТНачисления);
	Запрос.Выполнить();
	
	ОписательВременныхТаблиц = КадровыйУчет.ОписательВременныхТаблицДляСоздатьВТКадровыеДанныеСотрудников(МенеджерВременныхТаблиц, "ВТПериодыСотрудников");
	КадровыйУчет.СоздатьВТКадровыеДанныеСотрудников(ОписательВременныхТаблиц, Ложь, "ДатаУвольнения");
	
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Начисления.Сотрудник.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ЕСТЬNULL(ВидыРасчета.КодДоходаНДФЛ, Начисления.Начисление) КАК КодДохода,
	|	ВЫБОР
	|		КОГДА НЕ Начисления.Начисление ССЫЛКА ПланВидовРасчета.Начисления
	|			ТОГДА &ДатаВыплаты
	|		КОГДА ВидыРасчета.КодДоходаНДФЛ.СоответствуетОплатеТруда
	|			ТОГДА ВЫБОР
	|					КОГДА ЕСТЬNULL(ДанныеОСотруднике.ДатаУвольнения, &КонецМесяцаНачисления) < &КонецМесяцаНачисления
	|							И КОНЕЦПЕРИОДА(ЕСТЬNULL(ДанныеОСотруднике.ДатаУвольнения, &КонецМесяцаНачисления), МЕСЯЦ) = &КонецМесяцаНачисления
	|						ТОГДА ЕСТЬNULL(ДанныеОСотруднике.ДатаУвольнения, &КонецМесяцаНачисления)
	|					ИНАЧЕ &КонецМесяцаНачисления
	|				КОНЕЦ
	|		ИНАЧЕ &ДатаВыплаты
	|	КОНЕЦ КАК ДатаПолученияДохода,
	|	Начисления.СуммаДохода,
	|	Начисления.Подразделение,
	|	Начисления.ПодразделениеОрганизации КАК ПодразделениеСотрудника,
	|	Начисления.Сотрудник,
	|	Начисления.Начисление,
	|	ВЫБОР 
	|		КОГДА НЕ Начисления.Начисление ССЫЛКА ПланВидовРасчета.Начисления
	|       	ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.ПустаяСсылка)
	|       КОГДА ЕСТЬNULL(СтавкиВС.Ставка, 0) = 0
	|           ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.ПустаяСсылка)
	|		ИНАЧЕ ВидыРасчета.КодДоходаНДФЛ.ОблагаетсяВоеннымСбором
	|	КОНЕЦ КАК КодДоходаВС,
	|	ВЫБОР 
	|		КОГДА НЕ Начисления.Начисление ССЫЛКА ПланВидовРасчета.Начисления
	|       	ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.ПустаяСсылка)
	|       КОГДА ЕСТЬNULL(СтавкиВС.Ставка, 0) = 0
	|           ТОГДА ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.ПустаяСсылка)
	|		ИНАЧЕ ВидыРасчета.КодДоходаНДФЛ.ОблагаетсяВоеннымСбором2021
	|	КОНЕЦ КАК КодДоходаВС2021,
	|	ЕСТЬNULL(ВидыРасчета.ГруппаУчета, ЕСТЬNULL(НастройкаОсобыхНачислений.ГруппаУчета, ЗНАЧЕНИЕ(Справочник.ГруппыУчетаНачисленийИУдержаний.Зарплата))) КАК ГруппаУчетаНачислений,
	|	НАЧАЛОПЕРИОДА(Начисления.ДатаНачала, МЕСЯЦ) КАК ПериодДействия,
	|	ЕСТЬNULL(ВидыРасчета.КатегорияНачисленияИлиНеоплаченногоВремени, ЗНАЧЕНИЕ(Перечисление.КатегорииНачисленийИНеоплаченногоВремени.ПовременнаяОплатаТруда)) КАК КатегорияНачисления,
	|	ЕСТЬNULL(ВидыРасчета.ЯвляетсяДоходомВНатуральнойФорме, ЛОЖЬ) КАК НатуральныйКоэффициент
	|ИЗ
	|	#ИмяВТНачисления КАК Начисления
	|		ЛЕВОЕ СОЕДИНЕНИЕ ПланВидовРасчета.Начисления КАК ВидыРасчета
	|		ПО Начисления.Начисление = ВидыРасчета.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТКадровыеДанныеСотрудников КАК ДанныеОСотруднике
	|		ПО Начисления.Сотрудник = ДанныеОСотруднике.Сотрудник
    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НастройкаГруппУчетаОсобыхНачисленийИУдержаний КАК НастройкаОсобыхНачислений
	|		ПО Начисления.Начисление = НастройкаОсобыхНачислений.НачислениеУдержание
    |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СтавкиНДФЛ.СрезПоследних(&КонецМесяцаНачисления) КАК СтавкиВС
	|		ПО СтавкиВС.ВидСтавки = ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ВоенныйСбор)
	|ГДЕ
	|	Начисления.СуммаДохода <> 0
	|	И ЕСТЬNULL(ВидыРасчета.КодДоходаНДФЛ, Начисления.Начисление) <> ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.ПустаяСсылка)";
	Запрос.Текст = СтрЗаменить(ТекстЗапроса, "#ИмяВТНачисления", ИмяВТНачисления);
	Результат = Запрос.Выполнить();
	
	Выборка = Результат.Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = СтрокаСведенийОДоходах(Движения.СведенияОДоходахНДФЛ, Организация, МесяцНачисления, Выборка, ОкончательныйРасчет);
	КонецЦикла;
	
	Запрос.Текст = 
	"УНИЧТОЖИТЬ ВТПериодыСотрудников
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТКадровыеДанныеСотрудников";
	Запрос.Выполнить();
	
	Если Записывать Тогда
		// Записываем сразу и не выставляем признак Записывать этому набору записей движений документа.
		Движения.СведенияОДоходахНДФЛ.Записать();
		Движения.СведенияОДоходахНДФЛ.Записывать = Ложь;
	Иначе
		Движения.СведенияОДоходахНДФЛ.Записывать = Истина;
	КонецЕсли;
	
КонецПроцедуры


// Формирует движения по регистрам подсистемы.
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - булево - признак отказа от заполнения движений.
//		Организация
//		ИсчисленныйНалог
//			- МенеджерВременныхТаблиц, который содержит вр. таблицу ВТНДФЛИсчисленный с полями
//				ФизическоеЛицо: должно быть непустым
//  	       	СтавкаНалогообложенияРезидента: должно быть непустым
//				МесяцНалоговогоПериода: должно быть непустым.
//				Подразделение: тип ОпределяемыйТип.ТерриторииВыполненияРаботВОрганизации.
//				Сумма
//				ВключатьВДекларациюПоНалогуНаПрибыль: булево (необязательное)
//		Записывать - булево - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//		ОкончательныйРасчет - булево - признак того, надо ли помечать движения как предназначенные для межрасчетного
//		                               исчисления налога.
//
Процедура СформироватьИсчисленныйНалогПоВременнойТаблице(Движения, Отказ, Организация, ДатаОперации, ИсчисленныйНалог, Записывать = Ложь, ОкончательныйРасчет = Истина) Экспорт
	
	Если ИсчисленныйНалог = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ДатаОперации",ДатаОперации);
	Запрос.МенеджерВременныхТаблиц = ИсчисленныйНалог;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 * ИЗ ВТНДФЛИсчисленный КАК Налоги";
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат
	КонецЕсли;
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	Налоги.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Налоги.НалоговыйПериод КАК НалоговыйПериод,
	|	Налоги.Налог КАК Налог,
	|	Налоги.Доход КАК Доход,
	|	Налоги.ВидСтавки КАК ВидСтавки,
	|	Налоги.УвеличеннаяСтавка КАК УвеличеннаяСтавка,
	|	Налоги.Льгота КАК Льгота,
	|	Налоги.КоличествоЛьгот КАК КоличествоЛьгот,
	|	Налоги.СуммаЛьготы КАК СуммаЛьготы,
	|	Налоги.КодДохода КАК КодДохода,
	|	Налоги.ДоходПолный КАК ДоходПолный,
	|   ВЫБОР
	|   	КОГДА НЕ (ВидыДоходов.Ссылка ЕСТЬ NULL)
	|   	ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыУчетаНачисленийИУдержаний.ВоенныйСбор)
	|   	ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыУчетаНачисленийИУдержаний.НДФЛ)
	|   КОНЕЦ КАК ГруппаУчетаУдержаний
	|ИЗ
	|	ВТНДФЛИсчисленный КАК Налоги
	|   ЛЕВОЕ СОЕДИНЕНИЕ
	|   Справочник.ВидыДоходовНДФЛ КАК ВидыДоходов
	|   ПО ВидыДоходов.Ссылка = Налоги.КодДохода
	|    И ВидыДоходов.ВидСтавкиРезидента = ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ВоенныйСбор)
	|ГДЕ
	|	Налоги.Налог <> 0 ИЛИ Налоги.Доход <> 0 ";
	
	Запрос.Текст = ТекстЗапроса;
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = СтрокаРасчетовНалогоплательщикаСБюджетом(Движения, Организация, ДатаОперации, ВидДвиженияНакопления.Приход, Выборка, , ОкончательныйРасчет);
		НоваяСтрокаИС = СтрокаИсчисленныйНДФЛ(Движения, Организация, ДатаОперации, Выборка);
	КонецЦикла;
	
	Если Записывать Тогда
		Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записать();
		Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Ложь;
	Иначе
		Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Истина;
	КонецЕсли;
	
	Если Записывать Тогда
		Движения.ИсчисленныйНДФЛ.Записать();
		Движения.ИсчисленныйНДФЛ.Записывать = Ложь;
	Иначе
		Движения.ИсчисленныйНДФЛ.Записывать = Истина;
	КонецЕсли;
	
КонецПроцедуры

// Формирует движения по регистрам подсистемы.
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - булево - признак отказа от заполнения движений.
//		Организация
//		ИсчисленныйНалог 
//			- таблица значений с колонками
//				ФизическоеЛицо: должно быть непустым
//  	       	СтавкаНалогообложенияРезидента: должно быть непустым
//				МесяцНалоговогоПериода: должно быть непустым
//				Подразделение: тип ОпределяемыйТип.ТерриторииВыполненияРаботВОрганизации
//				Сумма
//				ВключатьВДекларациюПоНалогуНаПрибыль - необязательная колонка 
//      СоответствиеПодразделенийИРегистраций - необязательный параметр, содержит предварительно построенное
//                                              соответствие подразделений и их регистраций в налоговом органе
//      РегистрацияВНалоговомОргане - необязательный параметр
//      	эти параметры имеет смысл передавать для уменьшения количества запросов данных в том случае, 
//              когда данные о налогах передаются в виде таблицы значений 
//          если параметры не указаны - регистрация в налоговом органе будет вычислена самой процедурой.
//		Записывать - булево - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//		ОкончательныйРасчет - булево - признак того, надо ли помечать движения как предназначенные для межрасчетного
//		                               исчисления налога.
//
Процедура СформироватьИсчисленныйНалогПоТаблицеЗначений(Движения, Отказ, Организация, ДатаОперации, ИсчисленныйНалог, СоответствиеПодразделенийИРегистраций = Неопределено, РегистрацияВНалоговомОргане = Неопределено, Записывать = Ложь, ОкончательныйРасчет = Истина) Экспорт
	
	Если ИсчисленныйНалог = Неопределено Тогда
		Возврат
	КонецЕсли;
	ИспользоватьУчетОбособленныхПодразделенийДляНДФЛ = ПолучитьФункциональнуюОпцию("ИспользоватьУчетОбособленныхПодразделенийДляНДФЛ", Новый Структура("Организация", Организация));
	Если ИспользоватьУчетОбособленныхПодразделенийДляНДФЛ Тогда
		Если Истина Тогда
			//Относим на основные места работы
			ФизическиеЛицаМассив = ИсчисленныйНалог.ВыгрузитьКолонку("ФизическоеЛицо");
			СотрудникиФизическиеЛица = КадровыйУчет.ОсновныеСотрудникиФизическихЛиц(ФизическиеЛицаМассив, Истина, Организация, НачалоДня(ДатаОперации)-1);
			Сотрудники = ОбщегоНазначения.ВыгрузитьКолонку(СотрудникиФизическиеЛица, "Сотрудник", Истина);
			
			// По основным сотрудникам запрашиваем сведения о рабочих местах на конец месяца.
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
			КадровыйУчет.СоздатьНаДатуВТКадровыеДанныеСотрудников(Запрос.МенеджерВременныхТаблиц, Истина, Сотрудники, "Подразделение", КонецМесяца(ДатаОперации));
			Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			| КадровыеДанныеСотрудников.ФизическоеЛицо,
			| КадровыеДанныеСотрудников.Сотрудник,
			| КадровыеДанныеСотрудников.Подразделение
			|ИЗ
			| ВТКадровыеДанныеСотрудников КАК КадровыеДанныеСотрудников";
			
			ТаблицаМестРаботы = Запрос.Выполнить().Выгрузить();
			
		Иначе	
		КонецЕсли;	
		
		СоответствиеОбособленныеПодразделенияИФизическиеЛица = ПолучитьОбособленныеПодразделенияДляНДФЛ(ТаблицаМестРаботы, ДатаОперации);
		
	Иначе
		Если Истина Тогда
			//Относим на основные места работы
			ФизическиеЛицаМассив = ИсчисленныйНалог.ВыгрузитьКолонку("ФизическоеЛицо");
			СотрудникиФизическиеЛица = КадровыйУчет.ОсновныеСотрудникиФизическихЛиц(ФизическиеЛицаМассив, Истина, Организация, НачалоДня(ДатаОперации)-1);
			Сотрудники = ОбщегоНазначения.ВыгрузитьКолонку(СотрудникиФизическиеЛица, "Сотрудник", Истина);
			
			// По основным сотрудникам запрашиваем сведения о рабочих местах на конец месяца.
			Запрос = Новый Запрос;
			Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
			КадровыйУчет.СоздатьНаДатуВТКадровыеДанныеСотрудников(Запрос.МенеджерВременныхТаблиц, Истина, Сотрудники, "Подразделение", КонецМесяца(ДатаОперации));
			Запрос.Текст = 
			"ВЫБРАТЬ РАЗРЕШЕННЫЕ
			| КадровыеДанныеСотрудников.ФизическоеЛицо,
			| КадровыеДанныеСотрудников.Сотрудник,
			| КадровыеДанныеСотрудников.Подразделение
			|ИЗ
			| ВТКадровыеДанныеСотрудников КАК КадровыеДанныеСотрудников";
			
			ТаблицаМестРаботы = Запрос.Выполнить().Выгрузить();
			
		Иначе	
		КонецЕсли;		
		СоответствиеОбособленныеПодразделенияИФизическиеЛица = Новый Соответствие; 
		
	КонецЕсли;	

	ЕстьНовыеСтроки = Ложь;
	Для Каждого СтрокаДанных Из ИсчисленныйНалог Цикл
		Если СтрокаДанных.Налог = 0 и СтрокаДанных.Доход = 0 Тогда
			Продолжить;
		КонецЕсли;
		ЕстьНовыеСтроки = Истина;
		НоваяСтрока = СтрокаРасчетовНалогоплательщикаСБюджетом(Движения, Организация, ДатаОперации, ВидДвиженияНакопления.Приход, СтрокаДанных, , ОкончательныйРасчет);
		НоваяСтрокаИС = СтрокаИсчисленныйНДФЛ(Движения, Организация, ДатаОперации, СтрокаДанных);
		НоваяСтрока.ОбособленноеПодразделение = СоответствиеОбособленныеПодразделенияИФизическиеЛица.Получить(СтрокаДанных.ФизическоеЛицо);
		СтрокаРабочееМесто = ТаблицаМестРаботы.Найти(СтрокаДанных.ФизическоеЛицо,"ФизическоеЛицо");
		Если СтрокаРабочееМесто <> Неопределено Тогда 
			НоваяСтрокаИС.Подразделение	= СтрокаРабочееМесто.Подразделение;
		КонецЕсли;
	КонецЦикла;
	
	Если ЕстьНовыеСтроки Тогда
		Если Записывать Тогда
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записать();
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Ложь;
		Иначе
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Истина;
		КонецЕсли;
		
		Если Записывать Тогда
			Движения.ИсчисленныйНДФЛ.Записать();
			Движения.ИсчисленныйНДФЛ.Записывать = Ложь;
		Иначе
			Движения.ИсчисленныйНДФЛ.Записывать = Истина;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Формирует движения по регистрам подсистемы.
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - признак отказа от заполнения движений.
//		Организация
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение.
//		УдержанныйНалог - Таблица значений с колонками
//				ФизическоеЛицо: должно быть непустым
//  	       	СтавкаНалогообложенияРезидента: должно быть непустым.
//  	       	Ставка: должно быть непустым
//				МесяцНалоговогоПериода: должно быть непустым.
//				Подразделение: тип ОпределяемыйТип.ТерриторииВыполненияРаботВОрганизации
//				КодДохода
//				Сумма
//				РегистрацияВНалоговомОргане - необязательная колонка, если ее нет, то регистрация будет вычисляться.
//				РасчетМежрасчетногоПериода - необязательная колонка 
//				ВключатьВДекларациюПоНалогуНаПрибыль - необязательная колонка 
//				ДокументОснование: тип ОпределяемыйТип.ДокументыОснованияНДФЛ - необязательная колонка  
//				СрокПеречисления: тип ПеречислениеСсылка.СрокиПеречисляемогоНалога (необязательное).
//				СуммаВыплаченногоДохода (необязательное)
//		РегистрацияВНалоговомОргане - необязательный, если не задан, то будет вычисляться по подразделениям и организации.
//		Записывать - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//
Процедура СформироватьУдержанныйНалогПоТаблицеЗначений(Движения, Отказ, Организация, ДатаОперации, УдержанныйНалог, РегистрацияВНалоговомОргане = Неопределено, Записывать = Ложь) Экспорт
	
	Если УдержанныйНалог = Неопределено Или УдержанныйНалог.Количество() = 0 Тогда
		Возврат
	КонецЕсли;
	
	КолонкиУдержанногоНалога = УдержанныйНалог.Колонки;
	ВычислятьСрокПеречисления = КолонкиУдержанногоНалога.Найти("ДокументОснование") <> Неопределено И КолонкиУдержанногоНалога.Найти("СрокПеречисления") = Неопределено;
	БольничныеОтпуска = ?(ВычислятьСрокПеречисления, РасчетЗарплаты.ОснованиеИсчисленияНалогаСОтсроченнойУплатой(УдержанныйНалог.ВыгрузитьКолонку("ДокументОснование")), Новый Соответствие);
	
	ЕстьНовыеСтроки = Ложь;
	Для Каждого СтрокаДанных Из УдержанныйНалог Цикл
		
		Если СтрокаДанных.Сумма = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		ЕстьНовыеСтроки = Истина;
		НоваяСтрокаРасчетовНалогоплательщика = СтрокаРасчетовНалогоплательщикаСБюджетом(Движения, Организация, ДатаОперации, ВидДвиженияНакопления.Расход, СтрокаДанных, Перечисления.ВариантыУдержанияНДФЛ.Удержано);
		
	КонецЦикла;
	
	Если ЕстьНовыеСтроки Тогда
		Если Записывать Тогда
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записать();
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Ложь;
		Иначе
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Истина;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Формирует движения по регистрам подсистемы.
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - признак отказа от заполнения движений.
//		Организация
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение.
//		УдержанныйНалог - МенеджерВременныхТаблиц, который содержит вр. таблицу ВТНалогУдержанный с полями
//				ФизическоеЛицо: должно быть непустым
//  	       	СтавкаНалогообложенияРезидента: должно быть непустым.
//  	       	Ставка
//				МесяцНалоговогоПериода: должно быть непустым.
//				Подразделение: тип ОпределяемыйТип.ТерриторииВыполненияРаботВОрганизации.
//				Сумма
//				РегистрацияВНалоговомОргане, тип СправочникСсылка.РегистрацииВНалоговомОргане (необязательное)
//				ДокументОснование (необязательное)
//				ВключатьВДекларациюПоНалогуНаПрибыль (необязательное)
//				СрокПеречисления: тип ПеречислениеСсылка.СрокиПеречисляемогоНалога (необязательное).
//				СуммаВыплаченногоДохода (необязательное)
//		РегистрацияВНалоговомОргане - необязательный, если не задан, то будет вычисляться по подразделениям и организации.
//		Записывать - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//
Процедура СформироватьУдержанныйНалогПоВременнойТаблице(Движения, Отказ, Организация, ДатаОперации, УдержанныйНалог, РегистрацияВНалоговомОргане = Неопределено, Записывать = Ложь) Экспорт
	
	Если УдержанныйНалог = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ДатаОперации",ДатаОперации);
	Запрос.МенеджерВременныхТаблиц = УдержанныйНалог;
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 * ИЗ ВТНалогУдержанный КАК Налоги";
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат
	КонецЕсли;
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	Налоги.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Налоги.КодДохода,
	|	Налоги.ОбособленноеПодразделение,
	|   Налоги.Налог,
	|   Налоги.Доход,
	|   Налоги.ПериодВзаиморасчетов,
	|   Налоги.НалоговыйПериод,
	|   ВЫБОР
	|   	КОГДА НЕ (ВидыДоходов.Ссылка ЕСТЬ NULL)
	|   	ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыУчетаНачисленийИУдержаний.ВоенныйСбор)
	|   	ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыУчетаНачисленийИУдержаний.НДФЛ)
	|   КОНЕЦ КАК ГруппаУчетаУдержаний
	|ИЗ
	|	ВТНалогУдержанный КАК Налоги
	|   ЛЕВОЕ СОЕДИНЕНИЕ
	|   Справочник.ВидыДоходовНДФЛ КАК ВидыДоходов
	|   ПО ВидыДоходов.Ссылка = Налоги.КодДохода
	|    И ВидыДоходов.ВидСтавкиРезидента = ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ВоенныйСбор)
	|ГДЕ
	|	Налоги.Налог <> 0 ИЛИ Налоги.Налог <> 0";
	
	Запрос.Текст = ТекстЗапроса;
	
	Результаты = Запрос.Выполнить().Выгрузить();
	
	
	Для каждого СтрокаТЗ Из Результаты Цикл
	
		НоваяСтрокаРасчетовНалогоплательщика = СтрокаРасчетовНалогоплательщикаСБюджетом(Движения, Организация, ДатаОперации, ВидДвиженияНакопления.Приход, СтрокаТЗ);
		
	КонецЦикла;
	
	Если Записывать Тогда
		Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записать();
		Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Ложь;
	Иначе
		Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Истина;
	КонецЕсли;
	
КонецПроцедуры


// Формирует движения по регистрам подсистемы.
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - булево - признак отказа от заполнения движений.
//		Организация
//		НалогиПереданныеВНалоговыйОрган - таблица значений с колонками
//				ФизическоеЛицо: должно быть непустым
//  	       	СтавкаНалогообложенияРезидента: должно быть непустым.
//  	       	Ставка: должно быть непустым
//				МесяцНалоговогоПериода: должно быть непустым.
//				Подразделение: тип ОпределяемыйТип.ТерриторииВыполненияРаботВОрганизации.
//				Сумма
//		Записывать - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//
Процедура СформироватьНалогиПереданныеВНалоговыйОрган(Движения, Отказ, Организация, ДатаОперации, НалогиПереданныеВНалоговыйОрган, Записывать = Ложь) Экспорт
	
	Если НалогиПереданныеВНалоговыйОрган = Неопределено Тогда
		Возврат
	КонецЕсли;
	ЕстьНовыеСтроки = Ложь;
	Для Каждого СтрокаДанных Из НалогиПереданныеВНалоговыйОрган Цикл
		Если СтрокаДанных.Сумма = 0 Тогда
			Продолжить;
		КонецЕсли;
		ЕстьНовыеСтроки = Истина;
		СтрокаРасчетовНалогоплательщикаСБюджетом(Движения, Организация, ДатаОперации, ВидДвиженияНакопления.Расход, СтрокаДанных, Перечисления.ВариантыУдержанияНДФЛ.ПереданоНаВзысканиеВНалоговыйОрган);
	КонецЦикла;
	
	Если ЕстьНовыеСтроки Тогда
		Если Записывать Тогда
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записать();
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Ложь;
		Иначе
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Истина;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

// Формирует движения по регистрам подсистемы.
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - булево - признак отказа от заполнения движений.
//		Организация
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение
//		МесяцНачисления
//			- МенеджерВременныхТаблиц, который содержит вр. таблицу ВТУдержания с полями
//				ФизическоеЛицо: должно быть непустым.
//				Удержание - тип ПланВидовРасчетаСсылка.Удержания.
//				Сумма
//		Записывать - булево - булево - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//		ОкончательныйРасчет - булево - признак того, надо ли помечать движения как предназначенные для межрасчетного
//		                               исчисления налога.
//
Процедура СформироватьСоциальныеВычетыПоВременнойТаблице(Регистратор, Движения,  Отказ, Организация, ДатаОперации, МесяцНачисления, МенеджерВременныхТаблиц, Записывать = Ложь, ОкончательныйРасчет = Истина) Экспорт 

КонецПроцедуры

// Формирует движения по регистрам подсистемы.
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - булево - признак отказа от заполнения движений.
//		Организация
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение
//		МесяцНачисления.
//		Удержания - таблица значений с колонками
//				ФизическоеЛицо: должно быть непустым.
//				КатегорияУдержания - тип ПеречислениеСсылка.КатегорииУдержаний.
//				Удержание - тип ПланВидовРасчетаСсылка.Удержания.
//				Сумма
//		Записывать - булево - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//		ОкончательныйРасчет - булево - признак того, надо ли помечать движения как предназначенные для межрасчетного
//		                               исчисления налога.
//
Процедура СформироватьСоциальныеВычетыПоУдержаниям(Регистратор, Движения, Отказ, Организация, ДатаОперации, МесяцНачисления, Удержания, Записывать = Ложь, ОкончательныйРасчет = Истина) Экспорт 

	Если Удержания.Количество() = 0 Тогда // данных не оказалось
		Возврат	
	КонецЕсли;
	
	СтруктураПоиска = Новый Структура("КатегорияУдержания");
	СтруктураПоиска.КатегорияУдержания = Перечисления.КатегорииУдержаний.ДобровольныеВзносыВНПФ;
	Вычеты = Удержания.Скопировать(СтруктураПоиска);
	СтруктураПоиска.КатегорияУдержания = Перечисления.КатегорииУдержаний.ДСВ;
	ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(Удержания.Скопировать(СтруктураПоиска), Вычеты);

	Если Вычеты.Количество() = 0 Тогда
		Возврат	
	КонецЕсли;
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Удержания", Вычеты);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Удержания.ФизическоеЛицо КАК ФизическоеЛицо,
	|	Удержания.Удержание КАК Удержание,
	|	Удержания.Сумма КАК Сумма
	|ПОМЕСТИТЬ ВТУдержания
	|ИЗ
	|	&Удержания КАК Удержания
	|";
	Запрос.Выполнить();
	
	СформироватьСоциальныеВычетыПоВременнойТаблице(Регистратор, Движения, Отказ, Организация, ДатаОперации, МесяцНачисления, Запрос.МенеджерВременныхТаблиц, Записывать, ОкончательныйРасчет);
	
КонецПроцедуры

// Формирует движения по регистрам подсистемы.
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - булево - признак отказа от заполнения движений.
//		Организация
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение.
//		ДанныеДокумента - Таблица значений с колонками
//			ФизическоеЛицо: должно быть непустым
//         	МесяцНалоговогоПериода: должно быть непустым.
//			Подразделение, тип ОпределяемыйТип.ТерриторииВыполненияРаботВОрганизации
//			необязательные колонки с суммами налогов и вычетов:
//          	НалогПоСтавке13, НалогПоСтавке09, НалогПоСтавке35
//          	ЗачтеноАвансовыхПлатежейПоСтавке13, ЗачтеноАвансовыхПлатежейПоСтавке09, ЗачтеноАвансовыхПлатежейПоСтавке35
//              ПримененныйВычетЛичный
//              ПримененныйВычетНаДетей, ПримененныйВычетНаДетейДвойной, ПримененныйВычетНаДетейДвойнойВторой 
//              ПримененныйВычетНаВторогоРебенка, ПримененныйВычетНаВторогоРебенкаДвойной, ПримененныйВычетНаВторогоРебенкаДвойнойВторой
//              ПримененныйВычетНаТретьегоРебенкаДвойной, ПримененныйВычетНаТретьегоРебенкаДвойной, ПримененныйВычетНаТретьегоРебенкаДвойнойВторой
//              ПримененныйВычетНаДетейИнвалидов, ПримененныйВычетНаДетейИнвалидовДвойной, ПримененныйВычетНаДетейИнвалидовДвойнойВторой
//				ПримененныйВычетНаДетейИнвалидовОпекунов,ПримененныйВычетНаДетейИнвалидовДвойнойОпекунов,ПримененныйВычетНаДетейИнвалидовДвойнойВторойОпекунов
//				ПримененныйВычетРасходыНаСвоеОбучение,ПримененныйВычетРасходыНаОбучениеДетей,ПримененныйВычетРасходыНаЛечение,ПримененныйВычетСтраховыеВзносыНаМедУслуги,ПримененныйВычетРасходыНаДорогостоящееЛечение
//              ПримененныйВычетИмущественныйРасходы, ПримененныйВычетИмущественныйПроцентыПоКредитам, ПримененныйВычетИмущественныйПроцентыПриПерекредитовании
//		Записывать - булево - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//		ОкончательныйРасчет - булево - признак того, надо ли помечать движения как предназначенные для межрасчетного
//		                               исчисления налога.
//
Процедура СформироватьНалогиВычеты(Движения, Отказ, Организация, ДатаОперации, ДанныеДокумента, Записывать = Ложь, ОкончательныйРасчет = Истина) Экспорт
	
	
	Если ДанныеДокумента = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	КолонкиДанных = ДанныеДокумента.Колонки;
	
	СтрокИсчисленногоНалога = Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Количество();

	   СформироватьИсчисленныйНалогПоТаблицеЗначений(Движения, Отказ, Организация, ДатаОперации, ДанныеДокумента, , , Ложь, ОкончательныйРасчет);

	Если СтрокИсчисленногоНалога < Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Количество() Тогда
		Если Записывать Тогда
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записать();
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Ложь;
		Иначе
			Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать = Истина;
		КонецЕсли;
		
		Если Записывать Тогда
			Движения.ИсчисленныйНДФЛ.Записать();
			Движения.ИсчисленныйНДФЛ.Записывать = Ложь;
		Иначе
			Движения.ИсчисленныйНДФЛ.Записывать = Истина;
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

// Формирует движения по регистрам подсистемы.
// Параметры:
//		Движения - коллекция движений регистратора.
//		Отказ - признак отказа от заполнения движений.
//		ДанныеДокумента - Таблица значений с колонками
//			МесяцРегистрации
//			ФизическоеЛицо
//			ГоловнаяОрганизация
//			ИзменитьЛьготыНаДетей
//			ЛьготыНаДетей: таблица значений, соответствующая по структуре регистру СтандартныеВычетыНаДетейНДФЛ
//			ИзменитьЛичнуюЛьготу
//			ЛичныеЛьготы: таблица значений, соответствующая по структуре регистру ЛьготыФизическихЛицНДФЛ
//		Записывать - Булево - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//		ЗаполнятьОснование - Булево - признак того, следует ли заполнять реквизит "Основание" для вычетов
//
Процедура СформироватьПрименениеЛьгот(Движения,
	Отказ, ДанныеДокумента, Записывать = Ложь, ЗаполнятьОснование = Истина) Экспорт
	
	Если ДанныеДокумента = Неопределено Тогда
		Возврат
	КонецЕсли;
	
	Если ДанныеДокумента.ИзменитьЛьготыНаДетей Тогда
		Для Каждого ЛьготаНаДетей Из ДанныеДокумента.ЛьготыНаДетей Цикл
			ЗаполнитьЗначенияСвойств(Движения.ЛьготыНаДетейНДФЛ.Добавить(), ЛьготаНаДетей);
		КонецЦикла;
		Если Записывать Тогда
			Движения.ЛьготыНаДетейНДФЛ.Записать();
			Движения.ЛьготыНаДетейНДФЛ.Записывать = Ложь;
		Иначе
			Движения.ЛьготыНаДетейНДФЛ.Записывать = Истина;
		КонецЕсли;
	КонецЕсли;
	
	Если ДанныеДокумента.ИзменитьЛичнуюЛьготу Тогда
		Для Каждого ЛичнаяЛьгота Из ДанныеДокумента.ЛичныеЛьготы Цикл
			ЗаполнитьЗначенияСвойств(Движения.ЛьготыФизическихЛицНДФЛ.Добавить(), ЛичнаяЛьгота);
		КонецЦикла;
		Если Записывать Тогда
			Движения.ЛьготыФизическихЛицНДФЛ.Записать();
			Движения.ЛьготыФизическихЛицНДФЛ.Записывать = Ложь;
		Иначе
			Движения.ЛьготыФизическихЛицНДФЛ.Записывать = Истина;
		КонецЕсли;
	КонецЕсли;
	
	
КонецПроцедуры

// Формирует таблицу расчетной базы НДФЛ за указанный месяц.
// Параметры:
//		Организация
//		МесяцРасчета
//      ФизическиеЛицаМассив - содержит список людей по которым выполняется распределение НДФЛ.
//		РегистраторОграниченияБазы - документ, движениями которого ограничивается получаемая база для распределения.
//
//  Возвращаемое значение:
//  	таблица значений с колонками
//
Функция ПолучитьБазуРасчетаНДФЛ(Организация, МесяцРасчета, ФизическиеЛицаМассив, РегистраторОграниченияБазы = НеОпределено) Экспорт 

	
	Запрос = Новый Запрос();
	Запрос.УстановитьПараметр("ГоловнаяОрганизация", ЗарплатаКадрыПовтИсп.ГоловнаяОрганизация(Организация));
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("НачалоМесяца", НачалоМесяца(МесяцРасчета));
    Запрос.УстановитьПараметр("КонецМесяца", КонецМесяца(МесяцРасчета));
	Запрос.УстановитьПараметр("ФизическиеЛица", ФизическиеЛицаМассив);

	Запрос.Текст = 
    "ВЫБРАТЬ
    |	СведенияОДоходах.ФизическоеЛицо КАК ФизическоеЛицо,
    |	СУММА(СведенияОДоходах.СуммаДохода) КАК Сумма,
    |	СведенияОДоходах.Сотрудник КАК Сотрудник,
	|	СведенияОДоходах.КодДохода КАК КодДохода,
    |	СведенияОДоходах.ПодразделениеСотрудника КАК Подразделение
    |ИЗ
    |	РегистрНакопления.СведенияОДоходахНДФЛ КАК СведенияОДоходах
    |ГДЕ
    |	СведенияОДоходах.ГоловнаяОрганизация = &ГоловнаяОрганизация
    |	И СведенияОДоходах.Сотрудник <> ЗНАЧЕНИЕ(Справочник.Сотрудники.ПустаяСсылка)
    |	И СведенияОДоходах.Организация = &Организация
    |	И СведенияОДоходах.Период МЕЖДУ &НачалоМесяца И &КонецМесяца
    |	И СведенияОДоходах.ФизическоеЛицо В(&ФизическиеЛица)
    |
    |СГРУППИРОВАТЬ ПО
    |	СведенияОДоходах.ФизическоеЛицо,
    |	СведенияОДоходах.Сотрудник,
	|	СведенияОДоходах.КодДохода,
    |	СведенияОДоходах.ПодразделениеСотрудника";

	// Если базу расчета НДФЛ получаем в пределах движений регистратора (т.е. распределение НДФЛ межрасчетного документа).
	Если РегистраторОграниченияБазы <> НеОпределено Тогда
		Запрос.УстановитьПараметр("РегистраторОграниченияБазы", РегистраторОграниченияБазы);
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "НЕ СведенияОДоходах.ДоходМежрасчетногоПериода", "Регистратор = &РегистраторОграниченияБазы");
	КонецЕсли;
	
	Возврат Запрос.Выполнить().Выгрузить();
	
КонецФункции


// Предназначена для расчета НДФЛ по записанным в учете данным.
// Параметры:
//      Регистратор - ДокументСсылка - регистратор для которого выполняется расчет НДФЛ.
//		Организация - СправочникСсылка.Организации -
//		МесяцРасчета - дата -
//      МенеджерВременныхТаблиц - МенеджерВременныхТаблиц - содержит вр. таблицу со списком людей, по которым выполняется 
//								расчет НДФЛ
//      	ВТФизическиеЛица 
//				ФизическоеЛицо
//		ПервыйМесяцНалоговогоПериода - дата -
//		ПоследнийМесяцНалоговогоПериода - дата -
//		ИсключатьДоходыРегистратора - булево - 
//		ОкончательныйРасчет - булево - признак того, надо ли при расчете учитывать все зарегистрированные доходы
//		                               (соответствует значению Истина).
//		ДатаУдержанияИсчисленногоНалога - дата - дата предполагаемого удержания налога, который был исчислен по
//		                                         Регистратору.
//
//  Возвращаемое значение - таблица значений с колонками
//			ФизическоеЛицо
//			МесяцНалоговогоПериода.
//			Подразделение
//			КодВычетаЛичный
//			ПримененныйВычетЛичный
//			ПримененныйВычетНаДетей
//			ПримененныйВычетНаДетейДвойной
//			ПримененныйВычетНаДетейДвойнойВторой
//			ПримененныйВычетНаТретьегоРебенка
//			ПримененныйВычетНаТретьегоРебенкаДвойной
//			ПримененныйВычетНаТретьегоРебенкаДвойнойВторой
//			ПримененныйВычетНаВторогоРебенка
//			ПримененныйВычетНаВторогоРебенкаДвойной
//			ПримененныйВычетНаВторогоРебенкаДвойнойВторой
//			ПримененныйВычетНаДетейИнвалидов
//			ПримененныйВычетНаДетейИнвалидовДвойной
//			ПримененныйВычетНаДетейИнвалидовДвойнойВторой
//			НалогПоСтавке13
//			ЗачтеноАвансовыхПлатежейПоСтавке13
//			НалогПоСтавке13КЗачетуВозврату
//			ПримененныйВычетИмущественныйРасходы
//			ПримененныйВычетИмущественныйПроцентыПоКредитам
//			ПримененныйВычетИмущественныйПроцентыПриПерекредитовании.
//
Функция РассчитатьНалогПоОсновнойСтавке(Регистратор, Организация, МесяцРасчета, МенеджерВременныхТаблиц, Знач ПервыйМесяцНалоговогоПериода = Неопределено, Знач ПоследнийМесяцНалоговогоПериода = Неопределено, ИсключатьДоходыРегистратора = Истина, ОкончательныйРасчет = Истина, ДатаУдержанияИсчисленногоНалога = Неопределено) Экспорт
	

	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("ГоловнаяОрганизация", ЗарплатаКадрыПовтИсп.ГоловнаяОрганизация(Организация));
	Запрос.УстановитьПараметр("Регистратор", Регистратор);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("МесяцНачисления",НачалоМесяца(МесяцРасчета));
	Запрос.УстановитьПараметр("НачалоМесяцаРасчета",НачалоМесяца(МесяцРасчета));
	Запрос.УстановитьПараметр("КонецМесяцаРасчета",КонецМесяца(МесяцРасчета));
	Запрос.УстановитьПараметр("НачалоГодаРасчета",НачалоГода(МесяцРасчета));
	Запрос.УстановитьПараметр("ИсключаемыйРегистратор", ?(ИсключатьДоходыРегистратора, Регистратор, Неопределено));
	Запрос.УстановитьПараметр("ОкончательныйРасчет", ОкончательныйРасчет);
	
	СтрокиКРасчету = ЗаполнитьНДФЛ(Регистратор, МенеджерВременныхТаблиц, Организация, МесяцРасчета, ПервыйМесяцНалоговогоПериода, ПоследнийМесяцНалоговогоПериода, ОкончательныйРасчет);
	
	Запрос.УстановитьПараметр("НДФЛ", СтрокиКРасчету);


	Запрос.Текст = 
	   "ВЫБРАТЬ
	   |	НДФЛ.ФизическоеЛицо,
	   |	НДФЛ.КодДохода,
	   |	НДФЛ.НалоговыйПериод
	   |ПОМЕСТИТЬ ВТСтрокиРасчетаПромежуточная
	   |ИЗ
	   |	&НДФЛ КАК НДФЛ
   	   |;
	   |
	   |///////////////////////////////////////////////////////////////////////////////
	   |ВЫБРАТЬ
	   |	НДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
	   |	НДФЛ.КодДохода КАК КодДохода,
	   |	НДФЛ.НалоговыйПериод КАК НалоговыйПериод
	   |ПОМЕСТИТЬ ВТСтрокиРасчета
	   |ИЗ
	   |	ВТСтрокиРасчетаПромежуточная КАК НДФЛ
	   |
	   |ОБЪЕДИНИТЬ ВСЕ
	   |
	   |ВЫБРАТЬ
	   |	НДФЛ.ФизическоеЛицо,
	   |	ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.Код101),
	   |	НДФЛ.НалоговыйПериод
	   |ИЗ
	   |	ВТСтрокиРасчетаПромежуточная КАК НДФЛ
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |	ВТСтрокиРасчетаПромежуточная КАК НДФЛ1
	   |    ПО НДФЛ.ФизическоеЛицо = НДФЛ1.ФизическоеЛицо 
	   |     И НДФЛ.НалоговыйПериод = НДФЛ1.НалоговыйПериод
	   |     И НДФЛ.КодДохода = ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.Код101ФСС)
	   |     И НДФЛ1.КодДохода = ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.Код101)
	   |ГДЕ
	   |    НДФЛ.КодДохода = ЗНАЧЕНИЕ(Справочник.ВидыДоходовНДФЛ.Код101ФСС)И НДФЛ1.КодДохода ЕСТЬ NULL
	   |;
	   |
	   |////////////////////////////////////////////////////////////////////////////////
	   |УНИЧТОЖИТЬ ВТСтрокиРасчетаПромежуточная
	   |";

	Запрос.Выполнить();   
	
	//Запросы к данным регистров - начислениям сотрудников и удержанному НДФЛ.
	//Если не по всем документам - нужен отбор по регистратору
	Запрос.Текст = 
	   "////////////////////////////////////////////////////////////////////////////////
	   |ВЫБРАТЬ РАЗРЕШЕННЫЕ
	   |	СведенияОДоходахНДФЛ.ФизическоеЛицо,
	   |	СведенияОДоходахНДФЛ.КодДохода,
	   |	СведенияОДоходахНДФЛ.НалоговыйПериод,
	   |	СведенияОДоходахНДФЛ.НатуральныйКоэффициент,
	   |	СведенияОДоходахНДФЛ.СуммаДоходаОборот КАК СуммаОборот
	   |
	   |ПОМЕСТИТЬ ВТНачисленияОборотыСКоэффициентом
	   |ИЗ
	   |	РегистрНакопления.СведенияОДоходахНДФЛ.Обороты(
	   |			,
	   |			КОНЕЦПЕРИОДА(&МесяцНачисления, МЕСЯЦ),
	   |			,
	   |			Организация = &Организация
	   |				И (ФизическоеЛицо В
	   |					(ВЫБРАТЬ
	   |						СтрокиРасчета.ФизическоеЛицо
	   |					ИЗ
	   |						ВТСтрокиРасчета КАК СтрокиРасчета))
	   |			) КАК СведенияОДоходахНДФЛ
	   |;
	   |
	   |///////////////////////////////////////////////////////////////////////////////
	   |ВЫБРАТЬ
	   |	СведенияОДоходахНДФЛ.ФизическоеЛицо,
	   |	СведенияОДоходахНДФЛ.КодДохода,
	   |	СведенияОДоходахНДФЛ.НалоговыйПериод,
	   |	СУММА(
	   |		ВЫБОР КОГДА СведенияОДоходахНДФЛ.НатуральныйКоэффициент
	   |		 ТОГДА СведенияОДоходахНДФЛ.СуммаОборот
	   |		 ИНАЧЕ 0
	   |		КОНЕЦ
	   |	) КАК СуммаНатуральныйКоэффициентОборот,
	   |	СУММА(СведенияОДоходахНДФЛ.СуммаОборот) КАК СуммаОборот
	   |ПОМЕСТИТЬ ВТНачисленияОбороты
	   |ИЗ  ВТНачисленияОборотыСКоэффициентом КАК СведенияОДоходахНДФЛ
	   |
	   |СГРУППИРОВАТЬ ПО
	   |	СведенияОДоходахНДФЛ.ФизическоеЛицо,
	   |	СведенияОДоходахНДФЛ.КодДохода,
	   |	СведенияОДоходахНДФЛ.НалоговыйПериод
	   |;
	   |///////////////////////////////////////////////////////////////////////////////
	   |ВЫБРАТЬ РАЗРЕШЕННЫЕ
	   |	ИсчисленныйНДФЛОборот.ФизическоеЛицо,
	   |	ИсчисленныйНДФЛОборот.КодДохода КАК КодДохода,
	   |	ИсчисленныйНДФЛОборот.НалоговыйПериод КАК НалоговыйПериод,
	   |	ИсчисленныйНДФЛОборот.ДоходОборот КАК ДоходДо,
	   |	ИсчисленныйНДФЛОборот.НалогОборот КАК НалогДо
	   |
	   |ПОМЕСТИТЬ ВТИсчисленныйНДФЛОборот
	   |ИЗ
	   |	РегистрНакопления.ИсчисленныйНДФЛ.Обороты(
	   |			,
	   |			КОНЕЦПЕРИОДА(&МесяцНачисления, МЕСЯЦ),
	   |			,
	   |			Организация = &Организация
	   |				И (ФизическоеЛицо В
	   |					(ВЫБРАТЬ
	   |						СтрокиРасчета.ФизическоеЛицо
	   |					ИЗ
	   |						ВТСтрокиРасчета КАК СтрокиРасчета))) КАК ИсчисленныйНДФЛОборот
	   |";	
	
	Если ОкончательныйРасчет И ИсключатьДоходыРегистратора Тогда
		ПоляСуммирования = Новый Массив;
		ПоляСуммирования.Добавить("СуммаОборот");
		ПоляСуммирования.Добавить("ДоходДо");
		ПоляСуммирования.Добавить("НалогДо");
		Запрос.Текст = ЗарплатаКадры.ДобавитьОтборПоРегистраторуРегистрНакопленияОбороты(Запрос.Текст, "ИсключаемыйРегистратор", ПоляСуммирования, "<>");
	ИначеЕсли НЕ ОкончательныйРасчет И Регистратор <> Неопределено Тогда
		ПоляСуммирования = Новый Массив;
		ПоляСуммирования.Добавить("СуммаОборот");
		ПоляСуммирования.Добавить("ДоходДо");
		ПоляСуммирования.Добавить("НалогДо");
		Если ТипЗнч(Регистратор) = Тип("ДокументСсылка.РегистрацияПрочихДоходов") Или
			ТипЗнч(Регистратор) = Тип("ДокументСсылка.ВыплатаБывшимСотрудникам") Тогда
			Запрос.Текст = ЗарплатаКадры.ДобавитьОтборПоРегистраторуРегистрНакопленияОбороты(Запрос.Текст, "Регистратор", ПоляСуммирования);
		Иначе	
			Запрос.Текст = ЗарплатаКадры.ДобавитьОтборПоРегистраторуРегистрНакопленияОбороты(Запрос.Текст, ".Проведен", ПоляСуммирования, "ЕСТЬ NULL");
		КонецЕсли;	
	КонецЕсли;
	
	Запрос.Выполнить(); 
	
	ОтборыОТ = Новый Структура();
	ВыбираемыеПоляОТ = Новый Структура();
	ОтборыРС = Новый Структура();
	ВыбираемыеПоляРС = Новый Структура();
	ВыбираемыеПоляРС.Вставить("ВидСтавки","ВидСтавкиНДФЛ");
	ВыбираемыеПоляРС.Вставить("Ставка","СтавкаНДФЛ");
	ВыбираемыеПоляРС.Вставить("Порог","ПорогСтавкаНДФЛ");
	ПоляСвязей = Новый Структура();
	
	Запрос.Текст = ЗарплатаКадры.ЗапросВТСрезПоследнихНаВсеДаты("ВТИсторияНормативныхВеличин", "ВТСтрокиРасчета", ОтборыОТ, ВыбираемыеПоляОТ, "НалоговыйПериод", "РегистрСведений.СтавкиНДФЛ", ОтборыРС, ВыбираемыеПоляРС,"Период", ПоляСвязей, ЛОЖЬ, ЛОЖЬ, ЛОЖЬ);
	Запрос.Выполнить();

	Запрос.Текст = 
	   //|////////////////////////////////////////////////////////////////////////////////
	   "ВЫБРАТЬ
	   |	НачисленияОбороты.ФизическоеЛицо,
	   |	НачисленияОбороты.КодДохода,
	   |	НачисленияОбороты.НалоговыйПериод,
	   |	СУММА(НачисленияОбороты.СуммаНатуральныйКоэффициентОборот) КАК ДоходНатуральныйКоэффициент,
	   |	СУММА(НачисленияОбороты.СуммаОборот) КАК Доход
	   |ПОМЕСТИТЬ ВТБаза
	   |ИЗ
	   |	ВТНачисленияОбороты КАК НачисленияОбороты
	   |    ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	   |    ВТСтрокиРасчета КАК СтрокиРасчета
	   |    ПО СтрокиРасчета.ФизическоеЛицо = НачисленияОбороты.ФизическоеЛицо
	   |     И СтрокиРасчета.КодДохода = НачисленияОбороты.КодДохода
	   |     И СтрокиРасчета.НалоговыйПериод = НачисленияОбороты.НалоговыйПериод
	   |СГРУППИРОВАТЬ ПО
	   |	НачисленияОбороты.ФизическоеЛицо,
	   |	НачисленияОбороты.КодДохода,
	   |	НачисленияОбороты.НалоговыйПериод
	   |;
	   |////////////////////////////////////////////////////////////////////////////////
	   |ВЫБРАТЬ
	   |	ТаблицаБаза.ФизическоеЛицо,
	   |	ТаблицаБаза.НалоговыйПериод,
	   |	СУММА(ТаблицаБаза.Доход) КАК ДоходПолный
	   |ПОМЕСТИТЬ ВТБазаПолная
	   |ИЗ
	   |	ВТБаза КАК ТаблицаБаза
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |    Справочник.ВидыДоходовНДФЛ КАК ВидыДоходовНДФЛ
	   |    ПО ТаблицаБаза.КодДохода = ВидыДоходовНДФЛ.Ссылка
	   |ГДЕ
	   |    ВидыДоходовНДФЛ.ВидСтавкиРезидента <> ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ВоенныйСбор)
	   |СГРУППИРОВАТЬ ПО
	   |	ТаблицаБаза.ФизическоеЛицо,
	   |	ТаблицаБаза.НалоговыйПериод
	   |;
	   |	   
	   |////////////////////////////////////////////////////////////////////////////////
	   |ВЫБРАТЬ
	   |	СтрокиРасчета.ФизическоеЛицо,
	   |	СтрокиРасчета.КодДохода,
	   |	СтрокиРасчета.НалоговыйПериод,
	   |	ЕСТЬNULL(ТаблицаБаза.Доход, 0) КАК Доход,
	   |	ЕСТЬNULL(ТаблицаБаза.ДоходНатуральныйКоэффициент, 0) КАК ДоходНатуральныйКоэффициент,
	   |	ЕСТЬNULL(ТаблицаБазаПолная.ДоходПолный, 0 ) КАК ДоходПолный,
	   |	ЕСТЬNULL(ТаблицаДоходНалогДо.ДоходДо, 0) КАК ДоходДо,
	   |	ЕСТЬNULL(ТаблицаДоходНалогДо.НалогДо, 0) КАК НалогДо,
	   |    ВЫБОР
	   |		КОГДА ЕСТЬNULL(СпециальныеРежимыЗарплатаКадры.РезидентДияСити, ЛОЖЬ) И ВидыДоходовНДФЛ.ВидСтавкиДия <> ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ПустаяСсылка)
	   |			ТОГДА ВидыДоходовНДФЛ.ВидСтавкиДия
	   |			ИНАЧЕ ВидыДоходовНДФЛ.ВидСтавкиРезидента 
	   |    КОНЕЦ КАК ВидСтавки,
   	   |    ВЫБОР
	   |		КОГДА ЕСТЬNULL(СпециальныеРежимыЗарплатаКадры.РезидентДияСити, ЛОЖЬ) И ВидыДоходовНДФЛ.ВидСтавкиДия <> ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ПустаяСсылка)
	   |			ТОГДА ВидыДоходовНДФЛ.ВидСтавкиДия
	   |			ИНАЧЕ ВидыДоходовНДФЛ.ВидСтавкиУвеличенная 
	   |    КОНЕЦ КАК УвеличеннаяСтавка,
	   |    ЕСТЬNULL(История1.СтавкаНДФЛ, 0) КАК СтавкаНДФЛ,
	   |    ЕСТЬNULL(История2.СтавкаНДФЛ, 0) КАК СтавкаНДФЛУвеличенная,
	   |    ЕСТЬNULL(История2.ПорогСтавкаНДФЛ, 0) КАК ПорогСтавкаНДФЛУвеличенная
	   |ПОМЕСТИТЬ ВТСтрокиРасчетаСДанными 
	   |ИЗ
	   |	ВТСтрокиРасчета КАК СтрокиРасчета
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |    Справочник.ВидыДоходовНДФЛ КАК ВидыДоходовНДФЛ
	   |    ПО СтрокиРасчета.КодДохода = ВидыДоходовНДФЛ.Ссылка
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |    РегистрСведений.СпециальныеРежимыЗарплатаКадры.СрезПоследних(&МесяцНачисления) КАК СпециальныеРежимыЗарплатаКадры
	   |    ПО СпециальныеРежимыЗарплатаКадры.Организация = &Организация
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |	ВТБаза КАК ТаблицаБаза
	   |    ПО СтрокиРасчета.ФизическоеЛицо = ТаблицаБаза.ФизическоеЛицо
	   |     И СтрокиРасчета.КодДохода = ТаблицаБаза.КодДохода
	   |     И СтрокиРасчета.НалоговыйПериод = ТаблицаБаза.НалоговыйПериод
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |	ВТБазаПолная КАК ТаблицаБазаПолная
	   |    ПО СтрокиРасчета.ФизическоеЛицо = ТаблицаБазаПолная.ФизическоеЛицо
	   |     И СтрокиРасчета.НалоговыйПериод = ТаблицаБазаПолная.НалоговыйПериод
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |	ВТИсчисленныйНДФЛОборот КАК ТаблицаДоходНалогДо
	   |    ПО СтрокиРасчета.ФизическоеЛицо = ТаблицаДоходНалогДо.ФизическоеЛицо
	   |     И СтрокиРасчета.КодДохода = ТаблицаДоходНалогДо.КодДохода
	   |     И СтрокиРасчета.НалоговыйПериод = ТаблицаДоходНалогДо.НалоговыйПериод
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |	ВТИсторияНормативныхВеличин КАК История1
	   |    ПО ВЫБОР
	   |		КОГДА ЕСТЬNULL(СпециальныеРежимыЗарплатаКадры.РезидентДияСити, ЛОЖЬ) И ВидыДоходовНДФЛ.ВидСтавкиДия <> ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ПустаяСсылка)
	   |			ТОГДА ВидыДоходовНДФЛ.ВидСтавкиДия
	   |			ИНАЧЕ ВидыДоходовНДФЛ.ВидСтавкиРезидента 
	   |    КОНЕЦ = История1.ВидСтавкиНДФЛ
	   |     И СтрокиРасчета.НалоговыйПериод = История1.НалоговыйПериод
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |	ВТИсторияНормативныхВеличин КАК История2
	   |    ПО  ВЫБОР
	   |		КОГДА ЕСТЬNULL(СпециальныеРежимыЗарплатаКадры.РезидентДияСити, ЛОЖЬ) И ВидыДоходовНДФЛ.ВидСтавкиДия <> ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ПустаяСсылка)
	   |			ТОГДА ВидыДоходовНДФЛ.ВидСтавкиДия
	   |			ИНАЧЕ ВидыДоходовНДФЛ.ВидСтавкиУвеличенная 
	   |    КОНЕЦ = История2.ВидСтавкиНДФЛ
	   |     И СтрокиРасчета.НалоговыйПериод = История2.НалоговыйПериод
	   |	
	   |;
	   |";
	   
	Запрос.Выполнить();
	
	ПолучитьСписокЛьгот(Запрос, Организация, МесяцРасчета, ОкончательныйРасчет);
	
	Запрос.Текст = 
	   "////////////////////////////////////////////////////////////////////////////////
	   |ВЫБРАТЬ
	   |	СтрокиРасчета.ФизическоеЛицо,
	   |	СтрокиРасчета.КодДохода,
	   |	СтрокиРасчета.КодДохода.Код КАК КодДоходаКод,
	   |	СтрокиРасчета.НалоговыйПериод,
	   |	СтрокиРасчета.Доход,
	   |	СтрокиРасчета.ДоходНатуральныйКоэффициент,
	   |	СтрокиРасчета.ДоходПолный,
	   |	0 КАК Налог,
	   |	0 КАК СуммаЛьготы,
	   |    ВЫБОР
       |   	 КОГДА НЕ (ВидыДоходов.Ссылка ЕСТЬ NULL)
	   |   	 ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыОсобыхНачисленийИУдержаний.ВоенныйСбор)
	   |   	 ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыОсобыхНачисленийИУдержаний.НДФЛ)
	   |    КОНЕЦ КАК ВидУдержания,
	   |	СтрокиРасчета.ДоходДо,
	   |	СтрокиРасчета.НалогДо,
	   |    СтрокиРасчета.ВидСтавки,
	   |    СтрокиРасчета.УвеличеннаяСтавка,
	   |    СтрокиРасчета.СтавкаНДФЛ,
	   |    СтрокиРасчета.СтавкаНДФЛУвеличенная,
	   |    СтрокиРасчета.ПорогСтавкаНДФЛУвеличенная,
	   |	ЕСТЬNULL(ЛьготыСотрудников.Льгота, ЗНАЧЕНИЕ(Справочник.ВидыЛьготПоНДФЛ.ПустаяСсылка)) КАК Льгота,
	   |	ЕСТЬNULL(ЛьготыСотрудников.КоличествоЛьгот, 0) КАК КоличествоЛьгот,
	   |	ЕСТЬNULL(ЛьготыСотрудников.КоличествоПороговЛьгот, 0) КАК КоличествоПороговЛьгот,
	   |    ЕСТЬNULL(ЛьготыСотрудников.ПорогЛьготНДФЛ, 0) КАК ПорогЛьготНДФЛ,
	   |    ЕСТЬNULL(ЛьготыСотрудников.СтавкаЛьготНДФЛ, 0) КАК СтавкаЛьготНДФЛ,
	   |    ЕСТЬNULL(ЛьготыСотрудников.РазмерПрожиточныеМинимумы, 0) КАК РазмерПрожиточныеМинимумы,
	   |    ЕСТЬNULL(ЛьготыСотрудников.ДоходЛьготы, 0) КАК ДоходЛьготы
	   |ИЗ
	   |	ВТСтрокиРасчетаСДанными КАК СтрокиРасчета
	   |    ЛЕВОЕ СОЕДИНЕНИЕ
	   |    ВТЛьготыСотрудников КАК ЛьготыСотрудников
	   |	ПО ЛьготыСотрудников.НалоговыйПериод = СтрокиРасчета.НалоговыйПериод
	   |	 И ЛьготыСотрудников.ФизическоеЛицо = СтрокиРасчета.ФизическоеЛицо
	   |	 И СтрокиРасчета.КодДохода.УчитыватьНСЛ
	   |   ЛЕВОЕ СОЕДИНЕНИЕ
	   |   Справочник.ВидыДоходовНДФЛ КАК ВидыДоходов
	   |   ПО ВидыДоходов.Ссылка = СтрокиРасчета.КодДохода
	   |    И ВидыДоходов.ВидСтавкиРезидента = ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ВоенныйСбор)
	   |";
	
	РезультатНДФЛ = Запрос.Выполнить().Выгрузить();	   
	
	Для каждого ВыборкаНДФЛ из РезультатНДФЛ Цикл
		
		//Данные запроса
		ДоходДо			= ВыборкаНДФЛ.ДоходДо;
		НалогДо			= ВыборкаНДФЛ.НалогДо;
		Доход			= ВыборкаНДФЛ.Доход;
		ДоходПолный		= ВыборкаНДФЛ.ДоходПолный;
		
		ДоходНатура 	= ВыборкаНДФЛ.ДоходНатуральныйКоэффициент;
		
		СтавкаНДФЛ					= ВыборкаНДФЛ.СтавкаНДФЛ;
		СтавкаНДФЛУвеличенная		= ВыборкаНДФЛ.СтавкаНДФЛУвеличенная;
		ПорогСтавкаНДФЛУвеличенная	= ВыборкаНДФЛ.ПорогСтавкаНДФЛУвеличенная;
		
		Льгота					= ВыборкаНДФЛ.Льгота;
		КоличествоЛьгот			= ВыборкаНДФЛ.КоличествоЛьгот;
		КоличествоПороговЛьгот	= ВыборкаНДФЛ.КоличествоПороговЛьгот;
		ПорогЛьготНДФЛ			= ВыборкаНДФЛ.ПорогЛьготНДФЛ;
		СтавкаЛьготНДФЛ			= ВыборкаНДФЛ.СтавкаЛьготНДФЛ;
		РазмерПМ				= ВыборкаНДФЛ.РазмерПрожиточныеМинимумы;
		ДоходЛьготы				= ВыборкаНДФЛ.ДоходЛьготы;
		
		
		
		//Учет ЕСВ 
		ВзносыВсего = 0;  //Всего учитываеться взносов для работника в этом периоде
		СуммаВзносов = 0; //в т.ч. по данному виду дохода НДФЛ
		//ВыборкаЕСВ.Сбросить();
		//СтуктураПоиска = Новый Структура("ФизическоеЛицо, НалоговыйПериод");
		//СтуктураПоиска.ФизическоеЛицо = ВыборкаНДФЛ.ФизическоеЛицо;
		//СтуктураПоиска.НалоговыйПериод = ВыборкаНДФЛ.НалоговыйПериод;
		//Пока ВыборкаЕСВ.НайтиСледующий(СтуктураПоиска) Цикл
		//	К = 1;
		//	Если ВыборкаЕСВ.ЧастьБазыЕСВ = ВыборкаЕСВ.БазаЕСВ Тогда
		//		//Если весь ЕСВ данного вида относится к данному виду дохода НДФЛ - учитываем полностью
		//		К = 1;
		//	ИначеЕсли ВыборкаЕСВ.ЧастьБазыЕСВ < ВыборкаЕСВ.БазаЕСВ Тогда	
		//		К = ВыборкаЕСВ.ЧастьБазыЕСВ/ВыборкаЕСВ.БазаЕСВ;
		//	КонецЕсли;	
		//	
		//	ВзносыВсего = ВзносыВсего + К*ВыборкаЕСВ.СуммаЕСВ;
		//	Если ВыборкаНДФЛ.ДоходНДФЛ = ВыборкаЕСВ.ДоходНДФЛ Тогда
		//		СуммаВзносов = СуммаВзносов + К*ВыборкаЕСВ.СуммаЕСВ;
		//	КонецЕсли;	

		//КонецЦикла;
		//ВзносыВсего  = Окр(ВзносыВсего, 2);
		//СуммаВзносов = Окр(СуммаВзносов, 2);
		
		//Расчет льгот
		СуммаЛьготы = 0;
		Если ЗначениеЗаполнено(Льгота) 
		   И ДоходЛьготы <= КоличествоПороговЛьгот * ПорогЛьготНДФЛ 
		   И Доход <> 0
		   Тогда			
			КоэфЛьготы = ?(ДоходЛьготы = 0, 0, Окр(Доход/ДоходЛьготы,5));
			СуммаЛьготы = Окр(КоличествоЛьгот * РазмерПМ * СтавкаЛьготНДФЛ * КоэфЛьготы,2);
		Иначе
				
			КоличествоЛьгот = 0;
			Льгота	= Справочники.ВидыЛьготПоНДФЛ.ПустаяСсылка();
			
		КонецЕсли;		
		
		//Расчет
		БазаНалога = Окр(Доход, 2) - СуммаЛьготы - СуммаВзносов;
		Налог = Окр(Макс(БазаНалога * СтавкаНДФЛ, 0), 5);
		
		//ст. 167.1 Налогового кодекса - если общий доход превышает 10-ти кратный размер минимальной зарплаты,
		//то к сумме превышения применяется ставка 17%.
		//Т.е. к налогу по ставке 15% (уже рассчитано) надо доначислить 2% от суммы превышения.
		//Если в месяце есть несколько видов дохода - учтем по каждому пропорционально?
		Если СтавкаНДФЛУвеличенная <> 0 И СтавкаНДФЛУвеличенная <> СтавкаНДФЛ И ДоходПолный <> 0 И (ДоходПолный <> ВзносыВсего) И Доход <> 0 Тогда
			Превышение = Макс(ДоходПолный - ВзносыВсего - ПорогСтавкаНДФЛУвеличенная,0)*БазаНалога/(ДоходПолный - ВзносыВсего);
			СтавкаПревышение = Макс(СтавкаНДФЛУвеличенная - СтавкаНДФЛ,0);
			НалогПревышение = Окр(Превышение*СтавкаПревышение,5);
			Налог = Налог + НалогПревышение;
		Иначе
			Превышение = 0;
			НалогПревышение = 0;
		КонецЕсли;
		
		Если ДоходНатура <> 0 и Доход <> 0 Тогда
			ДоходБезНатуры = Доход; 
			Доля = ДоходНатура/Доход;
			Натура15 = Окр(ДоходНатура*(1/(1-СтавкаНДФЛ)-1),2);
			Натура17 = Окр(Превышение*Доля*(1/(1-СтавкаНДФЛУвеличенная)-1) - Превышение*Доля*(1/(1-СтавкаНДФЛ)-1),2);
				
			Доход = Окр(Доход + Натура15 + Натура17,2); 
			БазаНалога = Окр(Доход, 2) - СуммаЛьготы - СуммаВзносов;
				
			Налог = Налог + Окр(Натура15*СтавкаНДФЛ,2);
			НалогПревышение = Окр((Превышение+Натура17)*Макс(СтавкаНДФЛУвеличенная - СтавкаНДФЛ,0),2);
		КонецЕсли;
		
		Налог = Окр(Налог,2);
		
		//Запись расчетных величин
		ВыборкаНДФЛ.Доход = Доход - ДоходДо;
		ВыборкаНДФЛ.Налог = Налог - НалогДо;
		ВыборкаНДФЛ.Льгота = ?(СуммаЛьготы = 0, "", Льгота);
		ВыборкаНДФЛ.КоличествоЛьгот = КоличествоЛьгот;
		ВыборкаНДФЛ.СуммаЛьготы = МИН(СуммаЛьготы, Доход);
		ВыборкаНДФЛ.ДоходПолный = ДоходПолный;
		
	КонецЦикла;	

	Запрос.Текст =
	"УНИЧТОЖИТЬ ВТСтрокиРасчета
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТНачисленияОборотыСКоэффициентом
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТНачисленияОбороты
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТИсчисленныйНДФЛОборот
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТИсторияНормативныхВеличин
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТБаза
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТБазаПолная
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТСтрокиРасчетаСДанными
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВТЛьготыСотрудников
	|";
	Запрос.Выполнить();

	
	

	Возврат РезультатНДФЛ;
	
КонецФункции


// Предназначена для расчета НДФЛ удержанного по записанным в учете данным и по 
// переданным данным о выплатах.
//
// Параметры:
//      Ссылка - ДокументСсылка - ссылка на документ-регистратор.
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение.
//		Организация
//      МенеджерТаблиц - МенеджерВременныхТаблиц, содержит вр. таблицу 
//      	ВТСписокСотрудников с полями 
//				ФизическоеЛицо: должно быть непустым
//          	СуммаВыплаты
//          	ДокументОснование, необязательная, если передана, отбираются остатки по указанным документам
//
//  Возвращает таблицу значений удержанных сумм налогов в разрезе месяцев налогового периода и ставок.
//
Функция РассчитатьУдержанныеНалоги(Ссылка, Организация, ДатаОперации, МенеджерТаблиц, ПериодРегистрации = Неопределено) Экспорт
	
	
	
	Запрос = Новый Запрос();
	Запрос.МенеджерВременныхТаблиц = МенеджерТаблиц;
	Запрос.УстановитьПараметр("ГоловнаяОрганизация", ЗарплатаКадрыПовтИсп.ГоловнаяОрганизация(Организация));
	Запрос.УстановитьПараметр("Регистратор", Ссылка);
	Запрос.УстановитьПараметр("Организация", Организация);
	Запрос.УстановитьПараметр("ДатаОперации", КонецДня(ДатаОперации));
	Запрос.УстановитьПараметр("КонецМесяца", КонецМесяца(ДатаОперации));
	Запрос.УстановитьПараметр("ПериодРегистрации", ПериодРегистрации);
	
	РезультатыРасчетов = Новый ТаблицаЗначений;
	РезультатыРасчетов.Колонки.Добавить("Период",Новый ОписаниеТипов("Дата",,,Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	РезультатыРасчетов.Колонки.Добавить("ФизическоеЛицо",Новый ОписаниеТипов("СправочникСсылка.ФизическиеЛица"));
	РезультатыРасчетов.Колонки.Добавить("КодДохода",Новый ОписаниеТипов("СправочникСсылка.ВидыДоходовНДФЛ"));               
	РезультатыРасчетов.Колонки.Добавить("ОбособленноеПодразделение",Новый ОписаниеТипов("СправочникСсылка.ОбособленныеПодразделенияОрганизаций"));
	РезультатыРасчетов.Колонки.Добавить("ДокументОснование", Метаданные.ОпределяемыеТипы.ДокументыОснованияНДФЛ.Тип);
    РезультатыРасчетов.Колонки.Добавить("ПериодВзаиморасчетов",Новый ОписаниеТипов("Дата",,,Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	РезультатыРасчетов.Колонки.Добавить("НалоговыйПериод",Новый ОписаниеТипов("Дата",,,Новый КвалификаторыДаты(ЧастиДаты.Дата)));
	РезультатыРасчетов.Колонки.Добавить("ГруппаУчетаУдержаний",Новый ОписаниеТипов("СправочникСсылка.ГруппыУчетаНачисленийИУдержаний"));               
	РезультатыРасчетов.Колонки.Добавить("Налог",Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,2)));
	РезультатыРасчетов.Колонки.Добавить("Доход",Новый ОписаниеТипов("Число",Новый КвалификаторыЧисла(15,2)));
	
	Запрос.Текст = "ВЫБРАТЬ ПЕРВЫЕ 1 * ИЗ ВТСписокСотрудников КАК СписокСотрудников";
	Результат = Запрос.Выполнить();
	Если Результат.Пустой() Тогда
		Возврат РезультатыРасчетов
	КонецЕсли;
	
	ПараметрыПолученияЗарплатыКВыплате = ВзаиморасчетыССотрудниками.ПараметрыПолученияЗарплатыКВыплатеВедомости(Ссылка);
	
	//НДФЛ может не перечисляться
	Если ПараметрыПолученияЗарплатыКВыплате.ПорядокЗаполненияНалогов <> Перечисления.ПорядокЗаполненияНалогов.НДФЛ
		И  ПараметрыПолученияЗарплатыКВыплате.ПорядокЗаполненияНалогов <> Перечисления.ПорядокЗаполненияНалогов.НДФЛИВзносы Тогда
		Возврат РезультатыРасчетов;	
	КонецЕсли;

    ПоВсемВидамДохода = (ПараметрыПолученияЗарплатыКВыплате.КодДоходаНДФЛ = Справочники.ВидыДоходовНДФЛ.ПустаяСсылка());
	Запрос.УстановитьПараметр("ПоВсемВидамДохода", ПоВсемВидамДохода);
	
	ВидыДоходаНДФЛ = Новый Массив();
	ВидыДоходаНДФЛ.Добавить(ПараметрыПолученияЗарплатыКВыплате.КодДоходаНДФЛ);
	ВидыДоходаНДФЛ.Добавить(ПараметрыПолученияЗарплатыКВыплате.КодДоходаВС);
	Запрос.УстановитьПараметр("ВидыДоходаНДФЛ", ВидыДоходаНДФЛ);
	
	Если ПараметрыПолученияЗарплатыКВыплате.СпособПолучения = Перечисления.СпособыПолученияЗарплатыКВыплате.ОкончательныйРасчет Тогда
		//Заполнение по зарплате - остатками
		Запрос.Текст =  
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	СписокСотрудников.ФизическоеЛицо
		|ПОМЕСТИТЬ ВТОтборПоСотрудникам
		|ИЗ
		|	ВТСписокСотрудников КАК СписокСотрудников
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ		
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ПериодВзаиморасчетов КАК ПериодВзаиморасчетов,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ГруппаУчетаУдержаний КАК ГруппаУчетаУдержаний,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.КодДохода КАК КодДохода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.НалоговыйПериод КАК МесяцНалоговогоПериода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование КАК ДокументОснование,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.НалогОстаток КАК Сумма,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДоходОстаток КАК Доход
		|ПОМЕСТИТЬ ВТНДФЛЗарплатаКВыплате
		|ИЗ
		|	ВТОтборПоСотрудникам КАК СписокСотрудников
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Остатки(&ДатаОперации,ГоловнаяОрганизация = &ГоловнаяОрганизация И Организация = &Организация И (&ПоВсемВидамДохода ИЛИ КодДохода В (&ВидыДоходаНДФЛ))) КАК РасчетыНалогоплательщиковСБюджетомПоНДФЛ
		|		ПО СписокСотрудников.ФизическоеЛицо = РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо
		|
		|ГДЕ
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.НалогОстаток <> 0
		|   ИЛИ РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДоходОстаток <> 0
		|";
		
	ИначеЕсли ПараметрыПолученияЗарплатыКВыплате.СпособПолучения = Перечисления.СпособыПолученияЗарплатыКВыплате.ОтдельныйРасчет Тогда
		//Заполнение по межрасчетным - приходы и расходы по документам-основаниям
		Запрос.Текст =  
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	СписокСотрудников.ФизическоеЛицо,
		|	СписокСотрудников.ДокументОснование
		|ПОМЕСТИТЬ ВТОтборПоСотрудникам
		|ИЗ
		|	ВТСписокСотрудников КАК СписокСотрудников
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ		
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ПериодВзаиморасчетов КАК ПериодВзаиморасчетов,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ГруппаУчетаУдержаний КАК ГруппаУчетаУдержаний,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.КодДохода КАК КодДохода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.НалоговыйПериод КАК МесяцНалоговогоПериода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование КАК ДокументОснование,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.НалогОстаток КАК Сумма,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДоходОстаток КАК Доход
		|ПОМЕСТИТЬ ВТНДФЛЗарплатаКВыплате
		|ИЗ
		|	ВТОтборПоСотрудникам КАК СписокСотрудников
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Остатки(&ДатаОперации,ГоловнаяОрганизация = &ГоловнаяОрганизация И Организация = &Организация И (&ПоВсемВидамДохода ИЛИ КодДохода В (&ВидыДоходаНДФЛ))) КАК РасчетыНалогоплательщиковСБюджетомПоНДФЛ
		|		ПО СписокСотрудников.ФизическоеЛицо = РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо
		|		 И СписокСотрудников.ДокументОснование = РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование
		|
		|ГДЕ
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.НалогОстаток <> 0
		|	ИЛИ РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДоходОстаток <> 0
		|";
		
	ИначеЕсли ПараметрыПолученияЗарплатыКВыплате.СпособПолучения = Перечисления.СпособыПолученияЗарплатыКВыплате.Аванс Тогда	
		//Заполнение по межрасчетным - приходы и расходы по документам-основаниям плюс исчисленные авансом
		Запрос.Текст =  
		"ВЫБРАТЬ РАЗЛИЧНЫЕ
		|	СписокСотрудников.ФизическоеЛицо,
		|	СписокСотрудников.ДокументОснование
		|ПОМЕСТИТЬ ВТОтборПоСотрудникам
		|ИЗ
		|	ВТСписокСотрудников КАК СписокСотрудников
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ		
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ПериодВзаиморасчетов КАК ПериодВзаиморасчетов,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ГруппаУчетаУдержаний КАК ГруппаУчетаУдержаний,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.КодДохода КАК КодДохода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.НалоговыйПериод КАК МесяцНалоговогоПериода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование КАК ДокументОснование,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.НалогОстаток КАК Сумма,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДоходОстаток КАК Доход
		|ПОМЕСТИТЬ ВТДвижения 
		|ИЗ
		|	ВТОтборПоСотрудникам КАК СписокСотрудников
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Остатки(&ДатаОперации,ГоловнаяОрганизация = &ГоловнаяОрганизация И Организация = &Организация И (&ПоВсемВидамДохода ИЛИ КодДохода В (&ВидыДоходаНДФЛ))) КАК РасчетыНалогоплательщиковСБюджетомПоНДФЛ
		|		ПО СписокСотрудников.ФизическоеЛицо = РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо
		|		 И СписокСотрудников.ДокументОснование = РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование
		|		 И СписокСотрудников.ДокументОснование <> НЕОПРЕДЕЛЕНО
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ		
		|	ИсчисленныйНДФЛАвансом.ФизическоеЛицо КАК ФизическоеЛицо,
		|	&ПериодРегистрации КАК ПериодВзаиморасчетов,
		|	ИсчисленныйНДФЛАвансом.ГруппаУчетаУдержаний КАК ГруппаУчетаУдержаний,
		|	ИсчисленныйНДФЛАвансом.КодДохода КАК КодДохода,
		|	ИсчисленныйНДФЛАвансом.НалоговыйПериод КАК МесяцНалоговогоПериода,
		|	ИсчисленныйНДФЛАвансом.Регистратор КАК ДокументОснование,
		|	ИсчисленныйНДФЛАвансом.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
		|	ИсчисленныйНДФЛАвансом.Налог КАК Сумма,
		|	ИсчисленныйНДФЛАвансом.Доход КАК Доход
		|ИЗ
		|	ВТОтборПоСотрудникам КАК СписокСотрудников
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ИсчисленныйНДФЛАвансом КАК ИсчисленныйНДФЛАвансом
		|		ПО СписокСотрудников.ФизическоеЛицо = ИсчисленныйНДФЛАвансом.ФизическоеЛицо
		|		 И (СписокСотрудников.ДокументОснование = НЕОПРЕДЕЛЕНО)
		|			И (ИсчисленныйНДФЛАвансом.Организация = &Организация)
		|			И (НАЧАЛОПЕРИОДА(ИсчисленныйНДФЛАвансом.Период, МЕСЯЦ) = &ПериодРегистрации)
		|			И (&ПоВсемВидамДохода ИЛИ КодДохода В (&ВидыДоходаНДФЛ))
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ		
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ПериодВзаиморасчетов КАК ПериодВзаиморасчетов,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ГруппаУчетаУдержаний КАК ГруппаУчетаУдержаний,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.КодДохода КАК КодДохода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.НалоговыйПериод КАК МесяцНалоговогоПериода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование КАК ДокументОснование,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
		|	-РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Налог КАК Сумма,
		|	-РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Доход КАК Доход
		|ИЗ
		|	ВТОтборПоСотрудникам КАК СписокСотрудников
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыНалогоплательщиковСБюджетомПоНДФЛ КАК РасчетыНалогоплательщиковСБюджетомПоНДФЛ
		|		ПО СписокСотрудников.ФизическоеЛицо = РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо
		|		 И (РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование = СписокСотрудников.ДокументОснование ИЛИ (СписокСотрудников.ДокументОснование = НЕОПРЕДЕЛЕНО И РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование ССЫЛКА Документ.НачислениеЗаПервуюПоловинуМесяца))
		|			И (РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход))
		|			И (РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ГоловнаяОрганизация = &ГоловнаяОрганизация)
		|			И (РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Организация = &Организация)
		|			И (РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Период <= &ДатаОперации)
		|			И (&ПоВсемВидамДохода ИЛИ РасчетыНалогоплательщиковСБюджетомПоНДФЛ.КодДохода В (&ВидыДоходаНДФЛ))
		|           И (НАЧАЛОПЕРИОДА(РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ПериодВзаиморасчетов, МЕСЯЦ) = &ПериодРегистрации)
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ		
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ПериодВзаиморасчетов КАК ПериодВзаиморасчетов,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ГруппаУчетаУдержаний КАК ГруппаУчетаУдержаний,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.КодДохода КАК КодДохода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование КАК ДокументОснование,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
		|	СУММА(РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Сумма) КАК Сумма,
		|	СУММА(РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Доход) КАК Доход
		|ПОМЕСТИТЬ ВТНДФЛЗарплатаКВыплате
		|ИЗ
		|   ВТДвижения КАК РасчетыНалогоплательщиковСБюджетомПоНДФЛ
		|
		|СГРУППИРОВАТЬ ПО
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ПериодВзаиморасчетов,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.КодДохода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ГруппаУчетаУдержаний,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.МесяцНалоговогоПериода,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование,
		|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ОбособленноеПодразделение
		|
		|ИМЕЮЩИЕ
		|	СУММА(РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Сумма) <> 0
		|	ИЛИ СУММА(РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Доход) <> 0
		|";
			
	КонецЕсли;
	
	Запрос.Выполнить();
	МассивНДФЛ = Справочники.ВидыДоходовНДФЛ.ВидыДоходовДляФСС();
	Запрос.УстановитьПараметр("НДФЛФСС", МассивНДФЛ);
	
	УчетнаяПолитикаПоНДФЛ = РегистрыСведений.УчетнаяПолитикаПоНДФЛ.СоздатьМенеджерЗаписи();
	УчетнаяПолитикаПоНДФЛ.ГоловнаяОрганизация = ЗарплатаКадрыПовтИсп.ГоловнаяОрганизация(Организация);
	УчетнаяПолитикаПоНДФЛ.Прочитать();
	
	Запрос.УстановитьПараметр("РазрешитьВыплатыДоОплаты", УчетнаяПолитикаПоНДФЛ.РазрешенаУплатаНалоговДоОплатыФСС);

	Запрос.Текст =  
	"ВЫБРАТЬ
	|	НДФЛЗарплатаКВыплате.ФизическоеЛицо КАК ФизическоеЛицо,
	|	НДФЛЗарплатаКВыплате.ПериодВзаиморасчетов КАК ПериодВзаиморасчетов,
	|	НДФЛЗарплатаКВыплате.ГруппаУчетаУдержаний КАК ГруппаУчетаУдержаний,
	|	НДФЛЗарплатаКВыплате.КодДохода КАК КодДохода,
	|	НДФЛЗарплатаКВыплате.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
	|	НДФЛЗарплатаКВыплате.ОбособленноеПодразделение КАК ОбособленноеПодразделение,
	|	НДФЛЗарплатаКВыплате.ДокументОснование КАК ДокументОснование,
	|	ВЫБОР
	|		КОГДА &РазрешитьВыплатыДоОплаты
	|				ИЛИ НЕ НДФЛЗарплатаКВыплате.КодДохода В (&НДФЛФСС)
	|				ИЛИ НЕ ОплатаПособийСоциальногоСтрахования.ДокументОснование ЕСТЬ NULL 
	|			ТОГДА НДФЛЗарплатаКВыплате.Сумма
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Сумма,
	|	ВЫБОР
	|		КОГДА &РазрешитьВыплатыДоОплаты
	|				ИЛИ НЕ НДФЛЗарплатаКВыплате.КодДохода В (&НДФЛФСС)
	|				ИЛИ НЕ ОплатаПособийСоциальногоСтрахования.ДокументОснование ЕСТЬ NULL 
	|			ТОГДА НДФЛЗарплатаКВыплате.Доход
	|		ИНАЧЕ 0
	|	КОНЕЦ КАК Доход
	|ИЗ
	|	ВТНДФЛЗарплатаКВыплате КАК НДФЛЗарплатаКВыплате
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ОплатаПособийСоциальногоСтрахования КАК ОплатаПособийСоциальногоСтрахования
	|		ПО НДФЛЗарплатаКВыплате.ДокументОснование = ОплатаПособийСоциальногоСтрахования.ДокументОснование
	|
	|УПОРЯДОЧИТЬ ПО
	|	НДФЛЗарплатаКВыплате.ФизическоеЛицо.Наименование,
	|	НДФЛЗарплатаКВыплате.ПериодВзаиморасчетов,
	|	НДФЛЗарплатаКВыплате.МесяцНалоговогоПериода,
	|	НДФЛЗарплатаКВыплате.КодДохода.Код";
	
	РезультатыРасчетов = Запрос.Выполнить().Выгрузить();
	
	Для Каждого СтрокаНДФЛ Из РезультатыРасчетов Цикл
		
		// Процент выплаты надо учесть в сумме доходов
		Если ЗначениеЗаполнено(Ссылка.ПроцентВыплаты) И Ссылка.ПроцентВыплаты <> 100 Тогда
			СтрокаНДФЛ.Доход = СтрокаНДФЛ.Доход * Ссылка.ПроцентВыплаты/100;
		КонецЕсли;
		
		//НДФЛ может не перечисляться
		Если ПараметрыПолученияЗарплатыКВыплате.ПорядокЗаполненияНалогов <> Перечисления.ПорядокЗаполненияНалогов.НДФЛ
			И  ПараметрыПолученияЗарплатыКВыплате.ПорядокЗаполненияНалогов <> Перечисления.ПорядокЗаполненияНалогов.НДФЛИВзносы Тогда
			СтрокаНДФЛ.Сумма = 0;	
		КонецЕсли;	
		
	КонецЦикла;

	

	//////Запрос.Текст =  
	//////"ВЫБРАТЬ
	//////|	&КонецМесяца КАК Период,
	//////|	СписокСотрудников.ФизическоеЛицо,
	//////|	СУММА(СписокСотрудников.СуммаВыплаты) КАК СуммаВыплаты
	//////|ПОМЕСТИТЬ ВТСуммыНДФЛПоСотрудникам
	//////|ИЗ
	//////|	ВТСписокСотрудников КАК СписокСотрудников
	//////|
	//////|СГРУППИРОВАТЬ ПО
	//////|	СписокСотрудников.ФизическоеЛицо
	//////|;
	//////|
	//////|////////////////////////////////////////////////////////////////////////////////
	//////|ВЫБРАТЬ
	//////|	МИНИМУМ(РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Период) КАК ДатаНачисления,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.МесяцНалоговогоПериода КАК Период,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.СтавкаНалогообложенияРезидента КАК СтавкаНалогообложенияРезидента,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.КодДохода КАК КодДохода,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.РегистрацияВНалоговомОргане КАК РегистрацияВНалоговомОргане,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Организация КАК Организация,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Подразделение КАК Подразделение,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ВключатьВДекларациюПоНалогуНаПрибыль,
	//////|	СУММА(ВЫБОР
	//////|			КОГДА РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	//////|				ТОГДА РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Сумма
	//////|			ИНАЧЕ -РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Сумма
	//////|		КОНЕЦ) КАК СуммаОстаток,
	//////|	МАКСИМУМ(СуммыНДФЛПоСотрудникам.СуммаВыплаты) КАК СуммаВыплаты,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование
	//////|ПОМЕСТИТЬ ВТПодробно
	//////|ИЗ
	//////|	ВТСуммыНДФЛПоСотрудникам КАК СуммыНДФЛПоСотрудникам
	//////|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыНалогоплательщиковСБюджетомПоНДФЛ КАК РасчетыНалогоплательщиковСБюджетомПоНДФЛ
	//////|		ПО СуммыНДФЛПоСотрудникам.ФизическоеЛицо = РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо
	//////|			И (РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ГоловнаяОрганизация = &ГоловнаяОрганизация)
	//////|			И (РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Регистратор <> &Регистратор)
	//////|			И (РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Организация = &Организация)
	//////|			И (РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Период <= &ДатаОперации)
	//////|
	//////|СГРУППИРОВАТЬ ПО
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.СтавкаНалогообложенияРезидента,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.КодДохода,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.РегистрацияВНалоговомОргане,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Организация,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Подразделение,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.МесяцНалоговогоПериода,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ВключатьВДекларациюПоНалогуНаПрибыль,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ДокументОснование,
	//////|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.МесяцНалоговогоПериода
	//////|
	//////|ИМЕЮЩИЕ
	//////|	СУММА(ВЫБОР
	//////|			КОГДА РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	//////|				ТОГДА РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Сумма
	//////|			ИНАЧЕ -РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Сумма
	//////|		КОНЕЦ) <> 0";
	//////Запрос.Выполнить();
	//////
	//////СоздатьВТСтавкаНДФЛПоСтавкеРезидента(Запрос.МенеджерВременныхТаблиц, "ВТПодробно");
	//////
	//////Если ЗначениеЗаполнено(ПериодРегистрации) Тогда
	//////	
	//////	Запрос.УстановитьПараметр("НачалоГода", НачалоГода(ПериодРегистрации));
	//////	Запрос.УстановитьПараметр("НачалоПериода", НачалоМесяца(ПериодРегистрации));
	//////	Запрос.УстановитьПараметр("КонецПериода", КонецМесяца(ПериодРегистрации));
	//////	Запрос.Текст =  
	//////	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	//////	|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо,
	//////	|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.СтавкаНалогообложенияРезидента,
	//////	|	ГОД(РасчетыНалогоплательщиковСБюджетомПоНДФЛ.МесяцНалоговогоПериода) КАК НалоговыйПериод
	//////	|ПОМЕСТИТЬ ВТПерерасчетыПрошлыхПериодов
	//////	|ИЗ
	//////	|	ВТСуммыНДФЛПоСотрудникам КАК СписокСотрудников
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.РасчетыНалогоплательщиковСБюджетомПоНДФЛ КАК РасчетыНалогоплательщиковСБюджетомПоНДФЛ
	//////	|		ПО СписокСотрудников.ФизическоеЛицо = РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо
	//////	|ГДЕ
	//////	|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	//////	|	И РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Период МЕЖДУ &НачалоПериода И &КонецПериода
	//////	|	И РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Регистратор <> &Регистратор
	//////	|	И РасчетыНалогоплательщиковСБюджетомПоНДФЛ.МесяцНалоговогоПериода < &НачалоГода
	//////	|	И РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ГоловнаяОрганизация = &ГоловнаяОрганизация
	//////	|	И РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Организация = &Организация
	//////	|
	//////	|СГРУППИРОВАТЬ ПО
	//////	|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.ФизическоеЛицо,
	//////	|	РасчетыНалогоплательщиковСБюджетомПоНДФЛ.СтавкаНалогообложенияРезидента,
	//////	|	ГОД(РасчетыНалогоплательщиковСБюджетомПоНДФЛ.МесяцНалоговогоПериода)
	//////	|
	//////	|ИМЕЮЩИЕ
	//////	|	СУММА(РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Сумма) < 0
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента,
	//////	|	НАЧАЛОПЕРИОДА(ПодробныеДанные.МесяцНалоговогоПериода, МЕСЯЦ) КАК МесяцНалоговогоПериода,
	//////	|	СУММА(ПодробныеДанные.СуммаОстаток) КАК СуммаОстаток
	//////	|ПОМЕСТИТЬ ВТПоФизическомуЛицуЗаМесяц
	//////	|ИЗ
	//////	|	ВТПодробно КАК ПодробныеДанные
	//////	|
	//////	|СГРУППИРОВАТЬ ПО
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента,
	//////	|	НАЧАЛОПЕРИОДА(ПодробныеДанные.МесяцНалоговогоПериода, МЕСЯЦ)
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента,
	//////	|	ГОД(ПодробныеДанные.МесяцНалоговогоПериода) КАК НалоговыйПериод,
	//////	|	СУММА(ПодробныеДанные.СуммаОстаток) КАК СуммаОстаток,
	//////	|	МАКСИМУМ(ПодробныеДанные.МесяцНалоговогоПериода) КАК МесяцНалоговогоПериода
	//////	|ПОМЕСТИТЬ ВТВсегоПоФизическомуЛицуЗаНалоговыйПериод
	//////	|ИЗ
	//////	|	ВТПоФизическомуЛицуЗаМесяц КАК ПодробныеДанные
	//////	|
	//////	|СГРУППИРОВАТЬ ПО
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента,
	//////	|	ГОД(ПодробныеДанные.МесяцНалоговогоПериода)
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента,
	//////	|	СУММА(ПодробныеДанные.СуммаОстаток) КАК СуммаОстаток,
	//////	|	СУММА(ВЫБОР
	//////	|			КОГДА ПерерасчетыПрошлыхПериодов.ФизическоеЛицо ЕСТЬ НЕ NULL 
	//////	|					И ПодробныеДанные.СуммаОстаток < 0
	//////	|				ТОГДА ПодробныеДанные.СуммаОстаток
	//////	|			ИНАЧЕ 0
	//////	|		КОНЕЦ) КАК ВозвратПрошлыхПериодов
	//////	|ПОМЕСТИТЬ ВТВсегоПоФизическомуЛицу
	//////	|ИЗ
	//////	|	ВТВсегоПоФизическомуЛицуЗаНалоговыйПериод КАК ПодробныеДанные
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПерерасчетыПрошлыхПериодов КАК ПерерасчетыПрошлыхПериодов
	//////	|		ПО ПодробныеДанные.ФизическоеЛицо = ПерерасчетыПрошлыхПериодов.ФизическоеЛицо
	//////	|			И ПодробныеДанные.СтавкаНалогообложенияРезидента = ПерерасчетыПрошлыхПериодов.СтавкаНалогообложенияРезидента
	//////	|			И ПодробныеДанные.НалоговыйПериод = ПерерасчетыПрошлыхПериодов.НалоговыйПериод
	//////	|ГДЕ
	//////	|	(ПодробныеДанные.СуммаОстаток > 0
	//////	|			ИЛИ ПерерасчетыПрошлыхПериодов.ФизическоеЛицо ЕСТЬ НЕ NULL )
	//////	|
	//////	|СГРУППИРОВАТЬ ПО
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|ВЫБРАТЬ
	//////	|	СуммыНДФЛПоСотрудникам.ФизическоеЛицо КАК ФизическоеЛицо,
	//////	|	СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента КАК СтавкаНалогообложенияРезидента,
	//////	|	ВсегоПоФизическомуЛицуЗаНалоговыйПериод.НалоговыйПериод КАК НалоговыйПериод,
	//////	|	ВсегоПоФизическомуЛицуЗаНалоговыйПериод.СуммаОстаток КАК ОстатокЗаНалоговыйПериод,
	//////	|	ВсегоПоФизическомуЛицуЗаНалоговыйПериод.МесяцНалоговогоПериода КАК ПоследнийМесяцНалоговогоПериода,
	//////	|	СуммыНДФЛПоСотрудникам.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
	//////	|	НАЧАЛОПЕРИОДА(СуммыНДФЛПоСотрудникам.МесяцНалоговогоПериода, МЕСЯЦ) КАК НачалоМесяцаНалоговогоПериода,
	//////	|	СуммыНДФЛПоСотрудникам.ДатаНачисления КАК Период,
	//////	|	СуммыНДФЛПоСотрудникам.РегистрацияВНалоговомОргане КАК РегистрацияВНалоговомОргане,
	//////	|	СуммыНДФЛПоСотрудникам.КодДохода КАК КодДохода,
	//////	|	СуммыНДФЛПоСотрудникам.ДокументОснование КАК ДокументОснование,
	//////	|	СуммыНДФЛПоСотрудникам.СуммаОстаток,
	//////	|	СуммыНДФЛПоСотрудникам.Организация КАК Организация,
	//////	|	СуммыНДФЛПоСотрудникам.Подразделение КАК Подразделение,
	//////	|	СуммыНДФЛПоСотрудникам.ВключатьВДекларациюПоНалогуНаПрибыль КАК ВключатьВДекларациюПоНалогуНаПрибыль,
	//////	|	СуммыНДФЛПоСотрудникам.СуммаВыплаты - ВсегоПоФизическомуЛицу.ВозвратПрошлыхПериодов КАК СуммаВыплаты,
	//////	|	СтавкаНДФЛПоСтавкеРезидента.СтавкаНДФЛ КАК Ставка,
	//////	|	ПоФизическомуЛицуЗаМесяц.СуммаОстаток КАК СуммаЗаМесяц,
	//////	|	СуммыНДФЛПоСотрудникам.СуммаВыплаты КАК СуммаВыплаченногоДохода
	//////	|ИЗ
	//////	|	ВТПодробно КАК СуммыНДФЛПоСотрудникам
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТВсегоПоФизическомуЛицуЗаНалоговыйПериод КАК ВсегоПоФизическомуЛицуЗаНалоговыйПериод
	//////	|			ЛЕВОЕ СОЕДИНЕНИЕ ВТПерерасчетыПрошлыхПериодов КАК ПерерасчетыПрошлыхПериодов
	//////	|			ПО ВсегоПоФизическомуЛицуЗаНалоговыйПериод.ФизическоеЛицо = ПерерасчетыПрошлыхПериодов.ФизическоеЛицо
	//////	|				И ВсегоПоФизическомуЛицуЗаНалоговыйПериод.СтавкаНалогообложенияРезидента = ПерерасчетыПрошлыхПериодов.СтавкаНалогообложенияРезидента
	//////	|				И ВсегоПоФизическомуЛицуЗаНалоговыйПериод.НалоговыйПериод = ПерерасчетыПрошлыхПериодов.НалоговыйПериод
	//////	|		ПО СуммыНДФЛПоСотрудникам.ФизическоеЛицо = ВсегоПоФизическомуЛицуЗаНалоговыйПериод.ФизическоеЛицо
	//////	|			И СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента = ВсегоПоФизическомуЛицуЗаНалоговыйПериод.СтавкаНалогообложенияРезидента
	//////	|			И (ГОД(СуммыНДФЛПоСотрудникам.МесяцНалоговогоПериода) = ВсегоПоФизическомуЛицуЗаНалоговыйПериод.НалоговыйПериод)
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТВсегоПоФизическомуЛицу КАК ВсегоПоФизическомуЛицу
	//////	|		ПО СуммыНДФЛПоСотрудникам.ФизическоеЛицо = ВсегоПоФизическомуЛицу.ФизическоеЛицо
	//////	|			И СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента = ВсегоПоФизическомуЛицу.СтавкаНалогообложенияРезидента
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПоФизическомуЛицуЗаМесяц КАК ПоФизическомуЛицуЗаМесяц
	//////	|		ПО СуммыНДФЛПоСотрудникам.ФизическоеЛицо = ПоФизическомуЛицуЗаМесяц.ФизическоеЛицо
	//////	|			И СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента = ПоФизическомуЛицуЗаМесяц.СтавкаНалогообложенияРезидента
	//////	|			И (НАЧАЛОПЕРИОДА(СуммыНДФЛПоСотрудникам.МесяцНалоговогоПериода, МЕСЯЦ) = ПоФизическомуЛицуЗаМесяц.МесяцНалоговогоПериода)
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтавкаНДФЛПоСтавкеРезидента КАК СтавкаНДФЛПоСтавкеРезидента
	//////	|		ПО СуммыНДФЛПоСотрудникам.ФизическоеЛицо = СтавкаНДФЛПоСтавкеРезидента.ФизическоеЛицо
	//////	|			И СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента = СтавкаНДФЛПоСтавкеРезидента.СтавкаНалогообложенияРезидента
	//////	|			И СуммыНДФЛПоСотрудникам.Период = СтавкаНДФЛПоСтавкеРезидента.Период
	//////	|			И СуммыНДФЛПоСотрудникам.КодДохода = СтавкаНДФЛПоСтавкеРезидента.КодДохода
	//////	|ГДЕ
	//////	|	ВсегоПоФизическомуЛицу.СуммаОстаток > 0
	//////	|	И (ВсегоПоФизическомуЛицуЗаНалоговыйПериод.СуммаОстаток > 0
	//////	|			ИЛИ ПерерасчетыПрошлыхПериодов.ФизическоеЛицо ЕСТЬ НЕ NULL )
	//////	|
	//////	|УПОРЯДОЧИТЬ ПО
	//////	|	ФизическоеЛицо,
	//////	|	СтавкаНалогообложенияРезидента,
	//////	|	НалоговыйПериод,
	//////	|	НачалоМесяцаНалоговогоПериода,
	//////	|	МесяцНалоговогоПериода,
	//////	|	Период,
	//////	|	ДокументОснование,
	//////	|	РегистрацияВНалоговомОргане,
	//////	|	Подразделение,
	//////	|	ВключатьВДекларациюПоНалогуНаПрибыль,
	//////	|	Ставка
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТПодробно
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТСтавкаНДФЛПоСтавкеРезидента
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТСуммыНДФЛПоСотрудникам
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТПоФизическомуЛицуЗаМесяц
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТВсегоПоФизическомуЛицу
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТПерерасчетыПрошлыхПериодов
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТВсегоПоФизическомуЛицуЗаНалоговыйПериод";
	//////	
	//////	Выборка = Запрос.ВыполнитьПакет()[4].Выбрать();
	//////	
	//////Иначе
	//////	
	//////	Запрос.Текст =  
	//////	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента,
	//////	|	СУММА(ПодробныеДанные.СуммаОстаток) КАК СуммаОстаток,
	//////	|	ГОД(ПодробныеДанные.МесяцНалоговогоПериода) КАК НалоговыйПериод
	//////	|ПОМЕСТИТЬ ВТВсегоПоФизическомуЛицу
	//////	|ИЗ
	//////	|	ВТПодробно КАК ПодробныеДанные
	//////	|
	//////	|СГРУППИРОВАТЬ ПО
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента,
	//////	|	ГОД(ПодробныеДанные.МесяцНалоговогоПериода)
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента,
	//////	|	НАЧАЛОПЕРИОДА(ПодробныеДанные.МесяцНалоговогоПериода, МЕСЯЦ) КАК МесяцНалоговогоПериода,
	//////	|	СУММА(ПодробныеДанные.СуммаОстаток) КАК СуммаОстаток
	//////	|ПОМЕСТИТЬ ВТПоФизическомуЛицуЗаМесяц
	//////	|ИЗ
	//////	|	ВТПодробно КАК ПодробныеДанные
	//////	|
	//////	|СГРУППИРОВАТЬ ПО
	//////	|	ПодробныеДанные.ФизическоеЛицо,
	//////	|	ПодробныеДанные.СтавкаНалогообложенияРезидента,
	//////	|	НАЧАЛОПЕРИОДА(ПодробныеДанные.МесяцНалоговогоПериода, МЕСЯЦ)
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|ВЫБРАТЬ
	//////	|	СуммыНДФЛПоСотрудникам.ФизическоеЛицо КАК ФизическоеЛицо,
	//////	|	СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента КАК СтавкаНалогообложенияРезидента,
	//////	|	ВсегоПоФизическомуЛицу.НалоговыйПериод КАК НалоговыйПериод,
	//////	|	ВсегоПоФизическомуЛицу.СуммаОстаток КАК ОстатокЗаНалоговыйПериод,
	//////	|	НАЧАЛОПЕРИОДА(СуммыНДФЛПоСотрудникам.МесяцНалоговогоПериода, МЕСЯЦ) КАК НачалоМесяцаНалоговогоПериода,
	//////	|	СуммыНДФЛПоСотрудникам.МесяцНалоговогоПериода КАК МесяцНалоговогоПериода,
	//////	|	СуммыНДФЛПоСотрудникам.ДатаНачисления КАК Период,
	//////	|	СуммыНДФЛПоСотрудникам.РегистрацияВНалоговомОргане КАК РегистрацияВНалоговомОргане,
	//////	|	СуммыНДФЛПоСотрудникам.КодДохода КАК КодДохода,
	//////	|	СуммыНДФЛПоСотрудникам.ДокументОснование КАК ДокументОснование,
	//////	|	СуммыНДФЛПоСотрудникам.СуммаОстаток,
	//////	|	СуммыНДФЛПоСотрудникам.Организация КАК Организация,
	//////	|	СуммыНДФЛПоСотрудникам.Подразделение КАК Подразделение,
	//////	|	СуммыНДФЛПоСотрудникам.ВключатьВДекларациюПоНалогуНаПрибыль КАК ВключатьВДекларациюПоНалогуНаПрибыль,
	//////	|	СуммыНДФЛПоСотрудникам.СуммаВыплаты,
	//////	|	СтавкаНДФЛПоСтавкеРезидента.СтавкаНДФЛ КАК Ставка,
	//////	|	ПоФизическомуЛицуЗаМесяц.СуммаОстаток КАК СуммаЗаМесяц,
	//////	|	СуммыНДФЛПоСотрудникам.СуммаВыплаты КАК СуммаВыплаченногоДохода
	//////	|ИЗ
	//////	|	ВТПодробно КАК СуммыНДФЛПоСотрудникам
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТВсегоПоФизическомуЛицу КАК ВсегоПоФизическомуЛицу
	//////	|		ПО СуммыНДФЛПоСотрудникам.ФизическоеЛицо = ВсегоПоФизическомуЛицу.ФизическоеЛицо
	//////	|			И СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента = ВсегоПоФизическомуЛицу.СтавкаНалогообложенияРезидента
	//////	|			И (ГОД(СуммыНДФЛПоСотрудникам.МесяцНалоговогоПериода) = ВсегоПоФизическомуЛицу.НалоговыйПериод)
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПоФизическомуЛицуЗаМесяц КАК ПоФизическомуЛицуЗаМесяц
	//////	|		ПО СуммыНДФЛПоСотрудникам.ФизическоеЛицо = ПоФизическомуЛицуЗаМесяц.ФизическоеЛицо
	//////	|			И СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента = ПоФизическомуЛицуЗаМесяц.СтавкаНалогообложенияРезидента
	//////	|			И (НАЧАЛОПЕРИОДА(СуммыНДФЛПоСотрудникам.МесяцНалоговогоПериода, МЕСЯЦ) = ПоФизическомуЛицуЗаМесяц.МесяцНалоговогоПериода)
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТСтавкаНДФЛПоСтавкеРезидента КАК СтавкаНДФЛПоСтавкеРезидента
	//////	|		ПО СуммыНДФЛПоСотрудникам.ФизическоеЛицо = СтавкаНДФЛПоСтавкеРезидента.ФизическоеЛицо
	//////	|			И СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента = СтавкаНДФЛПоСтавкеРезидента.СтавкаНалогообложенияРезидента
	//////	|			И СуммыНДФЛПоСотрудникам.Период = СтавкаНДФЛПоСтавкеРезидента.Период
	//////	|			И СуммыНДФЛПоСотрудникам.КодДохода = СтавкаНДФЛПоСтавкеРезидента.КодДохода
	//////	|ГДЕ
	//////	|	ВсегоПоФизическомуЛицу.СуммаОстаток > 0
	//////	|
	//////	|УПОРЯДОЧИТЬ ПО
	//////	|	ФизическоеЛицо,
	//////	|	СтавкаНалогообложенияРезидента,
	//////	|	НалоговыйПериод,
	//////	|	НачалоМесяцаНалоговогоПериода,
	//////	|	МесяцНалоговогоПериода,
	//////	|	Период,
	//////	|	ДокументОснование,
	//////	|	РегистрацияВНалоговомОргане,
	//////	|	Подразделение,
	//////	|	ВключатьВДекларациюПоНалогуНаПрибыль,
	//////	|	Ставка
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТСтавкаНДФЛПоСтавкеРезидента
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТСуммыНДФЛПоСотрудникам
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТПоФизическомуЛицуЗаМесяц
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТВсегоПоФизическомуЛицу
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТПодробно";
	//////	
	//////	Выборка = Запрос.ВыполнитьПакет()[2].Выбрать();
	//////	
	//////КонецЕсли;
	//////
	//////ВременнаяТаблица = РезультатыРасчетов.СкопироватьКолонки();
	//////НеУчитыватьРазмерыВыплат = ДатаОперации >= ДатаИзмененияСроковУплатыНалога(); 
	//////Пока Выборка.СледующийПоЗначениюПоля("ФизическоеЛицо") Цикл 
	//////	
	//////	ВременнаяТаблица.Очистить();
	//////	СуммаКРаспределению = Выборка.СуммаВыплаты;
	//////	Пока Выборка.СледующийПоЗначениюПоля("СтавкаНалогообложенияРезидента") И (НеУчитыватьРазмерыВыплат Или СуммаКРаспределению >= 0) Цикл 
	//////		Пока Выборка.СледующийПоЗначениюПоля("НалоговыйПериод") И (НеУчитыватьРазмерыВыплат Или СуммаКРаспределению >= 0) Цикл 
	//////			Если Выборка.ОстатокЗаНалоговыйПериод >= 0 Тогда
	//////				ОстатокКУдержанию = 0;
	//////				Пока Выборка.СледующийПоЗначениюПоля("НачалоМесяцаНалоговогоПериода") И (НеУчитыватьРазмерыВыплат Или СуммаКРаспределению > 0) Цикл 
	//////					ОстатокКУдержанию = ОстатокКУдержанию + Выборка.СуммаЗаМесяц;
	//////					Если ОстатокКУдержанию > 0 И Выборка.СуммаЗаМесяц > 0 Тогда
	//////						Пока Выборка.Следующий() И (НеУчитыватьРазмерыВыплат Или СуммаКРаспределению > 0) И ОстатокКУдержанию > 0 Цикл
	//////							Если Выборка.СуммаОстаток > 0 Тогда
	//////								
	//////								СписываемаяСумма = ?(НеУчитыватьРазмерыВыплат, Мин(Выборка.СуммаОстаток, ОстатокКУдержанию), Мин(Выборка.СуммаОстаток, СуммаКРаспределению, ОстатокКУдержанию));;
	//////								СуммаКРаспределению = СуммаКРаспределению - СписываемаяСумма;
	//////								ОстатокКУдержанию = ОстатокКУдержанию - СписываемаяСумма;
	//////								
	//////								СтрокаТаблицыРезультатов = ВременнаяТаблица.Добавить();
	//////								ЗаполнитьЗначенияСвойств(СтрокаТаблицыРезультатов, Выборка);
	//////								СтрокаТаблицыРезультатов.Сумма = СписываемаяСумма;			
	//////								
	//////							КонецЕсли;
	//////						КонецЦикла;			
	//////					КонецЕсли;
	//////				КонецЦикла;			
	//////			Иначе
	//////				СуммаКРаспределению = СуммаКРаспределению - Выборка.ОстатокЗаНалоговыйПериод;
	//////				СтрокаТаблицыРезультатов = ВременнаяТаблица.Добавить();
	//////				ЗаполнитьЗначенияСвойств(СтрокаТаблицыРезультатов, Выборка);
	//////				СтрокаТаблицыРезультатов.Сумма = Выборка.ОстатокЗаНалоговыйПериод;			
	//////				СтрокаТаблицыРезультатов.МесяцНалоговогоПериода = Выборка.ПоследнийМесяцНалоговогоПериода;			
	//////			КонецЕсли;
	//////		КонецЦикла;	
	//////	КонецЦикла;	
	//////	
	//////	КоэффициентыРаспределения = ВременнаяТаблица.ВыгрузитьКолонку("Сумма");
	//////	РаспределениеРесурса = ОбщегоНазначения.РаспределитьСуммуПропорциональноКоэффициентам(Выборка.СуммаВыплаченногоДохода, КоэффициентыРаспределения);
	//////	Если РаспределениеРесурса <> Неопределено Тогда
	//////		ВременнаяТаблица.ЗагрузитьКолонку(РаспределениеРесурса, "СуммаВыплаченногоДохода");
	//////	КонецЕсли;
	//////	Для каждого СтрокаТЗ Из ВременнаяТаблица Цикл
	//////		СтрокаТЗ.СуммаВыплаченногоДохода = СтрокаТЗ.СуммаВыплаченногоДохода + СтрокаТЗ.Сумма
	//////	КонецЦикла;
	//////	
	//////	ОбщегоНазначенияКлиентСервер.ДополнитьТаблицу(ВременнаяТаблица,РезультатыРасчетов);
	//////	
	//////КонецЦикла;	
	//////
	//////Если ОтбиратьПоДокументуОснованию Тогда
	//////	
	//////	Запрос.УстановитьПараметр("РезультатыРасчетов", РезультатыРасчетов);
	//////	Запрос.Текст =  
	//////	"ВЫБРАТЬ
	//////	|	СуммыНДФЛПоСотрудникам.ФизическоеЛицо,
	//////	|	СуммыНДФЛПоСотрудникам.СтавкаНалогообложенияРезидента,
	//////	|	СуммыНДФЛПоСотрудникам.МесяцНалоговогоПериода,
	//////	|	СуммыНДФЛПоСотрудникам.Период,
	//////	|	СуммыНДФЛПоСотрудникам.РегистрацияВНалоговомОргане,
	//////	|	СуммыНДФЛПоСотрудникам.КодДохода,
	//////	|	СуммыНДФЛПоСотрудникам.ДокументОснование,
	//////	|	СуммыНДФЛПоСотрудникам.Подразделение,
	//////	|	СуммыНДФЛПоСотрудникам.ВключатьВДекларациюПоНалогуНаПрибыль,
	//////	|	СуммыНДФЛПоСотрудникам.Ставка,
	//////	|	СуммыНДФЛПоСотрудникам.Сумма
	//////	|ПОМЕСТИТЬ ВТРезультатыРасчетов
	//////	|ИЗ
	//////	|	&РезультатыРасчетов КАК СуммыНДФЛПоСотрудникам
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	//////	|	СписокСотрудников.ФизическоеЛицо,
	//////	|	СписокСотрудников.ДокументОснование
	//////	|ПОМЕСТИТЬ ВТПодробно
	//////	|ИЗ
	//////	|	ВТСписокСотрудников КАК СписокСотрудников
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|ВЫБРАТЬ
	//////	|	РезультатыРасчетов.ФизическоеЛицо,
	//////	|	РезультатыРасчетов.СтавкаНалогообложенияРезидента,
	//////	|	РезультатыРасчетов.МесяцНалоговогоПериода,
	//////	|	РезультатыРасчетов.Период,
	//////	|	РезультатыРасчетов.РегистрацияВНалоговомОргане,
	//////	|	РезультатыРасчетов.КодДохода,
	//////	|	РезультатыРасчетов.ДокументОснование,
	//////	|	РезультатыРасчетов.Подразделение,
	//////	|	РезультатыРасчетов.ВключатьВДекларациюПоНалогуНаПрибыль,
	//////	|	РезультатыРасчетов.Ставка,
	//////	|	РезультатыРасчетов.Сумма
	//////	|ИЗ
	//////	|	ВТПодробно КАК Физлица
	//////	|		ЛЕВОЕ СОЕДИНЕНИЕ ВТРезультатыРасчетов КАК РезультатыРасчетов
	//////	|		ПО Физлица.ФизическоеЛицо = РезультатыРасчетов.ФизическоеЛицо
	//////	|			И Физлица.ДокументОснование = РезультатыРасчетов.ДокументОснование
	//////	|ГДЕ
	//////	|	РезультатыРасчетов.ФизическоеЛицо ЕСТЬ НЕ NULL ";
	//////	
	//////	РезультатыРасчетов = Запрос.Выполнить().Выгрузить();
	//////	
	//////	Запрос.Текст =  
	//////	"УНИЧТОЖИТЬ ВТРезультатыРасчетов
	//////	|;
	//////	|
	//////	|////////////////////////////////////////////////////////////////////////////////
	//////	|УНИЧТОЖИТЬ ВТПодробно";
	//////	
	//////	Запрос.Выполнить();
	//////	
	//////КонецЕсли;
	
	Возврат РезультатыРасчетов;
	
КонецФункции

// Предназначена для расчета и регистрации НДФЛ удержанного 
// по записанным в учете данным и по переданным данным о выплатах.
//
// Параметры:
//      Ссылка  - ДокументСсылка - ссылка на документ-регистратор.
//		Движения - коллекция движений регистратора.
//		Отказ - признак отказа от заполнения движений.
//		Организация
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение.
//      МенеджерТаблиц - МенеджерВременныхТаблиц, должен содержать временную таблицу с данными о выплатах вида:
//      	ВТСписокСотрудников 
//				ФизическоеЛицо: должно быть непустым
//          	СуммаВыплаты.
//		Записывать - признак того, надо ли записывать движения сразу, или они будут записаны позже.
//
//  Формирует движения по регистрам подсистемы.
//
Процедура РассчитатьИЗарегистрироватьУдержанныеНалоги(Ссылка, Движения, Отказ, Организация, ДатаОперации, МенеджерТаблиц, Записывать = Ложь, ПериодРегистрации = Неопределено) Экспорт
	
	УдержанныйНалог = РассчитатьУдержанныеНалоги(Ссылка, Организация, ДатаОперации, МенеджерТаблиц, ПериодРегистрации);
	
	СформироватьУдержанныйНалогПоТаблицеЗначений(Движения, Отказ, Организация, ДатаОперации, УдержанныйНалог, , Истина);
	
	
КонецПроцедуры	

// Процедура регистрирует факт неудачи при попытке выплаты зарплаты документом.
// При этом ранее удержанные при выплате налоги "сторнируются".
//
// Параметры:
//		Движения 		- КоллекцияДвижений, коллекция наборов записей движений ведомости.
//		Отказ			- признак отказа выполнения операции.
//		Документ		- ссылка на документ, которым ранее была зарегистрирована выплата зарплаты.
//		ФизическиеЛица	- массив ссылок на физические лица.
//
// Обработка ошибочных ситуаций
//	выдается сообщение, признак «Отказ» выставляется в Истина.
//
Процедура ЗарегистрироватьНевыплатуДокументом(Движения, Отказ, Документ, ФизическиеЛица) Экспорт
	
	// Расчеты налогоплательщиков с бюджетом.
	РасчетыНалогоплательщиков = РегистрыНакопления.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.СоздатьНаборЗаписей();
	РасчетыНалогоплательщиков.Отбор.Регистратор.Установить(Документ);
	РасчетыНалогоплательщиков.Прочитать();
	
	РасчетыНалогоплательщиковСторно	= РасчетыНалогоплательщиков.ВыгрузитьКолонки();
	Для Каждого ЗаписьВедомости Из РасчетыНалогоплательщиков Цикл
		Если ФизическиеЛица.Найти(ЗаписьВедомости.ФизическоеЛицо) <> Неопределено Тогда
			СтрокаСторно = РасчетыНалогоплательщиковСторно.Добавить() ;
			ЗаполнитьЗначенияСвойств(СтрокаСторно, ЗаписьВедомости);
			СтрокаСторно.Сумма = - ЗаписьВедомости.Сумма;
		КонецЕсли	
	КонецЦикла;
	
	Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Загрузить(РасчетыНалогоплательщиковСторно);
	Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Записывать= Истина;
	
	
КонецПроцедуры

// Уточняет значение поля РегистрацияВНалоговомОргане в строке регистра.
// Параметры:
//		СтрокаДанных - срока набора записей учетного регистра, содержит поле РегистрацияВНалоговомОргане.
//      РегистрацияПодразделенияВНалоговомОргане - регистрация в НО, указанная в подразделении (возможно пустая).
//      РегистрацияОрганизацииВНалоговомОргане - регистрация в НО, указанная в организации.
//
Процедура ПроставитьРегистрациюВНалоговомОрганеВСтроке(СтрокаДанных, РегистрацияПодразделенияВНалоговомОргане, РегистрацияОрганизацииВНалоговомОргане) Экспорт
	СтрокаДанных.РегистрацияВНалоговомОргане = ?(ЗначениеЗаполнено(РегистрацияПодразделенияВНалоговомОргане), РегистрацияПодразделенияВНалоговомОргане, РегистрацияОрганизацииВНалоговомОргане);
КонецПроцедуры	

// Формирует строку движения по регистру СведенияОДоходахНДФЛ.
//
// Параметры:
//		СведенияОДоходахНДФЛ - набор записей регистра накопления СведенияОДоходахНДФЛ.
//		Организация
//		ДатаОперации - дата - дата, которой будет зарегистрировано движение.
//		ДанныеДокумента - некоторая структура (строка таблицы значений, выборки из результата запроса и т.п.) 
//				с полями, соответствующими полям регистра (в структуре могут отсутствовать необязательные поля):
//					ФизическоеЛицо, с непустым значением
//					ДатаПолученияДохода, с непустым значением
//					МесяцНалоговогоПериода, с непустым значением
//					КодДохода, с непустым значением
//					КодВычета
//					СтавкаНалогообложения
//					ИсточникДоходаЗаПределамиРФ
//					РегистрацияВНалоговомОргане
//					СуммаДохода
//					СуммаВычета.
//					Начисление
//					Подразделение
//					Сотрудник
//		ОкончательныйРасчет - булево - признак того, надо ли помечать движения как предназначенные для межрасчетного
//		                               исчисления налога.
//
Функция СтрокаСведенийОДоходах(СведенияОДоходахНДФЛ, Организация, МесяцНачисления, ДанныеДокумента, ОкончательныйРасчет = Истина) Экспорт
	
	НоваяСтрока = СведенияОДоходахНДФЛ.Добавить();
	ЗаполнитьЗначенияСвойств(НоваяСтрока, ДанныеДокумента);
	НоваяСтрока.ГоловнаяОрганизация = ЗарплатаКадрыПовтИсп.ГоловнаяОрганизация(Организация);
	НоваяСтрока.Организация = Организация;
	НоваяСтрока.Период = МесяцНачисления;
	Если НЕ ЗначениеЗаполнено(НоваяСтрока.НалоговыйПериод) Тогда
		НоваяСтрока.НалоговыйПериод = УчетНДФЛПовтИсп.ОпределитьНалоговыйПериод(НачалоМесяца(МесяцНачисления),ДанныеДокумента.ПериодДействия,ДанныеДокумента.КодДохода,ДанныеДокумента.КатегорияНачисления);
	КонецЕсли;	
	НоваяСтрока.ДоходМежрасчетногоПериода = Не ОкончательныйРасчет;

    СтрокаСведенийОДоходахВС(СведенияОДоходахНДФЛ, Организация, МесяцНачисления, ДанныеДокумента, ОкончательныйРасчет);

	Возврат НоваяСтрока
	
КонецФункции


// Добавляет в МенеджерВременныхТаблиц временную таблицу с данными НДФЛ по документу.
//
Процедура СоздатьВТДанныеНДФЛПоДокументу(МенеджерВременныхТаблиц, ДокументСсылка, ОписаниеТаблицДокумента = Неопределено, ФизическиеЛица = Неопределено) Экспорт
	

	Если ФизическиеЛица = Неопределено Тогда
		ОтборПоФизическимЛицам = Ложь;
	Иначе
		ОтборПоФизическимЛицам = Истина;
	КонецЕсли;
	
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	ТаблицаНДФЛ.Ссылка,
	|	ТаблицаНДФЛ.ИдентификаторСтрокиНДФЛ КАК ИдентификаторСтроки,
	|	ТаблицаНДФЛ.НомерСтроки,
	|	ТаблицаНДФЛ.ФизическоеЛицо КАК ФизическоеЛицо,
	|	ТаблицаНДФЛ.КодДохода КАК КодДохода,
	|   ВЫБОР
	|   	КОГДА НЕ (ВидыДоходов.Ссылка ЕСТЬ NULL)
	|   	ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыОсобыхНачисленийИУдержаний.ВоенныйСбор)
	|   	ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыОсобыхНачисленийИУдержаний.НДФЛ)
	|   КОНЕЦ КАК ВидУдержания,
	|   ВЫБОР
	|   	КОГДА НЕ (ВидыДоходов.Ссылка ЕСТЬ NULL)
	|   	ТОГДА ЗНАЧЕНИЕ(Справочник.ГруппыУчетаНачисленийИУдержаний.ВоенныйСбор)
	|   	ИНАЧЕ ЗНАЧЕНИЕ(Справочник.ГруппыУчетаНачисленийИУдержаний.НДФЛ)
	|   КОНЕЦ КАК ГруппаУчетаУдержаний,
	|	ТаблицаНДФЛ.НалоговыйПериод КАК НалоговыйПериод,
	|	ТаблицаНДФЛ.Подразделение КАК Подразделение,
	|	ТаблицаНДФЛ.Налог КАК Налог,
	|	ТаблицаНДФЛ.Доход КАК Доход,
	|	ТаблицаНДФЛ.ВидСтавки КАК ВидСтавки,
	|	ТаблицаНДФЛ.УвеличеннаяСтавка КАК УвеличеннаяСтавка,
	|	ТаблицаНДФЛ.Льгота КАК Льгота,
	|	ТаблицаНДФЛ.КоличествоЛьгот КАК КоличествоЛьгот,
	|	ТаблицаНДФЛ.СуммаЛьготы КАК СуммаЛьготы,
	|	ТаблицаНДФЛ.ДоходПолный КАК ДоходПолный
	|ПОМЕСТИТЬ ВТДанныеНДФЛ
	|ИЗ
	|	#ТаблицаНДФЛ КАК ТаблицаНДФЛ
	|   ЛЕВОЕ СОЕДИНЕНИЕ
	|   Справочник.ВидыДоходовНДФЛ КАК ВидыДоходов
	|   ПО ВидыДоходов.Ссылка = ТаблицаНДФЛ.КодДохода
	|    И ВидыДоходов.ВидСтавкиРезидента = ЗНАЧЕНИЕ(Перечисление.ВидыСтавокНДФЛ.ВоенныйСбор)
	|ГДЕ
	|	ТаблицаНДФЛ.Ссылка = &Ссылка
	|	И ТаблицаНДФЛ.ФизическоеЛицо В(&ФизическиеЛица)
	|";
	
	Если ОписаниеТаблицДокумента = Неопределено Тогда
		ПолноеИмяДокумента = ДокументСсылка.Метаданные().ПолноеИмя();
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "#ТаблицаНДФЛ", ПолноеИмяДокумента + ".НДФЛ");
	Иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "#ТаблицаНДФЛ", ОписаниеТаблицДокумента.ИмяТаблицыСНалогами);
	КонецЕсли;
	
	// Создаем временную таблицу ВТДанныеНДФЛ.
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Ссылка", ДокументСсылка);
	Если ОтборПоФизическимЛицам Тогда
		Запрос.УстановитьПараметр("ФизическиеЛица", ФизическиеЛица);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст, "И ТаблицаНДФЛ.ФизическоеЛицо В(&ФизическиеЛица)", "");
	КонецЕсли; 
	
	Запрос.Выполнить();
	
КонецПроцедуры

// Возвращает таблицу значений с данными по НДФЛ, прочитанную из данных документа.
//      	 
// Параметры:
//      ДокументСсылка - ДокументСсылка - документ, содержащий сведения о суммах налогов и вычетов.
//      ОписаниеТаблицДокумента - структура - (необязательный), с полями
//      			ИмяТаблицыСНалогами
//      			ИмяТаблицыСВычетами
//      	если не указан, в качестве источника данных используются табличные
//      		части документа: НДФЛ и ПримененныеВычетыНаДетейИИмущественные
//      	если указан, тогда упомянутые таблицы (реальные или временные) должны  
//				иметь тот же состав полей, что имеют табличные части документа 
//				НачислениеЗарплаты НДФЛ и ПримененныеВычетыНаДетейИИмущественные.
//		МенеджерВременныхТаблиц - (необязательный), должен содержать перечисленные 
//      	в ОписаниеТаблицДокумента временные таблицы.
//      	 
// Возвращаемое значение:
//	таблица значений с колонками:
//		Ссылка,
//		НомерСтроки,
//		ФизическоеЛицо,
//		МесяцНалоговогоПериода,
//		Подразделение,
//		НалогПоСтавке13,
//		ЗачтеноАвансовыхПлатежейПоСтавке13,
//		НалогПоСтавке13КЗачетуВозврату,
//		ПримененныйВычетЛичныйКодВычета,
//		ПримененныйВычетЛичный,
//		ПримененныйВычетЛичныйКЗачетуВозвратуКодВычета,
//		ПримененныйВычетЛичныйКЗачетуВозврату,
//		ПримененныйВычетИмущественныйРасходы,
//		ПримененныйВычетИмущественныйПроцентыПоКредитам,
//		ПримененныйВычетИмущественныйПроцентыПриПерекредитовании,
//		ПримененныйВычетНаДетей,
//		ПримененныйВычетНаДетейДвойной,
//		ПримененныйВычетНаДетейДвойнойВторой,
//		ПримененныйВычетНаВторогоРебенка,
//		ПримененныйВычетНаВторогоРебенкаДвойной,
//		ПримененныйВычетНаВторогоРебенкаДвойнойВторой,
//		ПримененныйВычетНаТретьегоРебенка,
//		ПримененныйВычетНаТретьегоРебенкаДвойной,
//		ПримененныйВычетНаТретьегоРебенкаДвойнойВторой,
//		ПримененныйВычетНаДетейИнвалидов,
//		ПримененныйВычетНаДетейИнвалидовДвойной,
//		ПримененныйВычетНаДетейИнвалидовДвойнойВторой
//		ПримененныйВычетНаДетейИнвалидовОпекунов,ПримененныйВычетНаДетейИнвалидовДвойнойОпекунов,ПримененныйВычетНаДетейИнвалидовДвойнойВторойОпекунов
//		ПримененныйВычетРасходыНаСвоеОбучение,ПримененныйВычетРасходыНаОбучениеДетей,ПримененныйВычетРасходыНаЛечение,ПримененныйВычетСтраховыеВзносыНаМедУслуги,ПримененныйВычетРасходыНаДорогостоящееЛечение
//      	 
Функция ДанныеДокументаОНалогеПоОсновнойСтавкеИВычетах(ДокументСсылка, ОписаниеТаблицДокумента = Неопределено, МенеджерВременныхТаблиц = Неопределено, ФизическиеЛица = Неопределено) Экспорт

	Если МенеджерВременныхТаблиц = Неопределено Тогда
		МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	КонецЕсли;
	
	СоздатьВТДанныеНДФЛПоДокументу(МенеджерВременныхТаблиц, ДокументСсылка, ОписаниеТаблицДокумента, ФизическиеЛица);
	
	// Получаем данные НДФЛ
	ТекстЗапроса = 
	"ВЫБРАТЬ
	|	*
	|ИЗ
	|	ВТДанныеНДФЛ КАК НДФЛ";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц;
	
    Возврат Запрос.Выполнить().Выгрузить()
	
КонецФункции

Функция ДатаОперацииПоДокументу(ДатаДокумента, ПериодРегистрации) Экспорт

	Возврат Мин(Макс(ДатаДокумента, НачалоМесяца(ПериодРегистрации)),КонецМесяца(ПериодРегистрации))

КонецФункции

// Функция возвращает код вычета для дохода НДФЛ.
// Если код вычета не определен, то возвращается пустая ссылка.
Функция КодВычетаПоКодуДоходаНДФЛ(КодДоходаНДФЛ) Экспорт
КонецФункции 

// Возвращает соответствие кодов доходов и допустимых для них вычетов.
// Соответствие поддерживается с 2010 года.
//
// Параметры:
//	НалоговыйПериод - число - налоговый период (год).
//
// Возвращаемое значение:
//	Соответствие:
//		ключом является Код дохода - СправочникСсылка.ВидыДоходовНДФЛ
//		значением является массив Кодов вычета - СправочникСсылка.ВидыВычетовНДФЛ
//
Функция ВычетыКДоходам(НалоговыйПериод) Экспорт
	
	СоответствиеДоступныхВычетовДоходам = Новый Соответствие;
	
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1010, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код601));
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1211, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код607));
	////
	////// Описание кодов 1530 и 1531 по годам.
	////Если НалоговыйПериод > 2014 Тогда // с 2015 года
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код201);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код218);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код222);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код618);
	////	
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1530, МассивДоступныхВычетов);
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код202);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код217);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код218);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код219);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код223);
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1531, МассивДоступныхВычетов);
	////	
	////ИначеЕсли НалоговыйПериод = 2014 Тогда // 2014 год
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код201);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код204);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код205);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код208);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код212);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код216);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код218);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код222);
	////	
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1530, МассивДоступныхВычетов);
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код202);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код217);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код218);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код219);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код223);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код620);
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1531, МассивДоступныхВычетов);
	////	
	////ИначеЕсли НалоговыйПериод > 2011 Тогда // 2012-2013 годы
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код201);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код204);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код205);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код208);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код212);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код216);
	////	
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1530, МассивДоступныхВычетов);
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код202);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код217);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код620);
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1531, МассивДоступныхВычетов);
	////	
	////ИначеЕсли НалоговыйПериод = 2011 Тогда // 2011 год
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код201);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код204);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код205);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код208);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код209);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код211);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код212);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код215);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код216);
	////	
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1530, МассивДоступныхВычетов);
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код202);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код203);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код216);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код217);
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1531, МассивДоступныхВычетов);
	////	
	////Иначе // по 2010 год
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код201);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код204);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код205);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код208);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код209);
	////	
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1530, МассивДоступныхВычетов);
	////	
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код202);
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код203);
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1531, МассивДоступныхВычетов);
	////	
	////КонецЕсли;
	////
	////// Описание кода 1532 по годам.
	////МассивДоступныхВычетов = Новый Массив;
	////МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код205);	
	////МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код206);
	////Если НалоговыйПериод = 2010 Или НалоговыйПериод = 2011 Тогда 
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код207);
	////КонецЕсли;
	////МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код209);
	////Если НалоговыйПериод = 2011 Тогда 
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код210);
	////КонецЕсли;
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1532, МассивДоступныхВычетов);
	////
	////// Описание кода 1533 по годам.
	////МассивДоступныхВычетов = Новый Массив;
	////Если НалоговыйПериод = 2010 Или НалоговыйПериод = 2011 Тогда 
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код202);	
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код203);	
	////КонецЕсли;
	////Если НалоговыйПериод >= 2014 Тогда // с 2014 года
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код220);
	////КонецЕсли;
	////Если НалоговыйПериод >= 2011 И НалоговыйПериод <= 2014 Тогда // с 2011 по 2014 годы
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код620);
	////КонецЕсли;
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1533, МассивДоступныхВычетов);
	////
	////// Описание кода 1535 по годам.
	////МассивДоступныхВычетов = Новый Массив;
	////МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код207);
	////Если НалоговыйПериод >= 2014 Тогда // с 2014 года
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код209);
	////КонецЕсли;
	////Если НалоговыйПериод >= 2011 И НалоговыйПериод <= 2014 Тогда // с 2011 по 2014 годы
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код210);
	////КонецЕсли;
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1535, МассивДоступныхВычетов);
	////	
	////// Описание кода 1536 по годам.
	////МассивДоступныхВычетов = Новый Массив;
	////МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код203);	
	////Если НалоговыйПериод >= 2014 Тогда // с 2014 года
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код224);
	////КонецЕсли;
	////Если НалоговыйПериод > 2011 И НалоговыйПериод <= 2014 Тогда // с 2012 по 2014 годы
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код620);
	////КонецЕсли;
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1536, МассивДоступныхВычетов);
	////	
	////// Описание кода 1537 по годам.
	////Если НалоговыйПериод >= 2011 Тогда // с 2011 года
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код211);	
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1537, МассивДоступныхВычетов);
	////КонецЕсли;
	////
	////// Описание кода 1538 по годам.
	////Если НалоговыйПериод >= 2011 Тогда // с 2011 года
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код215);
	////	Если НалоговыйПериод = 2011 Тогда // 2011 год
	////		МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код214);
	////		МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код216);
	////		МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код217);
	////	КонецЕсли;
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1538, МассивДоступныхВычетов);
	////КонецЕсли;
	////
	////// Описание кода 1539 по годам.
	////Если НалоговыйПериод >= 2011 Тогда // с 2011 года
	////	МассивДоступныхВычетов = Новый Массив;
	////	Если НалоговыйПериод = 2011 Тогда // 2011 год
	////		МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код212);
	////	КонецЕсли;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код213);
	////	Если НалоговыйПериод <= 2014 Тогда
	////		МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код214);
	////	КонецЕсли;
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1539, МассивДоступныхВычетов);
	////КонецЕсли;
	////
	////// Описание кода 1541 по годам.
	////Если НалоговыйПериод >= 2011 Тогда // с 2011 года
	////	МассивДоступныхВычетов = Новый Массив;
	////	Если НалоговыйПериод <= 2014 Тогда // по 2014 год
	////		МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код212);
	////		МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код213);
	////	КонецЕсли;
	////	Если НалоговыйПериод >= 2014 Тогда // с 2014 года
	////		МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код620);
	////	КонецЕсли;
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1541, МассивДоступныхВычетов);
	////КонецЕсли;
	////
	////Если НалоговыйПериод > 2014 Тогда // с 2015 года
	////	МассивДоступныхВычетов = Новый Массив;
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код221);	
	////	МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код617);	
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1543, МассивДоступныхВычетов);
	////ИначеЕсли НалоговыйПериод = 2014 Тогда 	
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код1543, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код221));
	////КонецЕсли;
	////
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2010, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код403));

	////МассивДоступныхВычетов = Новый Массив;
	////МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код404);
	////МассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код405);	
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2201, МассивДоступныхВычетов);
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2202, МассивДоступныхВычетов);
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2203, МассивДоступныхВычетов);
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2204, МассивДоступныхВычетов);
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2205, МассивДоступныхВычетов);
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2206, МассивДоступныхВычетов);
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2207, МассивДоступныхВычетов);
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2208, МассивДоступныхВычетов);
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2209, МассивДоступныхВычетов);
	////
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2720, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код501));
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2730, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код502));
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2740, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код505));
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2760, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код503));
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2761, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код506));
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2762, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код508));
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2770, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код504));
	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2790, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код507));
	////
	////// описание кода 2791
	////Если НалоговыйПериод < 2016 Тогда // по 2015 год
	////	СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код2791, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код509));
	////КонецЕсли;

	////СоответствиеДоступныхВычетовДоходам.Вставить(Справочники.ВидыДоходовНДФЛ.Код4800, ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(Справочники.ВидыВычетовНДФЛ.Код620));
		
	Возврат СоответствиеДоступныхВычетовДоходам;
	
КонецФункции

// Возвращает массив кодов льгот соответствующего года с учетом ограничения переданной группой вычетов.
// Поддерживается с 2010 года.
//
// Параметры:
//	НалоговыйПериод - число - налоговый период (год).
//	ГруппаВычета - ПеречислениеСсылка.ГруппыВычетовПоНДФЛ, массив - 
//
// Возвращаемое значение:
//	Массив значений типа СправочникСсылка.ВидыЛьготПоНДФЛ
//
Функция ВычетыНалогоплательщика(НалоговыйПериод, Знач ГруппаВычета = Неопределено) Экспорт
	
	
	//мМассивДоступныхВычетов.Добавить(Справочники.ВидыВычетовНДФЛ.Код104);
	
	
	
	
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ГруппыВычетов", ГруппаВычета);
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВидыЛьготПоНДФЛ.Ссылка
	|ИЗ
	|	Справочник.ВидыЛьготПоНДФЛ КАК ВидыЛьготПоНДФЛ
	|";
	
	Возврат Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("Ссылка");
	
КонецФункции


#КонецОбласти


#Область СлужебныеПроцедурыИФункции

// Составляет структуру для заполнения таблиц НДФЛ, ПримененныеВычетыНаДетейИИмущественные в форме документов.
// 
// Параметры:
//	МенеджерВременныхТаблиц - в котором определена таблица ВТФизическиеЛица
//		(подробнее см. комментарий к методу РассчитатьНалогПоОсновнойСтавке)
//  ДокументСсылка.
//	Организация
//	МесяцРасчета
//	ОкончательныйРасчет - булево - признак того, надо ли при расчете учитывать все зарегистрированные доходы
//	                               (соответствует значению Истина).
//	ДатаУдержанияИсчисленногоНалога - дата - дата предполагаемого удержания налога, который был исчислен по Регистратору.
//
// Возвращаемое значение - структура для заполнения таблиц НДФЛ и ПримененныеВычетыНаДетейИИмущественные.
//
Функция РезультатРасчетаНДФЛ(МенеджерВременныхТаблиц, ДокументСсылка, Организация, МесяцНачисления, ОкончательныйРасчет = Истина, ДатаУдержанияИсчисленногоНалога = Неопределено) Экспорт
	
	НДФЛ = РассчитатьНалогПоОсновнойСтавке(ДокументСсылка, Организация, МесяцНачисления, МенеджерВременныхТаблиц,,,,ОкончательныйРасчет, ДатаУдержанияИсчисленногоНалога);
	НДФЛ.Колонки.Добавить("ИдентификаторСтрокиНДФЛ", Новый ОписаниеТипов("Число"));
	
	Возврат НДФЛ//ДанныеОРезультатахРасчетаНДФЛДляДокумента(НДФЛ)
	
КонецФункции

Функция ДанныеОРезультатахРасчетаНДФЛДляДокумента(НДФЛ) Экспорт


КонецФункции
// Специфические алгоритмы чтения данных

// Менеджер временных таблиц содержит таблицу ВТНачисления с полями.
//	Регистратор,
//	НомерСтроки,
//	ФизическоеЛицо
//	КодДохода
//	Сумма
//	КодВычета
//	КоличествоДетей
//	
// Формирует таблицу ВТВычетыКДоходамФизическихЛиц с полями.
//	Регистратор,
//	НомерСтроки,
//	ФизическоеЛицо
//	КодДохода
//	КодВычета
//	СуммаВычета
//
Процедура СоздатьВТВычетыКДоходамФизическихЛиц(Ссылка, Организация, ДатаПолученияДохода, МенеджерВременныхТаблиц) Экспорт

КонецПроцедуры

// Функция рассчитывает размер вычета, который можно применить к доходу.
// 
Функция ВычетКДоходуСотрудника(Ссылка, Организация, ДатаПолученияДохода, Сотрудник, КодДохода, КодВычетаНДФЛ, СуммаДохода, КоличествоДетей = 0) Экспорт 
	
	СуммаВычета = 0;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Сотрудники.ФизическоеЛицо КАК ФизическоеЛицо,
	|	&КодДохода КАК КодДохода,
	|	&Сумма КАК Сумма,
	|	&КодВычета КАК КодВычета,
	|	&КоличествоДетей КАК КоличествоДетей,
	|	&Ссылка КАК Регистратор,
	|	0 КАК НомерСтроки
	|ПОМЕСТИТЬ ВТНачисления
	|ИЗ
	|	Справочник.Сотрудники КАК Сотрудники
	|ГДЕ
	|	Сотрудники.Ссылка = &Сотрудник";
	Запрос.УстановитьПараметр("Сотрудник",			Сотрудник);
	Запрос.УстановитьПараметр("Ссылка",				Ссылка);
	Запрос.УстановитьПараметр("КодДохода",			КодДохода);
	Запрос.УстановитьПараметр("Сумма",				СуммаДохода);
	Запрос.УстановитьПараметр("КодВычета",			КодВычетаНДФЛ);
	Запрос.УстановитьПараметр("КоличествоДетей",	КоличествоДетей);
	Запрос.Выполнить();
	
	СоздатьВТВычетыКДоходамФизическихЛиц(Ссылка, Организация, ДатаПолученияДохода, Запрос.МенеджерВременныхТаблиц);
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ВычетыКДоходамФизическихЛиц.СуммаВычета
	|ИЗ
	|	ВТВычетыКДоходамФизическихЛиц КАК ВычетыКДоходамФизическихЛиц";
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда 
		СуммаВычета = Выборка.СуммаВычета;
	КонецЕсли;
	
	Возврат СуммаВычета
	
КонецФункции


// Возвращает таблицу значений с данными о физических лицах, по которым требуется пересмотреть данные по НДФЛ
// (возможно, пустую).
//
// Параметры:
//	Организация - организация, по которой получаем данные.
//	МесяцПерерасчета - дата - месяц, в котором производится перерасчет.
//	НачалоПериода - дата - описывает пересчитываемый налоговый период.
//	ОкончаниеПериода - дата - описывает пересчитываемый налоговый период 
//	ФизическиеЛица: тип СправочникСсылка.ФизическиеЛица или массив значений типа СправочникСсылка.ФизическиеЛица 
//    необязательный, если не задан - возвращаются все физлица, по которым есть переплата.
//  ДокументСсылка - регистратор, движения которого исключаются из рассмотрения.
//
// Возвращаемое значение:
//	таблица значений с колонками:
//			ФизическоеЛицо: тип СправочникСсылка.ФизическиеЛица
//			МесяцНалоговогоПериода: тип дата.
//			Подразделение
//			КодВычетаЛичный
//			колонки рассчитанных ресурсов: ПримененныйВычетЛичный, ПримененныйВычетНаДетей, ПримененныйВычетНаДетейДвойной,
//				ПримененныйВычетНаДетейДвойнойВторой,  ПримененныйВычетНаТретьегоРебенка,
//				ПримененныйВычетНаТретьегоРебенкаДвойной, ПримененныйВычетНаТретьегоРебенкаДвойнойВторой,
//				ПримененныйВычетНаВторогоРебенка, ПримененныйВычетНаВторогоРебенкаДвойной,
//				ПримененныйВычетНаВторогоРебенкаДвойнойВторой, ПримененныйВычетНаДетейИнвалидов,
//				ПримененныйВычетНаДетейИнвалидовДвойной, ПримененныйВычетНаДетейИнвалидовДвойнойВторой, НалогПоСтавке13,
//				ПримененныйВычетНаДетейИнвалидовОпекунов,ПримененныйВычетНаДетейИнвалидовДвойнойОпекунов,ПримененныйВычетНаДетейИнвалидовДвойнойВторойОпекунов
//				ПримененныйВычетРасходыНаСвоеОбучение,ПримененныйВычетРасходыНаОбучениеДетей,ПримененныйВычетРасходыНаЛечение,ПримененныйВычетСтраховыеВзносыНаМедУслуги,ПримененныйВычетРасходыНаДорогостоящееЛечение
//				НалогПоСтавке09, НалогПоСтавке35, НалогПоСтавке13КЗачетуВозврату, НалогПоСтавке35КЗачетуВозврату,
//				ПримененныйВычетИмущественныйРасходы, ПримененныйВычетИмущественныйПроцентыПоКредитам,
//				ПримененныйВычетИмущественныйПроцентыПриПерекредитовании 
//	если данных для перерасчета нет - возвращается пустая таблица значений.
//			
Функция ДанныеОПерерасчетеНДФЛ(Организация, МесяцПерерасчета, НачалоПериода, ОкончаниеПериода, ФизическиеЛица = Неопределено, ДокументСсылка = Неопределено) Экспорт

	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ГоловнаяОрганизация", ЗарплатаКадрыПовтИсп.ГоловнаяОрганизация(Организация));
	Запрос.УстановитьПараметр("ДатаАктуальности", КонецМесяца(МесяцПерерасчета));
	Запрос.УстановитьПараметр("НачалоГодаПериодаРасчета", НачалоГода(НачалоПериода));
	Запрос.УстановитьПараметр("КонецМесяцаРасчета", КонецМесяца(ОкончаниеПериода));
	
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
    ТекстЗапроса =
	"ВЫБРАТЬ
	|	Обороты.ФизическоеЛицо КАК ФизическоеЛицо
	|ПОМЕСТИТЬ ВТДоходы
	|ИЗ
	|	РегистрНакопления.СведенияОДоходахНДФЛ КАК Обороты
	|ГДЕ
	|	Обороты.Период <= &ДатаАктуальности
	|	И Обороты.ГоловнаяОрганизация = &ГоловнаяОрганизация
	|	И Обороты.НалоговыйПериод МЕЖДУ &НачалоГодаПериодаРасчета И &КонецМесяцаРасчета
	|	И &УсловиеДляФизлиц
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Обороты.ФизическоеЛицо КАК ФизическоеЛицо
	|ПОМЕСТИТЬ ВТФизическиеЛица
	|ИЗ
	|	ВТДоходы КАК Обороты
	|";
	
	Если ЗначениеЗаполнено(ФизическиеЛица) Тогда
		Запрос.УстановитьПараметр("ФизическиеЛица", ФизическиеЛица);
		Запрос.Текст = СтрЗаменить(ТекстЗапроса, "&УсловиеДляФизлиц", "ФизическоеЛицо В(&ФизическиеЛица)");
	Иначе
		Запрос.Текст = СтрЗаменить(ТекстЗапроса, "&УсловиеДляФизлиц", "Истина");
	КонецЕсли;
	Запрос.Выполнить();
	
	УстановитьПривилегированныйРежим(Истина);
	
	РезультатРасчетаНДФЛ = РассчитатьНалогПоОсновнойСтавке(ДокументСсылка, Организация, МесяцПерерасчета, Запрос.МенеджерВременныхТаблиц, НачалоПериода, ОкончаниеПериода);
	
	УстановитьПривилегированныйРежим(Ложь);
	
	//Для перерасчета не нужны "пустые" строки
	НулевыеСтроки = РезультатРасчетаНДФЛ.НайтиСтроки(Новый Структура("Налог, Доход",0,0));
	Для каждого СтрокаТаблицы Из НулевыеСтроки Цикл
		РезультатРасчетаНДФЛ.Удалить(СтрокаТаблицы)
	КонецЦикла;
	
	
	Возврат РезультатРасчетаНДФЛ
	
КонецФункции 


// Вспомогательные функции и процедуры

Функция СтрокаРасчетовНалогоплательщикаСБюджетом(Движения, Организация, ДатаОперации, ВидДвижения, ДанныеДокумента, ВидСтроки = Неопределено, ОкончательныйРасчет = Истина)
	
	НоваяСтрока = Движения.РасчетыНалогоплательщиковСБюджетомПоНДФЛ.Добавить();
	ЗаполнитьЗначенияСвойств(НоваяСтрока, ДанныеДокумента);
	НоваяСтрока.ВидДвижения = ВидДвижения;
	НоваяСтрока.ГоловнаяОрганизация = ЗарплатаКадрыПовтИсп.ГоловнаяОрганизация(Организация);
	НоваяСтрока.Организация = Организация;
	НоваяСтрока.Период = ДатаОперации;
	Если НЕ ЗначениеЗаполнено(НоваяСтрока.ПериодВзаиморасчетов) Тогда
		НоваяСтрока.ПериодВзаиморасчетов = НачалоМесяца(ДатаОперации);
	КонецЕсли;	
	НоваяСтрока.РасчетМежрасчетногоПериода = Не ОкончательныйРасчет;
	
    Возврат НоваяСтрока
	
КонецФункции


#Область ФункцииПервоначальногоЗаполненияИОбновленияИБ

// Перезаполняет наборы записей регистраторов исправленными данными и записывает их.
//
// Параметры: 
//  ИмяРегистра - строка - 
//  ТекстЗапроса - строка - текст исполняемого запроса, в котором обязательно присутствует 
//			поле Регистратор, остальные поля должны соответствовать 
//          полям записи заполняемого регистра, в результате должны 
//          присутствовать все заполняемые поля;
//			кроме того, результат запроса должен быть упорядочен, 
//			первое поле упорядочивания - Регистратор
//  ПараметрыЗапроса - Структура - необязательный, содержит имена и значения параметров,
//          которые требуются запросу
//
// Возвращаемое значение:
//  Нет
//
Процедура ОбработатьНаборыЗаписейРегистраНакопления(ИмяРегистра, ТекстЗапроса, ПараметрыЗапроса = Неопределено, МенеджерВременныхТаблиц = Неопределено) Экспорт
	
	Запрос = Новый Запрос;
	Если МенеджерВременныхТаблиц <> Неопределено Тогда
		Запрос.МенеджерВременныхТаблиц = МенеджерВременныхТаблиц
	КонецЕсли;
	Запрос.Текст = ТекстЗапроса;
	Если ЗначениеЗаполнено(ПараметрыЗапроса) Тогда
		Для каждого КлючИЗначение Из ПараметрыЗапроса Цикл
			Запрос.УстановитьПараметр(КлючИЗначение.Ключ, КлючИЗначение.Значение)
		КонецЦикла;
	КонецЕсли;
	Результат = Запрос.Выполнить();
	Если Не Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Пока Выборка.СледующийПоЗначениюПоля("Регистратор") Цикл
			НаборЗаписей = РегистрыНакопления[ИмяРегистра].СоздатьНаборЗаписей();
			НаборЗаписей.Отбор.Регистратор.Установить(Выборка.Регистратор);
			НаборЗаписей.ОбменДанными.Загрузка = Истина;
			Пока Выборка.Следующий() Цикл
				ЗаполнитьЗначенияСвойств(НаборЗаписей.Добавить(), Выборка);
			КонецЦикла;
			НаборЗаписей.Записать();
		КонецЦикла;
	КонецЕсли;

КонецПроцедуры


// Добавляет в список Обработчики процедуры-обработчики обновления,
// необходимые данной подсистеме.
//
// Параметры:
//   Обработчики - ТаблицаЗначений - см. описание функции НоваяТаблицаОбработчиковОбновления
//                                   общего модуля ОбновлениеИнформационнойБазы.
// 
Процедура ЗарегистрироватьОбработчикиОбновления(Обработчики) Экспорт
	

	Обработчик = Обработчики.Добавить();
	Обработчик.Версия = "3.0.0.4";
	Обработчик.Процедура = "УчетНДФЛ.ЗаполнитьВидыДоходовНДФЛ";
	
	Обработчик = Обработчики.Добавить();
	Обработчик.Версия = "3.0.0.7";
	Обработчик.Процедура = "УчетНДФЛ.ЗаполнитьВидыДоходовНДФЛ";

КонецПроцедуры	

Процедура ЗаполнитьВидыДоходовНДФЛ() Экспорт
	
	Обработки.НачальноеЗаполнениеИОбновлениеОбъектов.ЗаполнитьОбъект("Справочник", "ВидыДоходовНДФЛ");
	
КонецПроцедуры	



#КонецОбласти


#Область КадровыеДанныеФизическихЛиц

// Возвращает подготовленный запрос, формирующий временную таблицу с указанным именем.
// Временная таблица содержит поля Период, ФизическоеЛицо, СтатусНалогоплательщика.
//
// Параметры:
//		ТолькоРазрешенные
//		ОписательВременнойТаблицыОтборов - Структура, см. КадровыйУчет.ОписаниеВременнойТаблицыОтборовФизическихЛиц.
//		ПоляОтбораПериодическихДанных - Соответствие
//		ИмяВТСведенияОСтатусахНалогоплательщиков - Строка, имя временной таблицы, созданной в результате выполнения запроса.
//
// ВозвращаемоеЗначение:
//		Запрос
//
Функция ЗапросВТСведенияОСтатусахНалогоплательщиков(ТолькоРазрешенные, ОписательВременнойТаблицыОтборов, ПоляОтбораПериодическихДанных, ИмяВТСведенияОСтатусахНалогоплательщиков = "ВТСведенияОСтатусахНалогоплательщиков") Экспорт
	
	ИмяВТПредварительныеСведенияОСтатусахНалогоплательщиков = ЗарплатаКадрыОбщиеНаборыДанных.УникальноеИмяТекстаЗапроса("ВТПредварительныеСведенияОСтатусахНалогоплательщиков");
	
	ОписаниеФильтра = ЗарплатаКадрыОбщиеНаборыДанных.ОписаниеФильтраДляСоздатьВТИмяРегистра(
		ОписательВременнойТаблицыОтборов.ИмяВременнойТаблицыОтборовФизическихЛиц,
		"Период,ФизическоеЛицо");
	
	ОписаниеФильтра.СоответствиеИзмеренийРегистраИзмерениямФильтра.Вставить("Период", ОписательВременнойТаблицыОтборов.ИмяПоляПериод);
	ОписаниеФильтра.СоответствиеИзмеренийРегистраИзмерениямФильтра.Вставить("ФизическоеЛицо", ОписательВременнойТаблицыОтборов.ИмяПоляФизическоеЛицо);
	
	ПараметрыПостроения = ЗарплатаКадрыОбщиеНаборыДанных.ПараметрыПостроенияДляСоздатьВТИмяРегистраСрез();
	
	ПоляОтбора = Неопределено;
	Если ПоляОтбораПериодическихДанных <> Неопределено Тогда
		ПоляОтбораПериодическихДанных.Свойство("СтатусФизическихЛицКакНалогоплательщиковНДФЛ", ПоляОтбора);
	КонецЕсли;
	 
	ПараметрыПостроения.Отборы = ПоляОтбора;
	ПараметрыПостроения.ИспользоватьРасширениеЯзыкаЗапросовДляСКД = Ложь;
	
	ЗапросВТИмяРегистраСрез = ЗарплатаКадрыОбщиеНаборыДанных.ЗапросВТИмяРегистраСрез(
		"СтатусФизическихЛицКакНалогоплательщиковНДФЛ",
		ТолькоРазрешенные,
		ОписаниеФильтра,
		ПараметрыПостроения,
		Истина,
		ИмяВТПредварительныеСведенияОСтатусахНалогоплательщиков);
	 
	ТекстЗапросаДанных =
		"ВЫБРАТЬ РАЗРЕШЕННЫЕ РАЗЛИЧНЫЕ
		|	ТаблицаОтборовФизическихЛиц.Период КАК Период,
		|	ПредварительныеСведенияОСтатусахНалогоплательщиков.ПериодЗаписи КАК ПериодЗаписи,
		|	ТаблицаОтборовФизическихЛиц.ФизическоеЛицо КАК ФизическоеЛицо,
		|	ВЫБОР
		|		КОГДА ТаблицаОтборовФизическихЛиц.Период < ДАТАВРЕМЯ(2014, 1, 1, 0, 0, 0)
		|				И ПредварительныеСведенияОСтатусахНалогоплательщиков.Статус = ЗНАЧЕНИЕ(Справочник.СтатусыНалогоплательщиковПоНДФЛ.Беженцы)
		|			ТОГДА ЗНАЧЕНИЕ(Справочник.СтатусыНалогоплательщиковПоНДФЛ.Нерезидент)
		|		ИНАЧЕ ЕСТЬNULL(ПредварительныеСведенияОСтатусахНалогоплательщиков.Статус, ЗНАЧЕНИЕ(Справочник.СтатусыНалогоплательщиковПоНДФЛ.Резидент))
		|	КОНЕЦ КАК СтатусНалогоплательщика
		|ПОМЕСТИТЬ ВТСведенияОСтатусахНалогоплательщиков
		|ИЗ
		|	ВТОтборовФизическихЛиц КАК ТаблицаОтборовФизическихЛиц
		|		ЛЕВОЕ СОЕДИНЕНИЕ ВТПредварительныеСведенияОСтатусахНалогоплательщиков КАК ПредварительныеСведенияОСтатусахНалогоплательщиков
		|		ПО ТаблицаОтборовФизическихЛиц.Период = ПредварительныеСведенияОСтатусахНалогоплательщиков.Период
		|			И ТаблицаОтборовФизическихЛиц.ФизическоеЛицо = ПредварительныеСведенияОСтатусахНалогоплательщиков.ФизическоеЛицо";
		
	ТекстЗапросаДанных = СтрЗаменить(ТекстЗапросаДанных, "ВТОтборовФизическихЛиц", ОписательВременнойТаблицыОтборов.ИмяВременнойТаблицыОтборовФизическихЛиц);
	ТекстЗапросаДанных = СтрЗаменить(ТекстЗапросаДанных, "ТаблицаОтборовФизическихЛиц.Период", "ТаблицаОтборовФизическихЛиц." + ОписательВременнойТаблицыОтборов.ИмяПоляПериод);
	ТекстЗапросаДанных = СтрЗаменить(ТекстЗапросаДанных, "ТаблицаОтборовФизическихЛиц.ФизическоеЛицо", "ТаблицаОтборовФизическихЛиц." + ОписательВременнойТаблицыОтборов.ИмяПоляФизическоеЛицо);
	ТекстЗапросаДанных = СтрЗаменить(ТекстЗапросаДанных, "ВТПредварительныеСведенияОСтатусахНалогоплательщиков", ИмяВТПредварительныеСведенияОСтатусахНалогоплательщиков);
	
	ЗарплатаКадрыОбщиеНаборыДанных.ЗаменитьИмяСоздаваемойВременнойТаблицы(ТекстЗапросаДанных, "ВТСведенияОСтатусахНалогоплательщиков", ИмяВТСведенияОСтатусахНалогоплательщиков);
	ЗарплатаКадрыОбщиеНаборыДанных.УстановитьВыборкуТолькоРазрешенныхДанных(ТекстЗапросаДанных, ТолькоРазрешенные);
	
	ЗапросВТИмяРегистраСрез.Текст = 
		ЗапросВТИмяРегистраСрез.Текст
		+ ЗарплатаКадрыОбщиеНаборыДанных.РазделительЗапросов()
		+ ТекстЗапросаДанных;
	
	Возврат ЗапросВТИмяРегистраСрез;
	
КонецФункции

#КонецОбласти

#КонецОбласти

#Область Свойства

// См. УправлениеСвойствамиПереопределяемый.ПриПолученииПредопределенныхНаборовСвойств.
Процедура ПриПолученииПредопределенныхНаборовСвойств(Наборы) Экспорт
	
	УправлениеСвойствамиБЗК.ЗарегистрироватьНаборСвойств(Наборы, "d42dbf53-9802-11e9-80cd-4cedfb43b11a", Метаданные.Документы.ОперацияНалоговогоУчетаПоНДФЛ);
	
КонецПроцедуры

#КонецОбласти
